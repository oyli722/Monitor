# 功能文档

## 一、项目概述

**核心定位**：一个采用客户端-服务端架构的运维监控系统，提供主机监控、数据可视化、Web SSH终端功能。

**核心价值**：

- **集中监控**：统一纳管多台服务器的基础硬件信息与实时运行指标
- **便捷运维**：通过Web界面实现SSH快捷登录与终端操作，无需本地客户端
- **实时数据**：每15秒上报一次运行时指标，及时发现主机异常

**目标用户**：系统管理员、运维工程师、开发人员等需要对服务器集群进行监控和操作的技术人员。

---

## 二、系统架构总览

**架构风格**：客户端-服务端架构，包含三个核心组件。

1. **客户端（Agent）**：部署于被监控主机，负责数据采集与上报
2. **服务端（Server Core）**：系统中枢，负责数据处理、连接代理与API提供
3. **前端（Web Console）**：提供统一的可视化操作界面

**架构图**：

```
┌─────────────────────────────────────────────────────┐
│              Monitor-Web (Vue 3 前端)                │
│           仪表盘 | 主机监控 | SSH终端                 │
└──────────────────────┬──────────────────────────────┘
                       │ HTTP/WebSocket
                       ▼
┌─────────────────────────────────────────────────────┐
│            Monitor-Server (Spring Boot)              │
│  Agent管理 | 指标存储 | SSH代理 | 认证授权             │
│    MySQL  |  Redis  |  RabbitMQ  |  WebSocket       │
└──────────────────────┬──────────────────────────────┘
                       │ HTTP 注册/上报
                       ▼
┌─────────────────────────────────────────────────────┐
│         Monitor-Agent (部署在被监控主机)              │
│     自动注册 | 数据采集 | 定时上报 | 配置更新          │
└─────────────────────────────────────────────────────┘
```

---

## 三、核心模块与功能详述

### 模块一：客户端代理（Monitor-Agent）

**模块职责**：安装在目标主机上的轻量级代理，负责本机信息采集与通信。

**功能列表**：

#### 1.1 自动注册

- **启动检测**：Agent启动时检查本地配置文件 `agent-config.yaml`
- **注册判断**：
  - 如存在 `agent.id` 和 `agent.name` → 跳至上报逻辑
  - 如不存在或为空 → 进入注册流程

- **服务端选择**：
  - 按配置顺序尝试连接 `servers` 列表中的地址
  - 对每个地址发送 HTTP GET 到 `/api/health` 检查连通性
  - 记录响应最快的可用服务端地址
  - 如所有地址均不可用，等待重试（指数退避）

- **注册请求**：
  ```
  POST /api/v1/customer/register
  {
    "hostname": "实际主机名",
    "ip": "客户端IP地址",
    "basicInfo": {
      "cpuModel": "CPU型号",
      "cpuCores": 核心数,
      "memoryGb": 内存大小,
      "gpuInfo": [...],
      "networkInterfaces": [...]
    }
  }
  ```

- **注册响应**：
  ```
  {
    "success": true,
    "agentId": "AGT_20240115_ABCD1234",
    "agentName": "生产服务器-01",
    "authToken": "JWT_TOKEN_HERE"
  }
  ```

- **本地保存**：注册成功后，将 `agentId`、`agentName`、`authToken` 保存到本地配置文件

#### 1.2 双频数据上报

**基本数据上报**：
- **频率**：每10分钟（600秒）
- **内容**：主机硬件信息（不变或极少变化）
  - 主机名、IP地址
  - CPU型号、核心数
  - 内存总容量
  - GPU信息
  - 网络接口列表
- **特点**：数据量小，变化慢

**运行时数据上报**：
- **频率**：每15秒
- **内容**：CPU、内存、磁盘、网络等实时指标
  - CPU使用率
  - 内存使用率
  - 磁盘使用率（各分区）
  - 网络上行/下行速度
  - SSH服务状态
- **特点**：数据规律性强，频繁更新

#### 1.3 系统信息采集

使用 **OSHI** 库进行跨平台硬件信息采集：

**采集内容**：
- **CPU信息**：型号、核心数、使用率
- **内存信息**：总容量、使用率
- **磁盘信息**：各分区总容量、使用率
- **网络信息**：接口列表、上行/下行速度
- **GPU信息**：显卡型号、显存大小
- **SSH状态**：SSH服务是否运行、端口是否监听

#### 1.4 配置更新接收

- **接口**：`POST /api/v1/agent/config`
- **功能**：接收服务端下发的配置更新
- **当前状态**：接口存在，功能基础

---

### 模块二：服务端核心（Monitor-Server）

**模块职责**：接收、存储数据，管理客户端，并提供所有核心功能的API支撑。

**功能列表**：

#### 2.1 Agent管理

- **注册处理**：
  - 接收Agent注册请求
  - 生成唯一 `agentId` 和 `agentName`
  - 生成JWT认证Token
  - 保存Agent基本信息到数据库

- **数据接收**：
  - 接收基本数据上报 (`POST /api/v1/agent/basic`)
  - 接收运行时指标上报 (`POST /api/v1/agent/metrics`)
  - 验证Token有效性
  - 存储到MySQL数据库

- **在线状态管理**：
  - 根据数据上报时间判断Agent在线状态
  - 超过一定时间未上报则标记为离线

#### 2.2 数据存储

**当前实现**：
- **MySQL**：存储所有数据
  - `agent` 表：Agent基本信息
  - `agent_metrics` 表：运行时指标（时序数据）
  - `user` 表：用户账号
  - `ssh_credential` 表：SSH凭证

**未实现**：
- **InfluxDB**：依赖已引入但代码中完全未使用

#### 2.3 监控数据查询

- **Agent列表**：
  ```
  GET /api/monitor/getMonitorList
  ```
  - 返回所有已注册Agent
  - 包含基本信息和在线状态

- **最新指标**：
  ```
  GET /api/monitor/{agentId}/metrics/latest
  ```
  - 获取指定Agent的最新运行时指标
  - 返回CPU、内存、磁盘、网络数据

- **历史指标**：
  ```
  GET /api/monitor/{agentId}/metrics/history
  参数：type(指标类型), range(时间范围), aggregate(聚合方式)
  ```
  - 支持CPU、内存、磁盘、网络四种指标类型
  - 支持15m、1h、6h、24h、7d时间范围
  - 支持avg、max、min聚合方式
  - 数据按时间桶聚合处理

#### 2.4 SSH代理与隧道

- **连接建立**：
  ```
  POST /api/v1/ssh/connect
  {
    "agentId": "目标Agent ID",
    "username": "SSH用户名",
    "password": "SSH密码",
    "port": 22
  }
  ```
  - 使用 **JSch** 库建立SSH连接
  - 生成唯一的 `sessionId`
  - 创建 `SshSession` 对象并保存到 `SshSessionManager`

- **凭证管理**：
  ```
  GET /api/v1/ssh/credential/{agentId}
  POST /api/v1/ssh/credential  # 保存凭证
  ```
  - 支持首次连接后保存凭证
  - 下次连接自动使用保存的凭证
  - **注意**：密码当前明文存储（TODO: 加密）

- **WebSocket终端**：
  ```
  WS /api/v1/ssh/terminal/{sessionId}
  ```
  - 前端建立WebSocket连接
  - `SshWebSocketHandler` 双向转发数据：WebSocket ↔ SSH
  - 支持多个独立的SSH会话

- **连接断开**：
  ```
  POST /api/v1/ssh/disconnect
  ```
  - 关闭SSH连接
  - 清理会话资源

#### 2.5 用户认证与授权

**认证方式**：JWT (JSON Web Token)

- **用户登录**：
  ```
  POST /api/auth/login
  {
    "username": "用户名",
    "password": "密码"
  }
  ```
  - 验证用户名密码
  - 生成访问Token（有效期24小时）
  - 生成刷新Token（有效期7天）
  - 返回用户信息

- **用户注册**：
  ```
  POST /api/auth/register
  {
    "username": "用户名",
    "email": "邮箱",
    "password": "密码",
    "verificationCode": "邮箱验证码"
  }
  ```
  - 需要先请求邮箱验证码
  - 验证码通过RabbitMQ异步发送
  - 验证码有效期5分钟

- **Token刷新**：
  ```
  POST /api/auth/refresh
  {
    "refreshToken": "刷新Token"
  }
  ```
  - 使用刷新Token获取新的访问Token

- **密码重置**：
  ```
  POST /api/auth/reset-password
  {
    "email": "邮箱",
    "newPassword": "新密码",
    "resetToken": "重置Token（来自邮件）"
  }
  ```

- **JWT认证过滤器**：
  - 拦截受保护的API请求
  - 从请求头提取 `Authorization: Bearer {token}`
  - 验证Token有效性
  - 设置Spring Security认证信息

#### 2.6 邮件服务

- **配置**：支持SMTP邮件发送
- **队列**：使用RabbitMQ异步发送邮件
- **用途**：
  - 注册验证码
  - 密码重置链接

#### 2.7 健康检查

```
GET /api/health
```
- 返回服务状态和当前时间
- 用于Agent选择最快服务器

---

### 模块三：前端可视化与控制台（Monitor-Web）

**模块职责**：提供用户交互界面，集成数据展示与运维操作。

**技术栈**：Vue 3 + TypeScript + Vite + Element Plus + ECharts + xterm.js

**功能列表**：

#### 3.1 用户认证界面

**登录页面** (`/src/views/auth/Login.vue`)：
- 用户名/邮箱输入
- 密码输入（带显示/隐藏切换）
- "记住我"选项
- 登录提交按钮
- 跳转注册/忘记密码入口
- 表单验证、错误提示、加载状态

**注册页面** (`/src/views/auth/Register.vue`)：
- 用户名输入（唯一性校验）
- 邮箱输入（格式校验）
- 密码设置（含确认密码）
- 邮箱验证码输入
- 请求验证码按钮（带倒计时）
- 用户协议同意复选框
- 实时表单验证

**忘记密码页面** (`/src/views/auth/ForgetPassword.vue`)：
- 邮箱地址输入
- 请求重置邮件按钮（带倒计时）
- 邮件发送状态提示

#### 3.2 主应用框架布局（登录后）

采用经典的三段式布局：

```
+-----------------------------------------------------+
|  顶部导航栏 (Header)                                |
+-----------------------------------------------------+
|  |                                                  |
|  |                                                  |
|侧|                    主内容区                      |
|边|                    (Main View)                   |
|栏|                                                  |
|  |                                                  |
|  |                                                  |
+-----------------------------------------------------+
```

**顶部导航栏** (`AppHeader.vue`)：
- **左侧**：系统Logo + 项目名称
- **中部**：全局搜索栏（快速搜索主机）
- **右侧**：
  - 消息通知图标（铃铛）+ 未读计数
  - 用户头像/用户名
  - 下拉菜单：个人中心、修改密码、退出登录

**侧边栏** (`AppSidebar.vue`)：
- 可折叠的垂直菜单
- **核心菜单项**：
  1. **仪表盘** (Dashboard) - 默认选中
  2. **主机监控** (Hosts)
  3. **AI对话** (AI Assistant) - 通用AI助手
  4. **系统管理** (Admin) - 仅管理员可见

#### 3.3 仪表盘 (`/src/views/dashboard/Dashboard.vue`)

**功能点**：
- 系统运行概览
- 关键指标汇总

**全局统计卡片区**：
- **主机总数**（在线/离线数量）
- **离线主机数**（触发告警的主机）
- **平均CPU使用率**
- **平均内存使用率**

#### 3.4 主机监控 (`/src/views/host/HostMonitor.vue`)

**功能点**：
- 主机列表与状态
- 监控数据查看
- 主机配置管理

**列表视图**：
- **表格/卡片展示**：显示所有已注册主机
- **主机信息**：主机名、IP、在线状态、资源使用率
- **快速筛选**：按状态（在线/离线）、资源使用率筛选
- **操作按钮**：SSH连接、查看详情

**主机详情面板** (`HostDetailDialog.vue`)：
- **基本信息**：
  - 主机名、IP地址
  - CPU型号、核心数
  - 内存总容量
  - GPU信息
  - 网络接口
- **实时监控**（ECharts图表）：
  - CPU使用率历史曲线
  - 内存使用率变化
  - 磁盘使用率（各分区）
  - 网络流量（上行/下行）
- **操作按钮**：
  - SSH连接
  - 修改主机名称
  - 删除主机

**SSH凭证对话框** (`SshCredentialDialog.vue`)：
- 首次连接时输入SSH凭证
- 用户名、密码输入
- 端口设置（默认22）
- 保存凭证选项

#### 3.5 SSH终端 (`TerminalPanel.vue`)

**功能点**：
- Web终端，基于 **xterm.js** 实现
- 支持多种终端操作
- 多会话管理

**连接流程**：
1. 点击主机列表的"连接"按钮
2. 弹出SSH凭证对话框（首次连接或未保存凭证）
3. 调用 `POST /api/v1/ssh/connect` 建立连接
4. 获取 `sessionId`
5. 建立 WebSocket 连接：`ws://server/api/v1/ssh/terminal/{sessionId}`
6. 打开终端界面

**终端功能**：
- 实时显示SSH输出
- 支持用户输入命令
- 支持终端复制粘贴
- 支持多标签页（多个独立SSH会话）
- 关闭按钮断开连接

#### 3.5 AI助手功能

**功能点**：
- 两种AI助手场景，满足不同使用需求
- 通用AI对话（侧边栏）
- SSH绑定AI助手（主机详情页）

##### 3.5.1 侧边栏AI助手（全局）

**前端页面**：`/src/views/ai/SidebarAssistant.vue`

**路由**：`/ai`

**功能特性**：
- **多会话管理**：支持创建、切换、删除会话
- **会话列表**：左侧面板显示所有历史对话
- **消息历史**：自动加载会话的消息历史
- **相对时间**：智能显示时间（刚刚、X分钟前、X天前）
- **Markdown渲染**：支持代码高亮和格式化显示
- **主机关联**：可选关联主机到会话

**UI布局**：
```
┌─────────────────────────────────────────────────────────────┐
│  侧边栏面板 (280px)     │    主聊天区域 (自适应)              │
│  ┌──────────────────┐  │  ┌──────────────────────────────┐  │
│  │ [新对话] 按钮     │  │  │  消息列表滚动区               │  │
│  ├──────────────────┤  │  │  ┌────────────────────────┐  │  │
│  │ 会话列表          │  │  │  │ 用户: 查看磁盘使用     │  │  │
│  │ ├─ 对话1         │  │  │  ├────────────────────────┤  │  │
│  │ ├─ 对话2 (active)│  │  │  │ AI: 磁盘使用情况如下... │  │  │
│  │ └─ ...           │  │  │  └────────────────────────┘  │  │
│  └──────────────────┘  │  │  输入框 + 发送按钮             │  │
│                        │  └──────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

**API接口**：
```
POST   /api/chat/sessions                    创建新会话
GET    /api/chat/sessions                    获取所有会话
GET    /api/chat/sessions/{sessionId}        获取会话详情
DELETE /api/chat/sessions/{sessionId}        删除会话
GET    /api/chat/sessions/{sessionId}/messages  获取消息历史
POST   /api/chat/messages                    发送消息
DELETE /api/chat/sessions/{sessionId}/messages  清空消息
POST   /api/chat/sessions/{sessionId}/link   关联主机
```

##### 3.5.2 主机详情页AI助手（SSH绑定）

**前端组件**：`/src/components/ai/AiAssistantDialog.vue`

**功能特性**：
- **单会话模式**：与SSH终端绑定的AI助手
- **WebSocket通信**：实时双向通信
- **SSH命令执行**：AI可执行SSH命令并分析结果
- **命令输出展示**：实时显示命令执行输出
- **AI结果分析**：命令完成后自动触发AI分析
- **非模态对话框**：可同时操作SSH终端和AI助手

**使用流程**：
1. 打开主机详情页
2. 点击"连接SSH"建立终端连接
3. 点击"AI助手"按钮打开AI助手对话框
4. 与AI对话，AI可执行命令并分析结果

**API接口**：
```
POST   /api/ai/ssh-assistant/connect            连接AI助手
DELETE /api/ai/ssh-assistant/disconnect/{id}    断开AI助手
GET    /api/ai/ssh-assistant/binding/{id}      获取绑定信息
GET    /api/ai/ssh-assistant/active/{id}       检查会话活跃
WebSocket /ws/ai/ssh-assistant/{aiSessionId}   WebSocket连接
```

##### 3.5.3 技术对比

| 特性 | 侧边栏AI助手 | 主机详情页AI助手 |
|------|-------------|-----------------|
| **位置** | 全局侧边栏菜单 | 主机详情页对话框 |
| **通信方式** | HTTP REST API | WebSocket长连接 |
| **会话类型** | 多会话管理 | 单会话（与SSH绑定） |
| **主机关联** | 可选 | 必需（通过SSH Session） |
| **SSH命令执行** | 不支持 | 支持（实时输出+AI分析） |
| **消息存储** | Redis（assistant:session:*） | Redis（ai:ssh:*） |

#### 3.7 系统管理界面（未实现）

**前端页面**：
- `/src/views/admin/UserManagement.vue`：用户管理
- `/src/views/admin/SystemSettings.vue`：系统设置

**当前状态**：
- 前端UI已存在
- 后端API完全缺失
- 前端功能无法使用

---

## 四、数据流说明

### 4.1 Agent注册与上报流程

```
┌─────────┐                    ┌─────────┐
│  Agent  │                    │ Server  │
└────┬────┘                    └────┬────┘
     │                              │
     │ 1. 启动，检查本地配置         │
     │                              │
     │ 未注册 → 2. 健康检查 /api/health
     ├──────────────────────────►  │
     │  3. 选择最快服务器            │
     │  ◄───────────────────────────┤
     │                              │
     │ 4. POST /api/v1/customer/register
     ├──────────────────────────►  │
     │                              │ 5. 生成agent_id
     │                              │ 6. 保存到数据库
     │ 7. {agentId, agentName, token}
     │ ◄───────────────────────────┤
     │                              │
     │ 8. 保存到本地配置             │
     │ 9. 开始定时上报               │
     │                              │
     │ 每10分钟 → POST /api/v1/agent/basic
     ├──────────────────────────►  │
     │                              │ 保存到agent表
     │                              │
     │ 每15秒 → POST /api/v1/agent/metrics
     ├──────────────────────────►  │
     │                              │ 保存到agent_metrics表
```

### 4.2 用户认证与数据查询流程

```
┌──────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│ Web  │  │Auth Ctrl│  │Security │  │  MySQL  │
└──┬───┘  └────┬────┘  └────┬────┘  └────┬────┘
   │           │            │            │
   │ 1. POST /api/auth/login
   ├──────────►            │            │
   │                       │            │
   │                       │ 2. 查询用户
   │                       ├──────────────────►
   │                       │            │
   │                       │ 3. 验证密码
   │                       │ ◄─────────────────
   │                       │            │
   │                       │ 4. 生成JWT Token
   │ 5. {token, user}      │            │
   │ ◄───────────          │            │
   │                       │            │
   │ 6. 存储Token到localStorage
   │                       │            │
   │ 7. GET /api/monitor/getMonitorList
   │ Authorization: Bearer {token}
   ├──────────►            │            │
   │                       │ 8. 验证Token
   │                       ├──────────────────►
   │ 9. {agentList}        │            │
   │ ◄───────────          │            │
```

### 4.3 SSH终端连接流程

```
┌──────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│ Web  │  │Ssh Ctrl │  │WebSocket│  │  Host   │
│      │  │         │  │ Handler │  │  SSH    │
└──┬───┘  └────┬────┘  └────┬────┘  └────┬────┘
   │           │            │            │
   │ 1. POST /api/v1/ssh/connect
   ├──────────►            │            │
   │           {agentId, username, password}
   │                       │            │
   │                       │ 2. JSch建立SSH连接
   │                       ├──────────────────►
   │                       │            │
   │ 3. {sessionId}        │ 4. 创建SshSession
   │ ◄───────────          │            │
   │                       │            │
   │ 5. WS /api/v1/ssh/terminal/{sessionId}
   ├──────────►            │            │
   │                       │            │
   │ 6. 输入 "ls -la"      │            │
   ├──────────►            │            │
   │                       │ 7. 转发到SSH
   │                       ├──────────────────►
   │                       │            │
   │                       │ 8. SSH返回结果
   │                       │ ◄─────────────────
   │ 9. 显示结果           │            │
   │ ◄───────────          │            │
```

---

## 五、已实现与未实现功能汇总

### 5.1 已实现功能

| 模块 | 功能 | 状态 |
|------|------|------|
| Agent | 自动注册 | ✅ |
| Agent | 多服务器选择 | ✅ |
| Agent | 双频数据上报 | ✅ |
| Agent | OSHI系统信息采集 | ✅ |
| Server | Agent注册接收 | ✅ |
| Server | 指标数据存储(MySQL) | ✅ |
| Server | 历史数据查询与聚合 | ✅ |
| Server | SSH连接(JSch) | ✅ |
| Server | SSH WebSocket代理 | ✅ |
| Server | SSH凭证管理 | ✅ |
| Server | JWT认证 | ✅ |
| Server | 用户注册/登录/登出 | ✅ |
| Server | Token刷新 | ✅ |
| Server | 邮箱验证码(RabbitMQ) | ✅ |
| Server | 密码重置 | ✅ |
| Server | AI对话服务（HTTP） | ✅ |
| Server | AI SSH助手（WebSocket） | ✅ |
| Server | AI命令执行与分析 | ✅ |
| Web | 登录页面 | ✅ |
| Web | 注册页面 | ✅ |
| Web | 忘记密码页面 | ✅ |
| Web | 仪表盘 | ✅ |
| Web | 主机监控列表 | ✅ |
| Web | 主机详情与图表 | ✅ |
| Web | SSH终端(xterm.js) | ✅ |
| Web | 侧边栏AI助手 | ✅ |
| Web | 主机详情页AI助手 | ✅ |
| Web | 顶部导航与侧边栏 | ✅ |

### 5.2 未实现功能

| 模块 | 功能 | 说明 |
|------|------|------|
| Admin | 用户管理API | 前端有页面，后端无接口 |
| Admin | 系统设置API | 前端有页面，后端无接口 |
| Storage | InfluxDB时序存储 | 依赖已引入但代码中完全未使用 |
| Security | SSH凭证加密 | 当前明文存储 |

### 5.3 部分实现功能

| 模块 | 功能 | 说明 |
|------|------|------|
| Agent | 配置更新 | 接口存在，功能基础 |
| WebSocket | 终端resize | 二进制消息处理标记为TODO |
| WebSocket | 心跳保活 | pong消息处理标记为TODO |

---

## 六、技术栈

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Java | 17 | 编程语言 |
| Spring Boot | 3.5.10 | 应用框架 |
| Spring Security | - | 安全框架 |
| MyBatis-Plus | 3.5.15 | ORM框架 |
| OSHI | 6.4.3/6.6.5 | 系统信息采集 |
| JSch | 0.1.55 | SSH连接 |
| JWT | 0.11.5 | Token认证 |
| WebSocket | - | 实时通信 |
| RabbitMQ | - | 消息队列 |
| Redis | - | 缓存 |
| MySQL | 8.0+ | 关系数据库 |
| Jackson | - | JSON序列化 |
| Lombok | - | 代码简化 |
| SnakeYAML | - | YAML解析 |
| Resilience4j | - | 容错重试 |
| OpenFeign | - | HTTP客户端 |

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue | 3.5.26 | 前端框架 |
| TypeScript | ~5.9.3 | 编程语言 |
| Vite | 7.3.1 | 构建工具 |
| Element Plus | 2.13.1 | UI组件库 |
| ECharts | 5.5.1 | 图表库 |
| xterm.js | 5.5.0 | 终端模拟器 |
| Pinia | 3.0.4 | 状态管理 |
| Vue Router | 4.6.4 | 路由管理 |
| Axios | 1.13.4 | HTTP客户端 |

### 依赖服务

| 服务 | 推荐版本 | 用途 |
|------|----------|------|
| MySQL | 8.0+ | 关系数据库 |
| Redis | 6.0+ | 缓存服务 |
| RabbitMQ | 3.8+ | 消息队列 |
| Node.js | 20.19.0+ 或 22.12.0+ | 前端开发环境 |
