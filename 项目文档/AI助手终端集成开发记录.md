# AIåŠ©æ‰‹ç»ˆç«¯é›†æˆå¼€å‘è®°å½•

## ä¸€ã€æœ€åˆéœ€æ±‚

ç”¨æˆ·éœ€è¦åœ¨Monitorç›‘æ§ç³»ç»Ÿä¸­å¼€å‘ä¸€ä¸ªé›†æˆåœ¨ä¸»æœºè¯¦æƒ…é¡µçš„AIåŠ©æ‰‹åŠŸèƒ½ï¼Œæ”¯æŒä¼šè¯ç®¡ç†ã€æ¶ˆæ¯å†å²ã€ä¸Šä¸‹æ–‡ä¿æŒå’Œæ™ºèƒ½æ€»ç»“å‹ç¼©ã€‚

---

## äºŒã€æ¶æ„æ¼”è¿›ï¼ˆV3.0ï¼šæ¨¡å—åŒ–é‡æ„ï¼‰

### 2.1 é‡æ„èƒŒæ™¯

ä¸ºäº†å®ç°æ›´å¥½çš„ç³»ç»Ÿå¯æ‰©å±•æ€§å’ŒæœåŠ¡ç‹¬ç«‹æ€§ï¼Œå°†ä¾§è¾¹æ AIåŠ©æ‰‹åŠŸèƒ½ä»Monitor-Serverä¸­æŠ½ç¦»ï¼Œå½¢æˆç‹¬ç«‹çš„Monitor-AIå¾®æœåŠ¡æ¨¡å—ã€‚

### 2.2 é‡æ„ç›®æ ‡

| é‡æ„é¡¹ | è¯´æ˜ |
|--------|------|
| **ç‹¬ç«‹éƒ¨ç½²** | Monitor-AIå¯ä½œä¸ºç‹¬ç«‹æœåŠ¡éƒ¨ç½²ï¼ˆç«¯å£8081ï¼‰ |
| **èŒè´£åˆ†ç¦»** | ä¾§è¾¹æ AI â†’ Monitor-AIï¼ŒSSHç»‘å®šAI â†’ Monitor-Server |
| **å…±äº«ä¾èµ–** | CommonLibraryæ‰©å±•ai/modelã€ai/requestã€ai/response |
| **APIé€šä¿¡** | AIæœåŠ¡é€šè¿‡Feignè°ƒç”¨Serverçš„Agent API |
| **å‰ç«¯è·¯ç”±** | åˆ†åˆ«é…ç½®ä¸åŒbaseURLè°ƒç”¨ä¸åŒæœåŠ¡ |

### 2.3 æ–°æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Monitor-Web (Vue 3)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¾§è¾¹æ AIåŠ©æ‰‹ (/ai)           ä¸»æœºè¯¦æƒ…é¡µAIåŠ©æ‰‹                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ ChatSessionAPI            â”œâ”€ AiAssistantDialog.vue            â”‚   â”‚
â”‚  â”‚  â””â”€ ai-request.ts             â””â”€ useAiChat.ts                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                        â”‚                    â”‚
â”‚           â”‚ HTTP REST API                         â”‚ WebSocket          â”‚
â”‚           â–¼                                        â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Monitor-AI      â”‚                   â”‚  Monitor-Server  â”‚             â”‚
â”‚  â”‚  Port: 8081      â”‚â—„â”€â”€ Feign â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Port: 8080      â”‚             â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   Agent API       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚             â”‚
â”‚  â”‚  â”‚ChatControllerâ”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ â”‚AgentApiControllerâ”‚ â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚             â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚             â”‚
â”‚  â”‚  â”‚ChatService   â”‚ â”‚                   â”‚  â”‚AiSshAssistantControllerâ”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â”‚                                        â”‚                    â”‚
â”‚           â”‚ Redis                                  â”‚ Redis              â”‚
â”‚           â–¼                                        â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     CommonLibrary                                  â”‚   â”‚
â”‚  â”‚  ai/model/ChatMessage, SystemPrompt                               â”‚   â”‚
â”‚  â”‚  ai/request/CreateSessionRequest, SendMessageRequest              â”‚   â”‚
â”‚  â”‚  ai/response/ChatResponse, SessionInfoResponse                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | èŒè´£ | ç«¯å£ |
|------|------|------|
| **Monitor-Server** | SSHç»‘å®šAIåŠ©æ‰‹ã€Agentç®¡ç†ã€SSHä»£ç† | 8080 |
| **Monitor-AI** | ä¾§è¾¹æ AIåŠ©æ‰‹ï¼ˆå¤šä¼šè¯ç®¡ç†ï¼‰ | 8081 |
| **Monitor-Web** | å‰ç«¯ç•Œé¢ï¼Œåˆ†åˆ«è°ƒç”¨ä¸¤ä¸ªæœåŠ¡ | 5173 |
| **CommonLibrary** | å…±äº«å®ä½“ç±»å’ŒDTO | - |

### 2.5 é‡æ„å®Œæˆæ¸…å•

**æ–°å¢æ¨¡å—**: Monitor-AI
- âœ… pom.xml é…ç½®
- âœ… application.yaml é…ç½®
- âœ… AIModelConfig.javaï¼ˆGLM-4.7ã€OllamaåŒæ¨¡å‹é…ç½®ï¼‰
- âœ… JwtConfig.javaï¼ˆJWTè®¤è¯ï¼‰
- âœ… RedisConfig.javaï¼ˆRedisé…ç½®ï¼‰
- âœ… FeignConfig.javaï¼ˆFeignå®¢æˆ·ç«¯é…ç½®ï¼‰
- âœ… ChatSessionRedisUtils.javaï¼ˆRedisæ“ä½œï¼‰
- âœ… AgentClient.javaï¼ˆFeignå®¢æˆ·ç«¯è°ƒç”¨Serverï¼‰
- âœ… ChatService.javaï¼ˆèŠå¤©æœåŠ¡ï¼‰
- âœ… ChatController.javaï¼ˆ8ä¸ªREST APIç«¯ç‚¹ï¼‰

**æ‰©å±•æ¨¡å—**: CommonLibrary
- âœ… ai/model/ChatMessage.java
- âœ… ai/model/ChatSessionInfo.java
- âœ… ai/model/SystemPrompt.java
- âœ… ai/request/*.javaï¼ˆè¯·æ±‚DTOï¼‰
- âœ… ai/response/*.javaï¼ˆå“åº”DTOï¼‰

**ä¿®æ”¹æ¨¡å—**: Monitor-Server
- âœ… åˆ é™¤è¿ç§»åˆ°Monitor-AIçš„ä»£ç 
- âœ… åˆ›å»ºAgentApiController.javaï¼ˆä¾›AIæœåŠ¡è°ƒç”¨ï¼‰
- âœ… æ›´æ–°AiSshAssistantServiceä½¿ç”¨CommonLibraryçš„SystemPrompt

**ä¿®æ”¹æ¨¡å—**: Monitor-Web
- âœ… .env.development æ·»åŠ VITE_AI_API_BASE_URL
- âœ… src/utils/ai-request.tsï¼ˆAIæœåŠ¡ä¸“ç”¨HTTPå®¢æˆ·ç«¯ï¼‰
- âœ… src/api/ai.tsï¼ˆChatSessionAPIä½¿ç”¨ai-requestï¼‰

---

## ä¸‰ã€åˆå§‹æ¶æ„è®¾è®¡ï¼ˆå·²åºŸå¼ƒï¼‰

### 2.1 åŠŸèƒ½éœ€æ±‚
1. **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒå¤šä¼šè¯ã€ä¼šè¯åˆ—è¡¨å±•ç¤ºã€ä¼šè¯åˆ‡æ¢ã€ä¼šè¯åˆ é™¤
2. **æ¶ˆæ¯ç®¡ç†**ï¼šæ¶ˆæ¯å‘é€ã€æ¶ˆæ¯å†å²åŠ è½½ã€æ¶ˆæ¯æ¸…ç©º
3. **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šä¿æŒå¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒé•¿å¯¹è¯çš„æ€»ç»“å‹ç¼©
4. **ä¸»æœºå…³è”**ï¼šä¼šè¯å¯å…³è”ä¸»æœºï¼ŒAIå¯è·å–ä¸»æœºä¸Šä¸‹æ–‡ä¿¡æ¯

### 2.2 æŠ€æœ¯é€‰å‹
- **åç«¯**ï¼šSpring Boot 3.5.10 + LangChain4j
- **å‰ç«¯**ï¼šVue 3 + TypeScript
- **å­˜å‚¨**ï¼šRedisï¼ˆä¼šè¯ã€æ¶ˆæ¯ã€æ€»ç»“ï¼‰
- **AIæ¨¡å‹**ï¼šGLM-4.7ï¼ˆBigModel APIï¼‰æˆ– Ollamaæœ¬åœ°æ¨¡å‹

### 2.3 åˆå§‹å¼€å‘æ­¥éª¤

```
æ­¥éª¤1: åŸºç¡€å®ä½“ç±»
  â”œâ”€â”€ Message.java           - èŠå¤©æ¶ˆæ¯å®ä½“
  â””â”€â”€ SessionInfo.java       - ä¼šè¯ä¿¡æ¯å®ä½“ï¼ˆRedisæ˜ å°„ï¼‰

æ­¥éª¤2: Rediså·¥å…·ç±»
  â””â”€â”€ ModelRedisUtils.java   - æ¶ˆæ¯å’Œä¼šè¯çš„Redisæ“ä½œ

æ­¥éª¤3: Serviceå±‚
  â””â”€â”€ ChatService.java       - èŠå¤©æœåŠ¡é€»è¾‘

æ­¥éª¤4: Controllerå±‚
  â”œâ”€â”€ DTOç±»                  - è¯·æ±‚/å“åº”å¯¹è±¡
  â””â”€â”€ ChatController.java    - HTTP REST API

æ­¥éª¤5: å‰ç«¯é›†æˆ
  â””â”€â”€ AIAssistant.vue        - èŠå¤©ç•Œé¢ç»„ä»¶
```

---

## ä¸‰ã€å¼€å‘è¿›åº¦

### 3.1 å·²å®ŒæˆåŠŸèƒ½ï¼ˆåœºæ™¯Aï¼šå…¨å±€ä¾§è¾¹æ AIåŠ©æ‰‹ï¼‰

| æ­¥éª¤ | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| æ­¥éª¤1 | åŸºç¡€å®ä½“ç±» | âœ… å®Œæˆ |
| æ­¥éª¤2 | Rediså·¥å…·ç±» | âœ… å®Œæˆ |
| æ­¥éª¤3 | Serviceå±‚ | âœ… å®Œæˆ |
| æ­¥éª¤4 | Controllerå±‚ | âœ… å®Œæˆ |

### 3.2 å·²åˆ›å»ºæ–‡ä»¶ï¼ˆåœºæ™¯Aï¼‰

```
monitor-project/Monitor-Server/src/main/java/com/hundred/monitor/server/ai/

â”œâ”€â”€ entity/
â”‚   â”œâ”€â”€ Message.java                    âœ… èŠå¤©æ¶ˆæ¯å®ä½“
â”‚   â””â”€â”€ SessionInfo.java                âœ… ä¼šè¯ä¿¡æ¯å®ä½“
â”‚
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ ModelRedisUtils.java            âœ… Rediså·¥å…·ç±»
â”‚
â”œâ”€â”€ service/
â”‚   â””â”€â”€ ChatService.java                âœ… èŠå¤©æœåŠ¡
â”‚
â””â”€â”€ controller/
    â””â”€â”€ ChatController.java             âœ… HTTP REST API
```

---

## å››ã€å¼€å‘æš‚åœä¸é‡æ–°åˆ†æ

### 4.1 æš‚åœåŸå› 

ç”¨æˆ·å‘ç°æˆ‘å¯¹éœ€æ±‚çš„ç†è§£å­˜åœ¨åå·®ï¼Œéœ€è¦é‡æ–°æ˜ç¡®æ¶æ„è®¾è®¡ã€‚

### 4.2 ç”¨æˆ·æ¾„æ¸…çš„å…³é”®ä¿¡æ¯

1. **ä¸¤ç§AIåŠ©æ‰‹åœºæ™¯ï¼Œå®Œå…¨ç‹¬ç«‹ï¼Œæ— äº¤é›†**

2. **åœºæ™¯Aï¼šå…¨å±€ä¾§è¾¹æ AIåŠ©æ‰‹**
   - ä½ç½®ï¼šå…¨å±€ä¾§è¾¹æ 
   - é€šä¿¡æ–¹å¼ï¼šHTTP REST API
   - åŠŸèƒ½ï¼šé€šç”¨AIå¯¹è¯ï¼Œä¸å…³è”ä¸»æœº
   - å·²å¼€å‘ï¼šChatController + ChatService

3. **åœºæ™¯Bï¼šä¸»æœºè¯¦æƒ…é¡µAIåŠ©æ‰‹**ï¼ˆæœ¬æ¬¡å¼€å‘é‡ç‚¹ï¼‰
   - ä½ç½®ï¼šä¸»æœºè¯¦æƒ…é¡µ
   - é€šä¿¡æ–¹å¼ï¼šWebSocketé•¿è¿æ¥
   - åŠŸèƒ½ï¼šä¸SSHç»ˆç«¯ç»‘å®šçš„AIåŠ©æ‰‹ï¼Œå¯ç›´æ¥æ‰§è¡ŒSSHå‘½ä»¤
   - çŠ¶æ€ï¼šå¾…å¼€å‘

### 4.3 é‡æ–°ç†è§£çš„æ ¸å¿ƒé€»è¾‘

#### ä¸»æœºè¯¦æƒ…é¡µAIåŠ©æ‰‹äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤1ï¼šç”¨æˆ·æ‰“å¼€SSHç»ˆç«¯                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å‰ç«¯ç‚¹å‡»[è¿æ¥ç»ˆç«¯]æŒ‰é’®                                              â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ WebSocketè¿æ¥: ws://server/ws/ssh/terminal/{sshSessionId}          â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ åç«¯SshWebSocketHandlerå¤„ç†ï¼ˆå·²æœ‰ï¼‰                                 â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ å‰ç«¯è·å¾— sshSessionId                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤2ï¼šç”¨æˆ·æ‰“å¼€AIåŠ©æ‰‹                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å‰ç«¯ç‚¹å‡»[æ‰“å¼€AIåŠ©æ‰‹]æŒ‰é’®                                            â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ æ£€æŸ¥: sshSessionId æ˜¯å¦å­˜åœ¨?                                        â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â”œâ”€ ä¸å­˜åœ¨ â†’ æç¤º"è¯·å…ˆæ‰“å¼€ç»ˆç«¯"                                  â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â””â”€ å­˜åœ¨ â†’ å‘é€HTTPè¯·æ±‚                                          â”‚  â”‚
â”‚  â”‚           â”‚                                                        â”‚  â”‚
â”‚  â”‚           â–¼                                                        â”‚  â”‚
â”‚  â”‚     POST /api/ai/ssh-assistant/connect                             â”‚  â”‚
â”‚  â”‚     {                                                              â”‚  â”‚
â”‚  â”‚       "sshSessionId": "xxx",                                       â”‚  â”‚
â”‚  â”‚       "agentId": "agent-001"                                       â”‚  â”‚
â”‚  â”‚     }                                                              â”‚  â”‚
â”‚  â”‚           â”‚                                                        â”‚  â”‚
â”‚  â”‚           â–¼                                                        â”‚  â”‚
â”‚  â”‚     åç«¯åˆ›å»ºAIä¼šè¯ï¼Œè¿”å› aiSessionId                                â”‚  â”‚
â”‚  â”‚     {                                                              â”‚  â”‚
â”‚  â”‚       "aiSessionId": "yyy"                                         â”‚  â”‚
â”‚  â”‚     }                                                              â”‚  â”‚
â”‚  â”‚           â”‚                                                        â”‚  â”‚
â”‚  â”‚           â–¼                                                        â”‚  â”‚
â”‚  â”‚     åç«¯å­˜å‚¨ç»‘å®šå…³ç³»åˆ°Redis:                                        â”‚  â”‚
â”‚  â”‚     key: "ai:ssh:binding:{aiSessionId}"                            â”‚  â”‚
â”‚  â”‚     value: { sshSessionId, agentId }                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤3ï¼šå»ºç«‹AI WebSocketè¿æ¥                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å‰ç«¯ä½¿ç”¨ aiSessionId å»ºç«‹WebSocketè¿æ¥                              â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ WebSocketè¿æ¥: ws://server/ws/ai/ssh-assistant/{aiSessionId}       â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ åç«¯AiSshAssistantHandlerå¤„ç†                                       â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ ä»Redisè·å–ç»‘å®šå…³ç³»ï¼ˆsshSessionId, agentIdï¼‰                        â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ å°†WebSocketè¿æ¥ä¸ä¼šè¯å…³è”å­˜å‚¨                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤4ï¼šAIå¯¹è¯äº¤äº’                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”¨æˆ·å‘é€æ¶ˆæ¯                                                        â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ WebSocketæ¶ˆæ¯åˆ°è¾¾ AiSshAssistantHandler                            â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ AiSshAssistantService å¤„ç†                                          â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ æ„å»ºAIä¸Šä¸‹æ–‡:                                                       â”‚  â”‚
â”‚  â”‚   - ç³»ç»Ÿæç¤ºè¯                                                      â”‚  â”‚
â”‚  â”‚   - å½“å‰ä¸»æœºID (agentId)                                           â”‚  â”‚
â”‚  â”‚   - å†å²å¯¹è¯æ¶ˆæ¯                                                    â”‚  â”‚
â”‚  â”‚   - å†å²æ€»ç»“ï¼ˆå¦‚æœ‰ï¼‰                                                â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ è°ƒç”¨LangChain4j AIæ¨¡å‹                                              â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ AIå¯è°ƒç”¨SshExecuteToolæ‰§è¡ŒSSHå‘½ä»¤                                   â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ è¿”å›AIå›å¤ â†’ WebSocketå‘é€ç»™å‰ç«¯                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 æ ¸å¿ƒæ¦‚å¿µ

#### SSH Session ä¸ AI Session çš„ç»‘å®šå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å‰ç«¯                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¸»æœºè¯¦æƒ…é¡µ                                                        â”‚   â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚    â”‚  SSHç»ˆç«¯çª—å£     â”‚  â”‚  AIåŠ©æ‰‹é¢æ¿                     â”‚      â”‚   â”‚
â”‚  â”‚    â”‚  (xterm.js)      â”‚  â”‚  - æ¶ˆæ¯è¾“å…¥æ¡†                   â”‚      â”‚   â”‚
â”‚  â”‚    â”‚                 â”‚  â”‚  - AIå›å¤å±•ç¤º                   â”‚      â”‚   â”‚
â”‚  â”‚    â”‚  $ ls -la       â”‚  â”‚                                 â”‚      â”‚   â”‚
â”‚  â”‚    â”‚                 â”‚  â”‚  AI: æ­£åœ¨åˆ†ææ—¥å¿—...            â”‚      â”‚   â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                    â”‚                          â”‚
â”‚         â”‚ sshSessionId                       â”‚ aiSessionId             â”‚
â”‚         â–¼                                    â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          åç«¯                                    â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  SSH WebSocket (å·²æœ‰)              AI WebSocket (å¾…å¼€å‘)          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚ SshWebSocketHandler   â”‚        â”‚ AiSshAssistantHandler â”‚      â”‚   â”‚
â”‚  â”‚  â”‚ /ws/ssh/terminal/     â”‚        â”‚ /ws/ai/ssh-assistant/ â”‚      â”‚   â”‚
â”‚  â”‚  â”‚ {sshSessionId}        â”‚        â”‚ {aiSessionId}         â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â”‚              â”‚                              â”‚                      â”‚   â”‚
â”‚  â”‚              â”‚                              â”‚                      â”‚   â”‚
â”‚  â”‚              â–¼                              â–¼                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚              Redis ç»‘å®šå…³ç³»                         â”‚          â”‚   â”‚
â”‚  â”‚  â”‚  ai:ssh:binding:{aiSessionId} â†’ {                  â”‚          â”‚   â”‚
â”‚  â”‚  â”‚    "sshSessionId": "xxx",                          â”‚          â”‚   â”‚
â”‚  â”‚  â”‚    "agentId": "agent-001"                          â”‚          â”‚   â”‚
â”‚  â”‚  â”‚  }                                                â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### AIä¸Šä¸‹æ–‡è®¾è®¡

AIå¯¹è¯æ—¶çš„ä¸Šä¸‹æ–‡åŒ…å«ï¼š

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| **ç³»ç»Ÿæç¤ºè¯** | ä½ æ˜¯æœåŠ¡å™¨è¿ç»´AIåŠ©æ‰‹ï¼ŒæœåŠ¡äºMonitorç›‘æ§ç³»ç»Ÿ... |
| **ä¸»æœºä¿¡æ¯** | å½“å‰ä¸»æœºIDã€IPã€ä¸»æœºåç­‰ |
| **å†å²æ¶ˆæ¯** | è¿‘æœŸNæ¡å¯¹è¯æ¶ˆæ¯ |
| **å†å²æ€»ç»“** | æ¶ˆæ¯è¿‡å¤šæ—¶ç”Ÿæˆçš„æ€»ç»“ |
| **å¯ç”¨å·¥å…·** | SshExecuteTool - æ‰§è¡ŒSSHå‘½ä»¤ |

---

## äº”ã€é‡æ–°è®¾è®¡å¼€å‘æ­¥éª¤

### 5.1 æ–‡ä»¶é‡å‘½åè®¡åˆ’

| æ“ä½œ | åŸæ–‡ä»¶å | æ–°æ–‡ä»¶å | è¯´æ˜ |
|------|----------|----------|------|
| é‡å‘½å | `SshAssistantHandler.java` | `AiSshAssistantHandler.java` | WebSocketå¤„ç†å™¨ |
| é‡å‘½å | `SshAssistantManager.java` | `AiSshAssistantManager.java` | ä¼šè¯ç®¡ç†å™¨ |
| é‡å‘½å | `SshAssistantSession.java` | `AiSshAssistantSession.java` | ä¼šè¯å®ä½“ |

### 5.2 æ–°å¢æ–‡ä»¶è®¡åˆ’

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `AiSshAssistantController.java` | HTTPæ¡æ‰‹æ¥å£ï¼ˆè¿æ¥ã€æ–­å¼€ï¼‰ |
| `AiSshAssistantService.java` | AIå¯¹è¯æœåŠ¡é€»è¾‘ |
| `SshSessionBinding.java` | ç»‘å®šå…³ç³»å®ä½“ |
| `AiSshRedisUtils.java` | Redisæ“ä½œå·¥å…·ç±»ï¼ˆä¸“ç”¨ï¼‰ |
| `SshSessionContext.java` | ThreadLocalä¸Šä¸‹æ–‡æŒæœ‰è€… |

### 5.3 å¼€å‘æ­¥éª¤

```
æ­¥éª¤1: æ–‡ä»¶é‡å‘½å
  â”œâ”€â”€ SshAssistantHandler.java â†’ AiSshAssistantHandler.java
  â”œâ”€â”€ SshAssistantManager.java â†’ AiSshAssistantManager.java
  â””â”€â”€ SshAssistantSession.java â†’ AiSshAssistantSession.java

æ­¥éª¤2: å¼€å‘åŸºç¡€å®ä½“
  â””â”€â”€ SshSessionBinding.java      - SSHä¸AIä¼šè¯ç»‘å®šå…³ç³»

æ­¥éª¤3: å¼€å‘Rediså·¥å…·ç±»
  â””â”€â”€ AiSshRedisUtils.java        - ç»‘å®šå…³ç³»ã€æ¶ˆæ¯å­˜å‚¨

æ­¥éª¤4: å¼€å‘Controllerå±‚
  â”œâ”€â”€ DTOç±»                       - è¯·æ±‚/å“åº”å¯¹è±¡
  â””â”€â”€ AiSshAssistantController.java - HTTPæ¡æ‰‹æ¥å£

æ­¥éª¤5: å¼€å‘Serviceå±‚
  â”œâ”€â”€ AiSshAssistantService.java  - AIå¯¹è¯é€»è¾‘
  â”œâ”€â”€ SshSessionContext.java      - ThreadLocalä¸Šä¸‹æ–‡
  â””â”€â”€ SshExecuteTool.java         - SSHå‘½ä»¤å·¥å…·ï¼ˆå®Œå–„ï¼‰

æ­¥éª¤6: å®Œå–„/Handlerå±‚
  â”œâ”€â”€ AiSshAssistantHandler.java  - WebSocketæ¶ˆæ¯å¤„ç†
  â””â”€â”€ WsChatMessage.java          - WebSocketæ¶ˆæ¯DTO

æ­¥éª¤7: å®Œå–„/Managerå±‚
  â””â”€â”€ AiSshAssistantManager.java  - ä¼šè¯ç®¡ç†

æ­¥éª¤8: é…ç½®WebSocketè·¯å¾„
  â””â”€â”€ AgentModelWebSocketConfig.java - æ›´æ–°è·¯ç”±é…ç½®
```

### 5.4 APIæ¥å£è®¾è®¡

#### HTTPæ¡æ‰‹æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/ai/ssh-assistant/connect` | åˆ›å»ºAIä¼šè¯ï¼Œå»ºç«‹ç»‘å®š |
| DELETE | `/api/ai/ssh-assistant/disconnect/{aiSessionId}` | æ–­å¼€AIä¼šè¯ |
| GET | `/api/ai/ssh-assistant/binding/{aiSessionId}` | è·å–ç»‘å®šä¿¡æ¯ |
| GET | `/api/ai/ssh-assistant/active/{aiSessionId}` | æ£€æŸ¥ä¼šè¯æ˜¯å¦æ´»è·ƒ |

#### WebSocketæ¥å£

| è·¯å¾„ | è¯´æ˜ |
|------|------|
| `/ws/ai/ssh-assistant/{aiSessionId}` | AIåŠ©æ‰‹WebSocketé•¿è¿æ¥ |

#### æ¶ˆæ¯æ ¼å¼

```json
// å®¢æˆ·ç«¯å‘é€
{
  "type": "chat",
  "content": "å¸®æˆ‘æŸ¥çœ‹CPUä½¿ç”¨ç‡"
}

// æœåŠ¡ç«¯å“åº”ï¼ˆæˆåŠŸï¼‰
{
  "type": "reply",
  "content": "å¥½çš„ï¼Œæ­£åœ¨ä¸ºæ‚¨æŸ¥è¯¢...",
  "timestamp": 1234567890000
}

// æœåŠ¡ç«¯å“åº”ï¼ˆé”™è¯¯ï¼‰
{
  "type": "error",
  "errorCode": "SESSION_NOT_FOUND",
  "content": "AIä¼šè¯ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¿æ¥",
  "timestamp": 1234567890000
}
```

### 5.5 Redisæ•°æ®ç»“æ„è®¾è®¡

```
# ç»‘å®šå…³ç³»ï¼ˆStringï¼Œå­˜å‚¨JSONï¼‰
ai:ssh:binding:{aiSessionId} â†’ {
  "aiSessionId": "yyy",
  "sshSessionId": "xxx",
  "agentId": "agent-001",
  "userId": "user-001",
  "createdAt": 1234567890000
}
TTL: 24å°æ—¶

# æ¶ˆæ¯åˆ—è¡¨ï¼ˆListï¼‰
ai:ssh:messages:{aiSessionId} â†’ [Message1, Message2, ...]
TTL: 24å°æ—¶

# ä¼šè¯ä¿¡æ¯ï¼ˆStringï¼Œå­˜å‚¨JSONï¼‰
ai:ssh:info:{aiSessionId} â†’ {
  "sessionId": "yyy",
  "agentId": "agent-001",
  "sshSessionId": "xxx",
  "createdAt": 1234567890000,
  "messageCount": 5,
  "summary": "å†å²å¯¹è¯æ€»ç»“..."
}
TTL: 24å°æ—¶

# WebSocketæ´»è·ƒä¼šè¯é›†åˆï¼ˆSetï¼‰
ai:ssh:ws:sessions â†’ Set<aiSessionId>
```

---

## å…­ã€æ¶æ„å¯¹æ¯”ï¼ˆV3.0æ›´æ–°ï¼‰

### 6.1 ä¸¤ç§AIåŠ©æ‰‹åœºæ™¯å¯¹æ¯”ï¼ˆå¾®æœåŠ¡æ¶æ„ï¼‰

| ç‰¹æ€§ | åœºæ™¯Aï¼šä¾§è¾¹æ AIåŠ©æ‰‹ | åœºæ™¯Bï¼šä¸»æœºè¯¦æƒ…é¡µAIåŠ©æ‰‹ |
|------|----------------------|------------------------|
| **æœåŠ¡æ¨¡å—** | Monitor-AI (8081) | Monitor-Server (8080) |
| **ä½ç½®** | å…¨å±€ä¾§è¾¹æ  | ä¸»æœºè¯¦æƒ…é¡µ |
| **é€šä¿¡æ–¹å¼** | HTTP REST API | WebSocketé•¿è¿æ¥ |
| **ä¼šè¯ç±»å‹** | å¤šä¼šè¯ç®¡ç† | ä¸SSHç»ˆç«¯ç»‘å®š |
| **ä¸»æœºå…³è”** | å¯é€‰ | å¿…éœ€ï¼ˆé€šè¿‡SSH Sessionï¼‰ |
| **SSHå‘½ä»¤æ‰§è¡Œ** | ä¸æ”¯æŒ | æ”¯æŒ |
| **Controller** | ChatController | AiSshAssistantController |
| **Service** | ChatService | AiSshAssistantService |
| **Handler** | æ—  | AiSshAssistantHandler |
| **Rediså‰ç¼€** | `assistant:session:*` | `ai:ssh:*` |
| **å‰ç«¯API** | ChatSessionAPI | AIAssistantAPI |
| **å‰ç«¯è¯·æ±‚** | ai-request.ts | request.ts |
| **å¼€å‘çŠ¶æ€** | âœ… å·²å®Œæˆï¼ˆç‹¬ç«‹éƒ¨ç½²ï¼‰ | âœ… å·²å®Œæˆ |

### 6.2 æœåŠ¡é—´é€šä¿¡

**Monitor-AI â†’ Monitor-Server**:
```
GET  /api/v1/agent/list          è·å–Agentåˆ—è¡¨
GET  /api/v1/agent/{agentId}     è·å–Agentè¯¦æƒ…
```

**å‰ç«¯ â†’ Monitor-AI**:
```
POST   /api/chat/sessions                    åˆ›å»ºæ–°ä¼šè¯
GET    /api/chat/sessions                    è·å–æ‰€æœ‰ä¼šè¯
GET    /api/chat/sessions/{sessionId}        è·å–ä¼šè¯è¯¦æƒ…
DELETE /api/chat/sessions/{sessionId}        åˆ é™¤ä¼šè¯
GET    /api/chat/sessions/{sessionId}/messages  è·å–æ¶ˆæ¯å†å²
POST   /api/chat/messages                    å‘é€æ¶ˆæ¯
DELETE /api/chat/sessions/{sessionId}/messages  æ¸…ç©ºæ¶ˆæ¯
POST   /api/chat/sessions/{sessionId}/link   å…³è”ä¸»æœº
```

**å‰ç«¯ â†’ Monitor-Server** (SSHç»‘å®šAI):
```
POST   /api/ai/ssh-assistant/connect            è¿æ¥AIåŠ©æ‰‹
DELETE /api/ai/ssh-assistant/disconnect/{id}    æ–­å¼€AIåŠ©æ‰‹
GET    /api/ai/ssh-assistant/binding/{id}      è·å–ç»‘å®šä¿¡æ¯
GET    /api/ai/ssh-assistant/active/{id}       æ£€æŸ¥ä¼šè¯æ´»è·ƒ
WebSocket /ws/ai/ssh-assistant/{aiSessionId}   WebSocketè¿æ¥
```

### 6.2 ä»£ç å¤ç”¨å…³ç³»

| æ–‡ä»¶ | åœºæ™¯A | åœºæ™¯B | è¯´æ˜ |
|------|-------|-------|------|
| `Message.java` | âœ… | âœ… | å…±äº« |
| `SessionInfo.java` | âœ… | - | ä»…åœºæ™¯Aä½¿ç”¨ |
| `ChatController.java` | âœ… | - | ä»…åœºæ™¯Aä½¿ç”¨ |
| `ChatService.java` | âœ… | - | ä»…åœºæ™¯Aä½¿ç”¨ |
| `ModelRedisUtils.java` | âœ… | - | ä»…åœºæ™¯Aä½¿ç”¨ |
| `AiSshAssistantController.java` | - | âœ… | ä»…åœºæ™¯Bä½¿ç”¨ |
| `AiSshAssistantService.java` | - | âœ… | ä»…åœºæ™¯Bä½¿ç”¨ |
| `AiSshAssistantHandler.java` | - | âœ… | ä»…åœºæ™¯Bä½¿ç”¨ |
| `AiSshRedisUtils.java` | - | âœ… | ä»…åœºæ™¯Bä½¿ç”¨ |

---

## ä¸ƒã€åç«¯å¼€å‘å®Œæˆæ€»ç»“

### 7.1 å¼€å‘æ­¥éª¤å®Œæˆæƒ…å†µ

| æ­¥éª¤ | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| æ­¥éª¤1 | æ–‡ä»¶é‡å‘½å | âœ… å®Œæˆ |
| æ­¥éª¤2 | åŸºç¡€å®ä½“ç±» | âœ… å®Œæˆ |
| æ­¥éª¤3 | Rediså·¥å…·ç±» | âœ… å®Œæˆ |
| æ­¥éª¤4 | Controllerå±‚ | âœ… å®Œæˆ |
| æ­¥éª¤5 | Serviceå±‚ + ThreadLocal | âœ… å®Œæˆ |
| æ­¥éª¤6 | Handlerå±‚ | âœ… å®Œæˆ |
| æ­¥éª¤7 | Managerå±‚ | âœ… å®Œæˆ |
| æ­¥éª¤8 | WebSocketè·¯å¾„é…ç½® | âœ… å®Œæˆ |

### 7.2 å·²åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆåœºæ™¯Bï¼‰

```
monitor-project/Monitor-Server/src/main/java/com/hundred/monitor/server/

â”œâ”€â”€ ai/
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â””â”€â”€ SshSessionContext.java              âœ… ThreadLocalä¸Šä¸‹æ–‡æŒæœ‰è€…
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ AiSshAssistantSession.java           âœ… ä¼šè¯å®ä½“ï¼ˆé‡å‘½åï¼‰
â”‚   â”‚   â””â”€â”€ SshSessionBinding.java              âœ… SSH-AIç»‘å®šå…³ç³»å®ä½“
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â””â”€â”€ AiSshAssistantService.java          âœ… AIå¯¹è¯æœåŠ¡
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â””â”€â”€ SshExecuteTool.java                 âœ… SSHå‘½ä»¤æ‰§è¡Œå·¥å…·
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ AiSshRedisUtils.java                âœ… Rediså·¥å…·ç±»ï¼ˆ24ä¸ªæ–¹æ³•ï¼‰
â”‚   â”œâ”€â”€ websocket/
â”‚   â”‚   â”œâ”€â”€ AgentModelWebSocketConfig.java      âœ… WebSocketé…ç½®
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â””â”€â”€ WsChatMessage.java              âœ… WebSocketæ¶ˆæ¯DTO
â”‚   â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â”‚   â””â”€â”€ AiSshAssistantHandler.java      âœ… WebSocketå¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ manager/
â”‚   â”‚       â””â”€â”€ AiSshAssistantManager.java      âœ… ä¼šè¯ç®¡ç†å™¨ï¼ˆ18ä¸ªæ–¹æ³•ï¼‰
â”‚   â””â”€â”€ controller/
â”‚       â””â”€â”€ AiSshAssistantController.java      âœ… HTTPæ¡æ‰‹æ¥å£
â”‚
â””â”€â”€ model/
    â”œâ”€â”€ request/
    â”‚   â””â”€â”€ ConnectRequest.java                 âœ… è¿æ¥è¯·æ±‚DTO
    â””â”€â”€ response/
        â””â”€â”€ ConnectResponse.java                âœ… è¿æ¥å“åº”DTO
```

### 7.3 æ ¸å¿ƒåŠŸèƒ½å®ç°

#### ThreadLocalä¸Šä¸‹æ–‡ä¼ é€’ï¼ˆæ–¹æ¡ˆBï¼‰

```
AiSshAssistantService.sendMessage()
    â”‚
    â”œâ”€ è®¾ç½® ThreadLocal
    â”‚   SshSessionContext.setSshSessionId()
    â”‚   SshSessionContext.setAgentId()
    â”‚
    â”œâ”€ è°ƒç”¨ AI æ¨¡å‹
    â”‚   model.chat(context)
    â”‚     â”‚
    â”‚     â””â”€> AI å†³å®šè°ƒç”¨å·¥å…·
    â”‚           â”‚
    â”‚           â””â”€> SshExecuteTool.executeCommand(cmd)
    â”‚                  â”‚
    â”‚                  â””â”€> ä»ThreadLocalè·å–sshSessionId
    â”‚                       SshSessionContext.get()
    â”‚
    â””â”€ æ¸…ç† ThreadLocal
        SshSessionContext.clear()
```

#### å·¥å…·è°ƒç”¨æœºåˆ¶

```java
@Tool("åœ¨SSHç»ˆç«¯æ‰§è¡Œå‘½ä»¤ï¼Œç”¨äºæ‰§è¡ŒLinuxå‘½ä»¤å¹¶æŸ¥çœ‹ç»“æœ")
public String executeCommand(String command) {
    // ä»ThreadLocalè·å–sshSessionId
    String sshSessionId = SshSessionContext.getSshSessionId();

    // è·å–SSHä¼šè¯
    SshSession sshSession = SshSessionManager.getInstance().getSession(sshSessionId);

    // å‘SSHå‘é€å‘½ä»¤
    sshSession.getOutputStream().write((command + "\n").getBytes());
    sshSession.getOutputStream().flush();

    return "å‘½ä»¤å·²å‘é€åˆ°ç»ˆç«¯ï¼Œè¯·æŸ¥çœ‹ç»ˆç«¯è¾“å‡ºç»“æœã€‚";
}
```

### 7.4 å¾…å®Œå–„é¡¹

| é¡¹ç›® | å½“å‰çŠ¶æ€ | è¯´æ˜ |
|------|----------|------|
| JWTç”¨æˆ·ID | å†™æ­» "default-user" | TODOæ ‡è®°ï¼Œå¾…é›†æˆJWT |
| è·¨åŸŸé…ç½® | `setAllowedOrigins("*")` | ç”Ÿäº§ç¯å¢ƒéœ€é™åˆ¶åŸŸå |
| SSHå‘½ä»¤è¿”å› | ä»…å‘é€ï¼ŒæœªåŒæ­¥ç­‰å¾…ç»“æœ | å¼‚æ­¥æ¨é€åˆ°å‰ç«¯ |

### 7.5 éªŒè¯æ£€æŸ¥é¡¹

| éªŒè¯é¡¹ | è¯´æ˜ |
|--------|------|
| 1. AIæ¨¡å‹é…ç½® | `application.yaml` ä¸­API keyå’Œbase-url |
| 2. RedisæœåŠ¡ | Redisæ˜¯å¦æ­£å¸¸è¿è¡Œ |
| 3. SystemMessage | LangChain4jç‰ˆæœ¬æ”¯æŒæƒ…å†µ |
| 4. å·¥å…·è°ƒç”¨ | `@Tool`æ³¨è§£è¯†åˆ«å’Œè°ƒç”¨ |

---

## å…«ã€å¼€å‘æ—¥å¿—

| æ—¥æœŸ | æ“ä½œ | çŠ¶æ€ |
|------|------|------|
| åˆå§‹ | å®Œæˆæ­¥éª¤1-4å¼€å‘ï¼ˆåœºæ™¯Aï¼‰ | âœ… å®Œæˆ |
| - | å¼€å‘æš‚åœï¼Œé‡æ–°åˆ†æéœ€æ±‚ | â¸ï¸ æš‚åœ |
| - | ç”¨æˆ·æ¾„æ¸…éœ€æ±‚ï¼Œé‡æ–°è®¾è®¡æ¶æ„ | ğŸ“‹ å·²ç¡®è®¤ |
| - | æ–‡æ¡£åŒ–äº¤æµè¿‡ç¨‹ | ğŸ“ å®Œæˆ |
| - | æ‰§è¡Œæ­¥éª¤1-8ï¼ˆåœºæ™¯Båç«¯å¼€å‘ï¼‰ | âœ… å®Œæˆ |

---

## ä¹ã€å‘½ä»¤æ‰§è¡Œç»“æœåˆ†æåŠŸèƒ½ï¼ˆV2.0ï¼‰

### 9.1 éœ€æ±‚èƒŒæ™¯

åˆå§‹å®ç°ä¸­ï¼ŒAIæ‰§è¡ŒSSHå‘½ä»¤åä»…è¿”å›"å‘½ä»¤å·²å‘é€åˆ°ç»ˆç«¯"ï¼Œæ— æ³•è·å–å‘½ä»¤çš„å®é™…æ‰§è¡Œç»“æœï¼Œä¹Ÿæ— æ³•å¯¹ç»“æœè¿›è¡Œåˆ†æã€‚è¿™å¯¼è‡´ï¼š

1. **AIæ— æ³•è·å–å‘½ä»¤è¾“å‡º**ï¼šAIçœ‹ä¸åˆ°å‘½ä»¤æ‰§è¡Œç»“æœï¼Œæ— æ³•è¿›è¡Œè¿›ä¸€æ­¥åˆ†æ
2. **å‰ç«¯çœ‹ä¸åˆ°è¾“å‡º**ï¼šç”¨æˆ·éœ€è¦åˆ‡æ¢åˆ°SSHç»ˆç«¯æŸ¥çœ‹ç»“æœ
3. **ç¼ºå°‘æ™ºèƒ½åˆ†æ**ï¼šAIæ— æ³•æ ¹æ®å‘½ä»¤è¾“å‡ºæä¾›è¿ç»´å»ºè®®

### 9.2 åŠŸèƒ½ç›®æ ‡

å®ç°å‘½ä»¤æ‰§è¡Œç»“æœçš„å®Œæ•´é“¾è·¯ï¼š

```
AIæ‰§è¡Œå‘½ä»¤ â†’ å‘é€åˆ°SSH â†’ æ•è·è¾“å‡º â†’ å®æ—¶æ¨é€å‰ç«¯
                                              â†“
                                         AIåˆ†æè¾“å‡º â†’ æ¨é€åˆ†æç»“æœ
```

### 9.3 è®¾è®¡æ–¹æ¡ˆï¼šå‘½ä»¤IDå…³è”æœºåˆ¶

#### æ ¸å¿ƒæ€è·¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å‘½ä»¤æ‰§è¡Œæµç¨‹                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. AIå†³å®šæ‰§è¡Œå‘½ä»¤ â†’ ç”Ÿæˆ commandId (æ—¶é—´æˆ³)                              â”‚
â”‚     â†“                                                                       â”‚
â”‚  2. æ³¨å†Œå‘½ä»¤ä¸Šä¸‹æ–‡: CommandContext{commandId, aiSessionId, sshSessionId}    â”‚
â”‚     â†“                                                                       â”‚
â”‚  3. å‘é€å‘½ä»¤åˆ°SSH (å¸¦èµ·æ­¢æ ‡è®°)                                             â”‚
â”‚     â”œâ”€â”€ ## COMMAND_START: {timestamp} ##                                  â”‚
â”‚     â”œâ”€â”€ {command}                                                        â”‚
â”‚     â””â”€â”€ echo '## COMMAND_END: {timestamp} ##'                           â”‚
â”‚     â†“                                                                       â”‚
â”‚  4. SSHè¾“å‡ºè¿”å›æ—¶ â†’ é€šè¿‡å‘½ä»¤IDå…³è”                                       â”‚
â”‚     â”œâ”€â”€ å®æ—¶æ¨é€ç»™å‰ç«¯ (command_output)                                  â”‚
â”‚     â”œâ”€â”€ ç¼“å­˜åˆ° CommandContext                                            â”‚
â”‚     â””â”€â”€ æ£€æµ‹ COMMAND_END æ ‡è®°                                            â”‚
â”‚     â†“                                                                       â”‚
â”‚  5. å‘½ä»¤å®Œæˆ â†’ è§¦å‘AIåˆ†æ                                                  â”‚
â”‚     â”œâ”€â”€ æ¨é€å®Œæˆæ¶ˆæ¯ (command_complete)                                   â”‚
â”‚     â”œâ”€â”€ å¼‚æ­¥è°ƒç”¨AIåˆ†æè¾“å‡º                                                â”‚
â”‚     â””â”€â”€ æ¨é€åˆ†æç»“æœ (reply)                                               â”‚
â”‚     â†“                                                                       â”‚
â”‚  6. æ¸…ç†å‘½ä»¤ä¸Šä¸‹æ–‡ (å»¶è¿Ÿ5ç§’)                                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¶æ„ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ–°å¢ç»„ä»¶                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  CommandContext (å‘½ä»¤ä¸Šä¸‹æ–‡å®ä½“)                                      â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ commandId: String        (å‘½ä»¤å”¯ä¸€æ ‡è¯† - æ—¶é—´æˆ³)                   â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ aiSessionId: String      (AIä¼šè¯ID)                               â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ sshSessionId: String     (SSHä¼šè¯ID)                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ command: String          (æ‰§è¡Œçš„å‘½ä»¤)                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ output: StringBuilder    (å‘½ä»¤è¾“å‡ºç¼“å­˜)                           â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ startTime: Long          (å¼€å§‹æ—¶é—´)                                â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ status: CommandStatus    (æ‰§è¡ŒçŠ¶æ€)                               â”‚    â”‚
â”‚  â”‚  â””â”€â”€ timeoutMillis: Long      (è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤5ç§’)                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â†“ ç®¡ç†å‘½ä»¤ä¸Šä¸‹æ–‡                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  CommandContextManager (å‘½ä»¤ä¸Šä¸‹æ–‡ç®¡ç†å™¨)                            â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ registerCommand()   æ³¨å†Œå‘½ä»¤                                    â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ appendOutput()       è¿½åŠ è¾“å‡ºåˆ°ç¼“å­˜                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ completeCommand()    æ ‡è®°å‘½ä»¤å®Œæˆ                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ handleTimeout()      å¤„ç†å‘½ä»¤è¶…æ—¶                                â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ cleanup()            æ¸…ç†å‘½ä»¤ä¸Šä¸‹æ–‡                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ pushOutputToFrontend() å®æ—¶æ¨é€è¾“å‡ºç»™å‰ç«¯                       â”‚    â”‚
â”‚  â”‚  â””â”€â”€ triggerAiAnalysis()   å¼‚æ­¥è§¦å‘AIåˆ†æ                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  CommandTimeoutScheduler (è¶…æ—¶å®šæ—¶ä»»åŠ¡)                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ @Scheduled(fixedDelay=1000)  æ¯1ç§’æ£€æŸ¥è¶…æ—¶                      â”‚    â”‚
â”‚  â”‚  â””â”€â”€ éå†æ‰€æœ‰EXECUTINGçŠ¶æ€çš„å‘½ä»¤ï¼Œæ£€æŸ¥æ˜¯å¦è¶…æ—¶                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  AsyncConfig (å¼‚æ­¥é…ç½®)                                               â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ @EnableAsync                                                       â”‚    â”‚
â”‚  â”‚  â””â”€â”€ commandAnalysisExecutor (çº¿ç¨‹æ± : 2æ ¸å¿ƒ, 5æœ€å¤§, 100é˜Ÿåˆ—)         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.4 å®Œæ•´äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·: "å¸®æˆ‘æŸ¥çœ‹CPUä½¿ç”¨ç‡"                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AiSshAssistantService.sendMessage()                                           â”‚
â”‚  â”œâ”€â”€ è·å–ç»‘å®šå…³ç³» (aiSessionId â†” sshSessionId â†” agentId)                        â”‚
â”‚  â”œâ”€â”€ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° Redis                                                          â”‚
â”‚  â”œâ”€â”€ æ„å»ºAIä¸Šä¸‹æ–‡ (ç³»ç»Ÿæç¤ºè¯ + ä¸»æœºä¿¡æ¯ + å†å²æ¶ˆæ¯)                            â”‚
â”‚  â””â”€â”€ è®¾ç½® ThreadLocal ä¸Šä¸‹æ–‡:                                                    â”‚
â”‚      â”œâ”€â”€ SshSessionContext.setSshSessionId(sshSessionId)                        â”‚
â”‚      â”œâ”€â”€ SshSessionContext.setAgentId(agentId)                                â”‚
â”‚      â””â”€â”€ SshSessionContext.setAiSessionId(aiSessionId)  â† æ–°å¢                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIå¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼Œå†³å®šè°ƒç”¨å·¥å…·                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  SshExecuteTool.executeCommand("top -n 1")                               â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ ä» ThreadLocal è·å–ä¸Šä¸‹æ–‡                                          â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ sshSessionId = SshSessionContext.getSshSessionId()           â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€ aiSessionId = SshSessionContext.getAiSessionId()               â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ CommandContextManager.registerCommand()                           â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ ç”Ÿæˆ commandId = UUID.randomUUID().toString()              â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ ç”Ÿæˆæ—¶é—´æˆ³ timestamp = System.currentTimeMillis()          â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€ å­˜å‚¨åˆ° commandMap å’Œ activeCommands                             â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ å‘é€å‘½ä»¤åˆ°SSH OutputStream                                           â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ "\n## COMMAND_START: " + timestamp + " ##\n"                   â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ command + "\n"                                                â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€ "echo '## COMMAND_END: " + timestamp + " ##'\n"              â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â””â”€ è¿”å›: "æ­£åœ¨æ‰§è¡Œå‘½ä»¤: top -n 1 (å‘½ä»¤ID: abc-123...)"                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SSHè¾“å‡ºè¿”å› â†’ SshWebSocketHandler.sendToWebSocket()                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ£€æµ‹æ˜¯å¦æœ‰å…³è”çš„AIå‘½ä»¤ (é€šè¿‡ sshSessionId)                                 â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ CommandContextManager.appendOutput(sshSessionId, output)        â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ è¿½åŠ è¾“å‡ºåˆ° CommandContext.output                            â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€ æ¨é€: WsChatMessage("command_output", output) â†’ å‰ç«¯        â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â””â”€ æ£€æµ‹ COMMAND_END æ ‡è®°                                                 â”‚    â”‚
â”‚  â”‚        â”‚                                                                  â”‚    â”‚
â”‚  â”‚        â””â”€ CommandContextManager.completeCommand(sshSessionId)         â”‚    â”‚
â”‚  â”‚            â”œâ”€â”€ æ ‡è®°çŠ¶æ€ä¸º COMPLETED                                       â”‚    â”‚
â”‚  â”‚            â”œâ”€â”€ ä» activeCommands ç§»é™¤                                   â”‚    â”‚
â”‚  â”‚            â”œâ”€â”€ æ¨é€: WsChatMessage("command_complete")                   â”‚    â”‚
â”‚  â”‚            â””â”€â”€ @Async triggerAiAnalysis(context)                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼‚æ­¥AIåˆ†æ (commandAnalysisExecutor çº¿ç¨‹æ± )                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  AiSshAssistantService.analyzeCommandOutput(command, output)            â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ æ„å»ºåˆ†æ prompt:                                                     â”‚    â”‚
â”‚  â”‚    â”‚   "è¯·åˆ†æä»¥ä¸‹å‘½ä»¤çš„æ‰§è¡Œç»“æœ..."                                     â”‚    â”‚
â”‚  â”‚    â”‚   "## å‘½ä»¤: top -n 1"                                               â”‚    â”‚
â”‚  â”‚    â”‚   "## è¾“å‡º: ..."                                                   â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ ç›´æ¥è°ƒç”¨ AI æ¨¡å‹ (ä¸ä½¿ç”¨ Assistantï¼Œé¿å…å¾ªç¯å·¥å…·è°ƒç”¨)              â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ SystemMessage: ç³»ç»Ÿæç¤ºè¯                                     â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€ UserMessage: åˆ†æ prompt                                     â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â””â”€ è¿”å›åˆ†æç»“æœ                                                        â”‚    â”‚
â”‚  â”‚       "æ ¹æ®å‘½ä»¤è¾“å‡ºåˆ†æï¼šCPUä½¿ç”¨ç‡ä¸º35%ï¼Œå†…å­˜ä½¿ç”¨ç‡ä¸º60%ï¼Œ"                â”‚    â”‚
â”‚  â”‚       "å½“å‰æœ‰3ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œè´Ÿè½½æ­£å¸¸..."                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚    â”‚                                                                      â”‚    â”‚
â”‚    â””â”€ AiSshAssistantManager.sendReply(aiSessionId, analysis)               â”‚
â”‚        â””â”€ æ¨é€: WsChatMessage("reply", åˆ†æç»“æœ) â†’ å‰ç«¯                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å»¶è¿Ÿæ¸…ç† (5ç§’å)                                                                 â”‚
â”‚  â””â”€ CommandContextManager.cleanup(commandId)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.5 WebSocketæ¶ˆæ¯åè®®æ‰©å±•

| æ¶ˆæ¯ç±»å‹ | æ–¹å‘ | è¯´æ˜ | ç¤ºä¾‹å†…å®¹ |
|---------|------|------|----------|
| `command_output` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | å‘½ä»¤å®æ—¶è¾“å‡º | SSHè¾“å‡ºçš„åŸå§‹å†…å®¹ |
| `command_complete` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | å‘½ä»¤æ‰§è¡Œå®Œæˆ | "å‘½ä»¤æ‰§è¡Œå®Œæˆ" |
| `command_timeout` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | å‘½ä»¤æ‰§è¡Œè¶…æ—¶ | "å‘½ä»¤æ‰§è¡Œè¶…æ—¶" |
| `reply` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | AIåˆ†æç»“æœ | "æ ¹æ®å‘½ä»¤è¾“å‡ºåˆ†æï¼šCPUä½¿ç”¨ç‡ä¸º35%..." |

### 9.6 è¶…æ—¶å¤„ç†æœºåˆ¶

```
CommandTimeoutScheduler (æ¯1ç§’æ‰§è¡Œ)
â”œâ”€â”€ éå†æ‰€æœ‰ EXECUTING çŠ¶æ€çš„å‘½ä»¤
â”œâ”€â”€ æ£€æŸ¥: System.currentTimeMillis() - startTime > timeoutMillis
â”œâ”€â”€ è¶…æ—¶åˆ™:
â”‚   â”œâ”€â”€ æ ‡è®°çŠ¶æ€ä¸º TIMEOUT
â”‚   â”œâ”€â”€ ä» activeCommands ç§»é™¤
â”‚   â”œâ”€â”€ æ¨é€: WsChatMessage("command_timeout")
â”‚   â””â”€â”€ ä»ç„¶è§¦å‘ AI åˆ†æ (åŸºäºå·²æ”¶é›†çš„è¾“å‡º)
â””â”€â”€ æœªè¶…æ—¶åˆ™ç»§ç»­ç­‰å¾…
```

### 9.7 æ–°å¢æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `ai/command/CommandStatus.java` | å‘½ä»¤çŠ¶æ€æšä¸¾ï¼ˆEXECUTING, COMPLETED, TIMEOUT, ERRORï¼‰ |
| `ai/command/CommandContext.java` | å‘½ä»¤ä¸Šä¸‹æ–‡å®ä½“ç±» |
| `ai/command/CommandContextManager.java` | å‘½ä»¤ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰ |
| `ai/command/CommandTimeoutScheduler.java` | å‘½ä»¤è¶…æ—¶å®šæ—¶ä»»åŠ¡ |
| `ai/config/AsyncConfig.java` | å¼‚æ­¥é…ç½®ç±»ï¼ˆå‘½ä»¤åˆ†æçº¿ç¨‹æ± ï¼‰ |

### 9.8 ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨å†…å®¹ |
|------|----------|
| `ai/context/SshSessionContext.java` | æ–°å¢ `aiSessionId` ThreadLocal å­—æ®µ |
| `ai/service/AiSshAssistantService.java` | æ–°å¢ `analyzeCommandOutput()` æ–¹æ³• |
| `ai/tools/SshExecuteTool.java` | é›†æˆå‘½ä»¤ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œå‘é€æ—¶é—´æˆ³æ ‡è®° |
| `websocket/SshWebSocketHandler.java` | å…³è”å‘½ä»¤è¾“å‡ºåˆ°ä¸Šä¸‹æ–‡ |
| `ai/websocket/manager/AiSshAssistantManager.java` | æ–°å¢ `sendReply()` æ–¹æ³• |

### 9.9 æŠ€æœ¯è¦ç‚¹

#### 1. ThreadLocal ä¸Šä¸‹æ–‡ä¼ é€’

```java
// AiSshAssistantService.sendMessage() ä¸­è®¾ç½®
SshSessionContext.setAiSessionId(binding.getAiSessionId());

// SshExecuteTool.executeCommand() ä¸­è·å–
String aiSessionId = SshSessionContext.getAiSessionId();
String sshSessionId = SshSessionContext.getSshSessionId();
```

#### 2. å‘½ä»¤æ ‡è®°æ ¼å¼

```bash
# ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºæ ‡è®°ï¼Œé¿å…å†²çª
## COMMAND_START: 1738657200000 ##
<command>
## COMMAND_END: 1738657200000 ##
```

#### 3. ä¸²è¡Œæ‰§è¡Œä¿è¯

```java
// ä¸€ä¸ªSSHä¼šè¯åŒæ—¶åªæ‰§è¡Œä¸€ä¸ªå‘½ä»¤
private final ConcurrentHashMap<String, String> activeCommands = new ConcurrentHashMap<>();
// key: sshSessionId, value: commandId
```

#### 4. å¼‚æ­¥åˆ†æé…ç½®

```java
@Configuration
@EnableAsync
public class AsyncConfig {
    @Bean(name = "commandAnalysisExecutor")
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(2);
        executor.setMaxPoolSize(5);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("cmd-analysis-");
        executor.initialize();
        return executor;
    }
}
```

### 9.10 éªŒè¯æ£€æŸ¥é¡¹

| æ£€æŸ¥é¡¹ | è¯´æ˜ |
|--------|------|
| 1. ç¼–è¯‘éªŒè¯ | `mvn clean compile` æˆåŠŸ |
| 2. å‘½ä»¤æ³¨å†Œ | commandId æ­£ç¡®ç”Ÿæˆå’Œå­˜å‚¨ |
| 3. è¾“å‡ºå…³è” | SSHè¾“å‡ºæ­£ç¡®å…³è”åˆ°å‘½ä»¤ä¸Šä¸‹æ–‡ |
| 4. å®æ—¶æ¨é€ | command_output æ¶ˆæ¯å®æ—¶æ¨é€ |
| 5. å®Œæˆæ£€æµ‹ | COMMAND_END æ ‡è®°æ­£ç¡®æ£€æµ‹ |
| 6. å¼‚æ­¥åˆ†æ | AIåˆ†ææ­£ç¡®è§¦å‘å’Œæ‰§è¡Œ |
| 7. è¶…æ—¶å¤„ç† | è¶…æ—¶å‘½ä»¤æ­£ç¡®å¤„ç† |
| 8. ä¸Šä¸‹æ–‡æ¸…ç† | å‘½ä»¤ä¸Šä¸‹æ–‡æ­£ç¡®æ¸…ç† |

### 9.11 å¼€å‘æäº¤è®°å½•

| æäº¤ | è¯´æ˜ | æ—¥æœŸ |
|------|------|------|
| bbeaf6c | é‡æ„AIæ¨¡å—ï¼šåœºæ™¯åˆ†ç¦»ä¸å·¥å…·è°ƒç”¨ä¼˜åŒ– | 2025-02-04 |
| bc065c6 | å®ç°AIå‘½ä»¤æ‰§è¡Œç»“æœåˆ†æåŠŸèƒ½ | 2025-02-04 |
| e0f5c1a | æ›´æ–°AIåŠ©æ‰‹ç»ˆç«¯å¼€å‘è®°å½•ï¼šæ·»åŠ å‘½ä»¤æ‰§è¡Œç»“æœåˆ†æåŠŸèƒ½äº¤äº’è¿‡ç¨‹ | 2025-02-05 |

---

## åã€æµ‹è¯•å¼€å‘ï¼ˆV2.1ï¼‰

### 10.1 æµ‹è¯•ç­–ç•¥

é‡‡ç”¨**ä»ç®€å•åˆ°å¤æ‚**çš„æµ‹è¯•å¼€å‘ç­–ç•¥ï¼Œä¾æ¬¡æµ‹è¯•ï¼š
1. å®ä½“ç±»
2. ThreadLocalä¸Šä¸‹æ–‡
3. Managerå±‚
4. Serviceå±‚
5. é›†æˆæµ‹è¯•ï¼ˆçœŸå®AIæ¨¡å‹ï¼‰
6. åŠŸèƒ½æµ‹è¯•ï¼ˆç«¯åˆ°ç«¯ï¼‰

### 10.2 æµ‹è¯•ç”¨ä¾‹å¼€å‘

#### æ­¥éª¤1: å®ä½“ç±»æµ‹è¯• - CommandContextTest

**æ–‡ä»¶**: `src/test/java/com/hundred/monitor/server/ai/command/CommandContextTest.java`

**æµ‹è¯•æ•°é‡**: 13ä¸ª

**æµ‹è¯•è¦†ç›–**:
- æ— å‚æ„é€ å‡½æ•°
- Builderæ¨¡å¼
- Getter/Setteræ–¹æ³•
- è¶…æ—¶æ£€æµ‹ï¼ˆisTimeoutï¼‰
- è¾“å‡ºç®¡ç†
- çŠ¶æ€è½¬æ¢

**ä¿®å¤é—®é¢˜**:
```java
// é—®é¢˜ï¼šLombok @Builder.Default åˆå§‹åŒ–é›†åˆä¸ºç©ºå­—ç¬¦ä¸²è€Œénull
// ä¿®å¤ï¼šä¿®æ”¹æ–­è¨€
assertThat(context.getOutput()).isEqualTo(""); // åŸä¸º assertNull()
```

**ç»“æœ**: âœ… 13/13 é€šè¿‡

---

#### æ­¥éª¤2: ThreadLocalæµ‹è¯• - SshSessionContextTest

**æ–‡ä»¶**: `src/test/java/com/hundred/monitor/server/ai/context/SshSessionContextTest.java`

**æµ‹è¯•æ•°é‡**: 11ä¸ª

**æµ‹è¯•è¦†ç›–**:
- aiSessionId å­—æ®µè®¾ç½®å’Œè·å–
- sshSessionId å­—æ®µè®¾ç½®å’Œè·å–
- agentId å­—æ®µè®¾ç½®å’Œè·å–
- clear() æ–¹æ³•æ¸…ç†
- å¤šçº¿ç¨‹å˜é‡ç‹¬ç«‹æ€§

**ç»“æœ**: âœ… 11/11 é€šè¿‡

---

#### æ­¥éª¤3: Manageræµ‹è¯• - AiSshAssistantManagerTest

**æ–‡ä»¶**: `src/test/java/com/hundred/monitor/server/ai/websocket/manager/AiSshAssistantManagerTest.java`

**æµ‹è¯•æ•°é‡**: 20ä¸ª

**æµ‹è¯•è¦†ç›–**:
- ä¼šè¯æ·»åŠ å’Œç§»é™¤
- æ¶ˆæ¯å‘é€
- å¹¿æ’­åŠŸèƒ½
- ä¼šè¯æ¸…ç†
- Mock WebSocketä¼šè¯

**ä¿®å¤é—®é¢˜**:
```java
// é—®é¢˜ï¼šMockito UnnecessaryStubbingException
// åŸå› ï¼šsetUp() ä¸­çš„stubbingæœªè¢«æ‰€æœ‰æµ‹è¯•ä½¿ç”¨
// ä¿®å¤ï¼šæ·»åŠ  @MockitoSettings(strictness = Strictness.LENIENT)
@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.LENIENT)
class AiSshAssistantManagerTest { ... }
```

**ç»“æœ**: âœ… 20/20 é€šè¿‡

---

#### æ­¥éª¤4: å‘½ä»¤ä¸Šä¸‹æ–‡ç®¡ç†æµ‹è¯• - CommandContextManagerTest

**æ–‡ä»¶**: `src/test/java/com/hundred/monitor/server/ai/command/CommandContextManagerTest.java`

**æµ‹è¯•æ•°é‡**: 22ä¸ª

**æµ‹è¯•è¦†ç›–**:
- å‘½ä»¤æ³¨å†Œ
- è¾“å‡ºè¿½åŠ 
- å‘½ä»¤å®Œæˆ
- è¶…æ—¶å¤„ç†
- æ¸…ç†åŠŸèƒ½

**ä¿®å¤é—®é¢˜**:
```java
// é—®é¢˜1ï¼šç±»å‹ä¸åŒ¹é…
// String commandId = commandContextManager.getCommand(...);
// ä¿®å¤ï¼šCommandContext command = commandContextManager.getCommand(...);

// é—®é¢˜2ï¼šéªŒè¯æ¬¡æ•°é”™è¯¯
// verify(aiSshRedisUtils).addMessage(...)  // æœŸæœ›1æ¬¡ï¼Œå®é™…2æ¬¡
// ä¿®å¤ï¼šverify(aiSshRedisUtils, times(2)).addMessage(...)
```

**ç»“æœ**: âœ… 22/22 é€šè¿‡

---

#### æ­¥éª¤5: Serviceå±‚æµ‹è¯• - AiSshAssistantServiceTest

**æ–‡ä»¶**: `src/test/java/com/hundred/monitor/server/ai/service/AiSshAssistantServiceTest.java`

**æµ‹è¯•æ•°é‡**: 13ä¸ª

**æµ‹è¯•è¦†ç›–**:
- sendMessage
- getMessages
- clearMessages
- analyzeCommandOutput é”™è¯¯å¤„ç†

**ä¿®å¤é—®é¢˜**:
```java
// é—®é¢˜ï¼š@InjectMocks æ— æ³•æ‰‹åŠ¨æ³¨å…¥ä¾èµ–
// ä¿®å¤ï¼šæ‰‹åŠ¨è®¾ç½®mockå¯¹è±¡
AiSshAssistantService service = new AiSshAssistantService();
ReflectionTestUtils.setField(service, "terminalChatRedisUtils", mockRedisUtils);
// ... å…¶ä»–ä¾èµ–
```

**ç»“æœ**: âœ… 13/13 é€šè¿‡

---

#### æ­¥éª¤6: é›†æˆæµ‹è¯• - AiSshAssistantServiceIntegrationTest

**æ–‡ä»¶**: `src/test/java/com/hundred/monitor/server/ai/service/AiSshAssistantServiceIntegrationTest.java`

**æµ‹è¯•æ•°é‡**: 9ä¸ª

**æµ‹è¯•ç¯å¢ƒ**:
```properties
ai.monitor-agent.default-model-name=ollama
langchain4j.ollama.chat-model.base-url=http://localhost:11434/v1
langchain4j.ollama.chat-model.model-name=qwen2.5:7b
```

**æµ‹è¯•è¦†ç›–**:
1. ç®€å•é—®å€™
2. æŠ€æœ¯é—®é¢˜ï¼ˆç£ç›˜ä½¿ç”¨å‘½ä»¤ï¼‰
3. å¤šè½®å¯¹è¯ï¼ˆä¸Šä¸‹æ–‡è®°å¿†ï¼‰
4. æ¶ˆæ¯å†å²ä¿å­˜
5. æ¸…é™¤æ¶ˆæ¯
6. ä¸å­˜åœ¨ä¼šè¯å¼‚å¸¸å¤„ç†
7. å“åº”æ—¶é—´
8. å‘½ä»¤è¾“å‡ºåˆ†æ
9. ThreadLocalæ¸…ç†

**ä¿®å¤é—®é¢˜**:

| é—®é¢˜ | åŸå›  | ä¿®å¤æ–¹æ¡ˆ |
|------|------|----------|
| 404 page not found | baseUrlç¼ºå°‘`/v1`è·¯å¾„ | æ”¹ä¸º`http://localhost:11434/v1` |
| HTTPå®¢æˆ·ç«¯å†²çª | å¤šä¸ªHTTPå®¢æˆ·ç«¯å®ç°å†²çª | æ·»åŠ `.httpClientBuilder(new JdkHttpClientBuilder())` |
| å‚æ•°æ³¨è§£é”™è¯¯ | LangChain4jæ³¨è§£ä¸æ­£ç¡® | æ·»åŠ `@UserMessage`å’Œ`@V("systemPrompt")` |
| å·¥å…·ä¸æ”¯æŒ | gemma3:4bä¸æ”¯æŒFunction Calling | åˆ‡æ¢åˆ°qwen2.5:7bæ¨¡å‹ |
| å¾ªç¯ä¾èµ– | commandContextManager â†” aiSshAssistantService | æ·»åŠ `@Lazy`æ³¨è§£ |

**ä»£ç ä¿®å¤**:

**1. application.yamlé…ç½®**
```yaml
langchain4j:
  ollama:
    chat-model:
      base-url: http://localhost:11434/v1  # æ·»åŠ  /v1 è·¯å¾„
      model-name: gemma3:4b  # æˆ– qwen2.5:7b
```

**2. AgentAssistantConfig.java**
```java
@Bean
public OpenAiChatModel getOllamaAiChatModel() {
    return OpenAiChatModel.builder()
            .modelName(agentOllamaChatModelAssistantProperty.getModelName())
            .baseUrl(agentOllamaChatModelAssistantProperty.getBaseUrl())
            .httpClientBuilder(new JdkHttpClientBuilder())  // æ·»åŠ 
            .build();
}
```

**3. Assistant.java**
```java
public interface Assistant {
    @SystemMessage("You are a helpful assistant.")
    String chat(@UserMessage String userMessage);

    @SystemMessage("{{systemPrompt}}")
    String chat(@V("systemPrompt") String systemPrompt,
                @UserMessage String userMessage);
}
```

**4. CommandContextManager.java**
```java
@Resource
@Lazy  // æ·»åŠ ï¼Œæ‰“ç ´å¾ªç¯ä¾èµ–
private AiSshAssistantService aiSshAssistantService;
```

**ç»“æœ**: âœ… 9/9 é€šè¿‡

---

#### æ­¥éª¤7: åŠŸèƒ½æµ‹è¯• - AiSshTaskExecuteTest

**æ–‡ä»¶**: `src/test/java/com/hundred/monitor/server/ai/service/AiSshTaskExecuteTest.java`

**æµ‹è¯•ç›®çš„**: éªŒè¯å®Œæ•´çš„SSHå‘½ä»¤æ‰§è¡Œå’ŒAIåˆ†ææµç¨‹

**æµ‹è¯•æµç¨‹**:
```
1. SSHè¿æ¥ (agent-001, hundred, 100000100ce.)
   â†“
2. åˆ›å»ºAIä¼šè¯ç»‘å®š
   â†“
3. AIå‘é€æ¶ˆæ¯: "è¯·æ‰§è¡Œlså‘½ä»¤å¹¶æŸ¥çœ‹å½“å‰ç›®å½•çš„æ–‡ä»¶åˆ—è¡¨"
   â†“
4. AIè°ƒç”¨SshExecuteToolæ‰§è¡Œlså‘½ä»¤
   â†“
5. æ¨¡æ‹ŸSSHè¾“å‡º: "Desktop  Documents  Downloads..."
   â†“
6. è§¦å‘AIåˆ†æ
   â†“
7. éªŒè¯æ¶ˆæ¯å†å²åŒ…å«AIåˆ†æç»“æœ
```

**ä¿®å¤é—®é¢˜**:

| é—®é¢˜ | åŸå›  | ä¿®å¤æ–¹æ¡ˆ |
|------|------|----------|
| AIåˆ†æç»“æœæœªä¿å­˜ | triggerAiAnalysis()åªå‘é€WebSocketï¼Œæœªä¿å­˜åˆ°Redis | æ·»åŠ `terminalChatRedisUtils.addMessage()` |

**CommandContextManagerä¿®å¤**:
```java
@Async("commandAnalysisExecutor")
public void triggerAiAnalysis(CommandContext context) {
    try {
        String analysis = aiSshAssistantService.analyzeCommandOutput(
                context.getCommand(),
                context.getOutput()
        );

        // ä¿å­˜AIåˆ†æç»“æœåˆ°æ¶ˆæ¯å†å²
        SshAssistantMessage aiMsg = SshAssistantMessage.builder()
                .role("assistant")
                .content(analysis)
                .timestamp(Instant.now().toEpochMilli())
                .build();
        terminalChatRedisUtils.addMessage(context.getAiSessionId(), aiMsg);

        // æ¨é€åˆ†æç»“æœç»™å‰ç«¯ï¼ˆWebSocketï¼‰
        aiSshAssistantManager.sendReply(context.getAiSessionId(), analysis);
    } catch (Exception e) {
        // ... é”™è¯¯å¤„ç†ä¹Ÿä¿å­˜åˆ°å†å²
    }
}
```

**æµ‹è¯•ç»“æœ**:
```
========== æ¶ˆæ¯å†å² ==========
[user] è¯·æ‰§è¡Œlså‘½ä»¤å¹¶æŸ¥çœ‹å½“å‰ç›®å½•çš„æ–‡ä»¶åˆ—è¡¨
[assistant] æˆ‘å·²ç»ä¸ºæ‚¨æ‰§è¡Œäº† `ls` å‘½ä»¤...
[assistant] ### å‘½ä»¤åˆ†æ
1. **æ‰§è¡ŒçŠ¶æ€**ï¼šå‘½ä»¤ `ls` æˆåŠŸæ‰§è¡Œ
2. **å…³é”®ä¿¡æ¯**ï¼šDesktop, Documents, Downloads, Music, Pictures...
3. **å¼‚å¸¸æƒ…å†µ**ï¼šæœªå‘ç°ä»»ä½•è­¦å‘Šæˆ–é”™è¯¯ä¿¡æ¯
4. **å»ºè®®**ï¼šå»ºè®®å®šæœŸæ¸…ç†è¿™äº›ç›®å½•ä»¥æé«˜ç³»ç»Ÿæ€§èƒ½
==============================

æµ‹è¯•ç»“æœ: âœ… é€šè¿‡
æ¶ˆæ¯æ€»æ•°: 3ï¼ˆä¹‹å‰æ˜¯2ï¼‰
æœ€åä¸€æ¡æ¶ˆæ¯åŒ…å«åˆ†æ: true
```

**ç»“æœ**: âœ… é€šè¿‡

### 10.3 æµ‹è¯•ç”¨ä¾‹ç»Ÿè®¡

| æµ‹è¯•ç±» | æµ‹è¯•æ•°é‡ | çŠ¶æ€ |
|--------|---------|------|
| CommandContextTest | 13 | âœ… é€šè¿‡ |
| SshSessionContextTest | 11 | âœ… é€šè¿‡ |
| AiSshAssistantManagerTest | 20 | âœ… é€šè¿‡ |
| CommandContextManagerTest | 22 | âœ… é€šè¿‡ |
| AiSshAssistantServiceTest | 13 | âœ… é€šè¿‡ |
| AiSshAssistantServiceIntegrationTest | 9 | âœ… é€šè¿‡ |
| AiSshTaskExecuteTest | 1 | âœ… é€šè¿‡ |
| **æ€»è®¡** | **89** | **âœ… å…¨éƒ¨é€šè¿‡** |

### 10.4 é—®é¢˜ä¿®å¤æ±‡æ€»

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | å½±å“èŒƒå›´ | ä¿®å¤æ–¹æ¡ˆ |
|---------|---------|---------|----------|
| 1 | Lombok @Builder.Defaultè¡Œä¸º | CommandContextTest | ä¿®æ”¹æ–­è¨€é¢„æœŸ |
| 2 | Mockito UnnecessaryStubbingException | AiSshAssistantManagerTest | æ·»åŠ @MockitoSettings(strictness=LENIENT) |
| 3 | ç±»å‹ä¸åŒ¹é… | CommandContextManagerTest | ä¿®æ”¹å˜é‡ç±»å‹ |
| 4 | éªŒè¯æ¬¡æ•°é”™è¯¯ | CommandContextManagerTest | ä½¿ç”¨times(2) |
| 5 | æ‰‹åŠ¨ä¾èµ–æ³¨å…¥ | AiSshAssistantServiceTest | ä½¿ç”¨ReflectionTestUtils |
| 6 | 404 page not found | é›†æˆæµ‹è¯• | baseUrlæ·»åŠ /v1 |
| 7 | HTTPå®¢æˆ·ç«¯å†²çª | é›†æˆæµ‹è¯• | æŒ‡å®šJdkHttpClientBuilder |
| 8 | LangChain4jæ³¨è§£é”™è¯¯ | é›†æˆæµ‹è¯• | æ·»åŠ @UserMessageå’Œ@Væ³¨è§£ |
| 9 | å·¥å…·ä¸æ”¯æŒ | é›†æˆæµ‹è¯• | åˆ‡æ¢åˆ°qwen2.5:7bæ¨¡å‹ |
| 10 | å¾ªç¯ä¾èµ– | è¿è¡Œæ—¶ | æ·»åŠ @Lazyæ³¨è§£ |
| 11 | AIåˆ†æç»“æœæœªä¿å­˜ | åŠŸèƒ½æµ‹è¯• | æ·»åŠ terminalChatRedisUtilsè°ƒç”¨ |

### 10.5 æŠ€æœ¯è¦ç‚¹æ€»ç»“

#### 1. LangChain4jä¸Ollamaé›†æˆ

```yaml
# application.yaml
langchain4j:
  ollama:
    chat-model:
      base-url: http://localhost:11434/v1  # å¿…é¡»åŒ…å«/v1
      model-name: qwen2.5:7b               # éœ€è¦æ”¯æŒå·¥å…·çš„æ¨¡å‹
```

**æ³¨æ„äº‹é¡¹**:
- Ollamaçš„OpenAIå…¼å®¹ç«¯ç‚¹: `/v1/chat/completions`
- baseUrléœ€è¦åŒ…å«ç‰ˆæœ¬è·¯å¾„: `http://localhost:11434/v1`
- æ¨¡å‹éœ€è¦æ”¯æŒFunction Callingå·¥å…·è°ƒç”¨

#### 2. LangChain4jå‚æ•°æ³¨è§£

```java
public interface Assistant {
    // ç”¨æˆ·æ¶ˆæ¯
    String chat(@UserMessage String userMessage);

    // å¸¦ç³»ç»Ÿæç¤ºè¯çš„å¯¹è¯
    @SystemMessage("{{systemPrompt}}")
    String chat(@V("systemPrompt") String systemPrompt,
                @UserMessage String userMessage);
}
```

#### 3. Springå¾ªç¯ä¾èµ–è§£å†³æ–¹æ¡ˆ

```java
@Component
public class CommandContextManager {
    @Resource
    @Lazy  // å»¶è¿ŸåŠ è½½ï¼Œæ‰“ç ´å¾ªç¯ä¾èµ–
    private AiSshAssistantService aiSshAssistantService;
}
```

#### 4. æ¶ˆæ¯å†å²ä¿å­˜æœºåˆ¶

AIåˆ†æç»“æœéœ€è¦åŒæ—¶ï¼š
1. ä¿å­˜åˆ°Redisæ¶ˆæ¯å†å²ï¼ˆä¾›å‰ç«¯åŠ è½½å†å²è®°å½•ï¼‰
2. é€šè¿‡WebSocketæ¨é€ç»™å‰ç«¯ï¼ˆå®æ—¶æ›´æ–°ï¼‰

```java
// 1. ä¿å­˜åˆ°å†å²
terminalChatRedisUtils.addMessage(aiSessionId, aiMessage);

// 2. WebSocketæ¨é€
aiSshAssistantManager.sendReply(aiSessionId, analysis);
```

### 10.6 å¼€å‘æäº¤è®°å½•

| æäº¤ | è¯´æ˜ | æ—¥æœŸ |
|------|------|------|
| bbeaf6c | é‡æ„AIæ¨¡å—ï¼šåœºæ™¯åˆ†ç¦»ä¸å·¥å…·è°ƒç”¨ä¼˜åŒ– | 2025-02-04 |
| bc065c6 | å®ç°AIå‘½ä»¤æ‰§è¡Œç»“æœåˆ†æåŠŸèƒ½ | 2025-02-04 |
| e0f5c1a | æ›´æ–°AIåŠ©æ‰‹ç»ˆç«¯å¼€å‘è®°å½•ï¼šæ·»åŠ å‘½ä»¤æ‰§è¡Œç»“æœåˆ†æåŠŸèƒ½äº¤äº’è¿‡ç¨‹ | 2025-02-05 |

---

## åä¸€ã€å‰ç«¯å¼€å‘å®Œæˆï¼ˆV2.2ï¼‰

### 11.1 å¼€å‘èƒŒæ™¯

åœ¨å®Œæˆåç«¯å¼€å‘å’Œæµ‹è¯•åï¼Œéœ€è¦å®ç°å‰ç«¯AIåŠ©æ‰‹åŠŸèƒ½ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿé€šè¿‡å›¾å½¢ç•Œé¢ä¸AIåŠ©æ‰‹äº¤äº’ã€‚

### 11.2 æŠ€æœ¯æ–¹æ¡ˆ

#### UIé›†æˆæ–¹æ¡ˆ

| æ–¹æ¡ˆ | æè¿° | é€‰æ‹© |
|------|------|------|
| A | åœ¨HostDetailDialogæ·»åŠ AIæŒ‰é’®ï¼Œå¼¹å‡ºå¯¹è¯æ¡† | âœ… é‡‡ç”¨ |
| B | ç‹¬ç«‹çš„AIåŠ©æ‰‹é¡µé¢ | âŒ |
| C | SSHç»ˆç«¯å†…åµŒAIé¢æ¿ | âŒ |
| D | SSHç»ˆç«¯å¯¹è¯æ¡†æ—æ·»åŠ AIæŒ‰é’®ï¼Œéæ¨¡æ€å¯¹è¯æ¡† | âœ… é‡‡ç”¨ |

**æœ€ç»ˆæ–¹æ¡ˆ**ï¼šåœ¨SSHç»ˆç«¯å¯¹è¯æ¡†ï¼ˆ`SshTerminalDialog.vue`ï¼‰ä¸­æ·»åŠ "AIåŠ©æ‰‹"æŒ‰é’®ï¼Œç‚¹å‡»åæ‰“å¼€éæ¨¡æ€å¯¹è¯æ¡†ï¼ˆ`AiAssistantDialog.vue`ï¼‰ï¼Œç”¨æˆ·å¯åŒæ—¶æ“ä½œSSHç»ˆç«¯å’ŒAIåŠ©æ‰‹ã€‚

#### ç»„ä»¶æ¶æ„

```
src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ ai.ts                 # AIç±»å‹å®šä¹‰
â”œâ”€â”€ api/
â”‚   â””â”€â”€ ai.ts                 # AI APIæ¥å£
â”œâ”€â”€ components/
â”‚   â””â”€â”€ ai/
â”‚       â”œâ”€â”€ ChatInterface.vue      # èŠå¤©ä¸»ç•Œé¢
â”‚       â”œâ”€â”€ ChatMessage.vue        # å•æ¡æ¶ˆæ¯ç»„ä»¶
â”‚       â”œâ”€â”€ ChatInput.vue          # æ¶ˆæ¯è¾“å…¥ç»„ä»¶
â”‚       â”œâ”€â”€ MarkdownRenderer.vue   # Markdownæ¸²æŸ“ç»„ä»¶
â”‚       â””â”€â”€ AiAssistantDialog.vue  # AIåŠ©æ‰‹å¯¹è¯æ¡†
â”œâ”€â”€ composables/
â”‚   â””â”€â”€ useAiChat.ts            # AIèŠå¤©çŠ¶æ€ç®¡ç†
```

### 11.3 å¼€å‘é˜¶æ®µ

#### é˜¶æ®µ1: åŸºç¡€è®¾æ–½

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `src/types/ai.ts` | AIç±»å‹å®šä¹‰ï¼ˆChatMessageã€WebSocketæ¶ˆæ¯ç­‰ï¼‰ |
| `src/api/ai.ts` | AI APIæ¥å£ï¼ˆconnectã€disconnectç­‰ï¼‰ |

#### é˜¶æ®µ2: åŸºç¡€ç»„ä»¶

| ç»„ä»¶ | åŠŸèƒ½ |
|------|------|
| `MarkdownRenderer.vue` | Markdownæ¸²æŸ“ + ä»£ç è¯­æ³•é«˜äº®ï¼ˆmarked + highlight.jsï¼‰ |
| `ChatMessage.vue` | å•æ¡æ¶ˆæ¯æ˜¾ç¤ºï¼ˆç”¨æˆ·/åŠ©æ‰‹/ç³»ç»Ÿè§’è‰²ï¼‰ |
| `ChatInput.vue` | æ¶ˆæ¯è¾“å…¥æ¡†ï¼ˆCtrl+Enterå‘é€ï¼‰ |
| `ChatInterface.vue` | èŠå¤©ä¸»ç•Œé¢å®¹å™¨ |

#### é˜¶æ®µ3: é›†æˆç»„ä»¶

| ç»„ä»¶ | åŠŸèƒ½ |
|------|------|
| `AiAssistantDialog.vue` | AIåŠ©æ‰‹å¯¹è¯æ¡†å®¹å™¨ï¼ˆéæ¨¡æ€ã€å¯æ‹–åŠ¨ï¼‰ |

#### é˜¶æ®µ4: é¡µé¢é›†æˆ

| ä¿®æ”¹ | è¯´æ˜ |
|------|------|
| `SshTerminalDialog.vue` | æ·»åŠ AIåŠ©æ‰‹æŒ‰é’®å’Œå¯¹è¯æ¡†é›†æˆ |

#### é˜¶æ®µ5: çŠ¶æ€ç®¡ç†

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `useAiChat.ts` | WebSocketè¿æ¥ç®¡ç†ã€æ¶ˆæ¯æ”¶å‘ã€çŠ¶æ€ç®¡ç† |

### 11.4 WebSocketé€šä¿¡

#### URLé…ç½®

```typescript
// ç¯å¢ƒå˜é‡é…ç½®
VITE_WS_BASE_URL=ws://localhost:8080

// WebSocket URLæ„å»º
buildWsUrl(aiSessionId) => `${VITE_WS_BASE_URL}/ws/ai/ssh-assistant/${aiSessionId}`
```

#### æ¶ˆæ¯åè®®

| ç±»å‹ | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| `chat` | å®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ | ç”¨æˆ·èŠå¤©æ¶ˆæ¯ |
| `reply` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | AIå›å¤ï¼ˆå«isCompleteå­—æ®µï¼‰ |
| `command_output` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | å‘½ä»¤å®æ—¶è¾“å‡º |
| `command_complete` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | å‘½ä»¤æ‰§è¡Œå®Œæˆï¼ˆå«exitCodeï¼‰ |
| `error` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | é”™è¯¯é€šçŸ¥ |
| `ping` | åŒå‘ | å¿ƒè·³ä¿æ´» |

### 11.5 é—®é¢˜ä¿®å¤è®°å½•

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | åŸå›  | ä¿®å¤æ–¹æ¡ˆ |
|---------|---------|------|----------|
| FE-001 | API 404é”™è¯¯ | ä½¿ç”¨`axios`è€Œé`request` | æ”¹ç”¨`request`ç»Ÿä¸€baseURL |
| FE-002 | WebSocketè¿æ¥å¤±è´¥ | URLä½¿ç”¨å‰ç«¯åœ°å€ï¼ˆ5173ï¼‰ | ä½¿ç”¨`VITE_WS_BASE_URL`ç¯å¢ƒå˜é‡ |
| FE-003 | åŠ è½½çŠ¶æ€ä¸æ¶ˆå¤± | æµå¼æ¶ˆæ¯æ›´æ–°é€»è¾‘é”™è¯¯ | ä¿®å¤`handleAiMessage`ï¼Œæ­£ç¡®å¤„ç†`isComplete` |
| FE-004 | disconnectæ¥å£401 | HTTPæ–¹æ³•ä¸åŒ¹é…ï¼ˆå‰ç«¯POSTï¼Œåç«¯DELETEï¼‰ | å‰ç«¯æ”¹ç”¨`request.delete` |
| FE-005 | marked v17 APIå˜æ›´ | `highlight`é€‰é¡¹å·²åºŸå¼ƒ | ä½¿ç”¨è‡ªå®šä¹‰renderer |

### 11.6 åˆ›å»ºæ–‡ä»¶æ¸…å•

```
Monitor-Web/src/

â”œâ”€â”€ types/ai.ts                          âœ… AIç±»å‹å®šä¹‰
â”œâ”€â”€ api/ai.ts                            âœ… AI APIæ¥å£
â”œâ”€â”€ composables/useAiChat.ts              âœ… WebSocketçŠ¶æ€ç®¡ç†
â”œâ”€â”€ components/ai/
â”‚   â”œâ”€â”€ ChatInterface.vue               âœ… èŠå¤©ä¸»ç•Œé¢
â”‚   â”œâ”€â”€ ChatMessage.vue                 âœ… å•æ¡æ¶ˆæ¯ç»„ä»¶
â”‚   â”œâ”€â”€ ChatInput.vue                   âœ… æ¶ˆæ¯è¾“å…¥æ¡†
â”‚   â”œâ”€â”€ MarkdownRenderer.vue            âœ… Markdownæ¸²æŸ“
â”‚   â””â”€â”€ AiAssistantDialog.vue           âœ… AIåŠ©æ‰‹å¯¹è¯æ¡†
â””â”€â”€ components/monitor/
    â””â”€â”€ SshTerminalDialog.vue           ğŸ”§ æ·»åŠ AIåŠ©æ‰‹æŒ‰é’®
```

### 11.7 æŠ€æœ¯è¦ç‚¹

#### 1. éæ¨¡æ€å¯¹è¯æ¡†é…ç½®

```vue
<el-dialog
  :modal="false"        â† ä¸æ˜¾ç¤ºé®ç½©
  append-to-body        â† æŒ‚è½½åˆ°body
  draggable             â† å¯æ‹–åŠ¨
>
```

#### 2. Markdownä»£ç é«˜äº®

```typescript
import { marked } from 'marked'
import hljs from 'highlight.js'

// ä½¿ç”¨è‡ªå®šä¹‰rendererï¼ˆmarked v17+ï¼‰
marked.use({
  renderer: {
    code(this: any, code: string, language: string | undefined) {
      const lang = language || ''
      if (hljs.getLanguage(lang)) {
        const highlighted = hljs.highlight(code, { language: lang }).value
        return `<pre><code class="hljs language-${lang}">${highlighted}</code></pre>`
      }
      const highlighted = hljs.highlightAuto(code).value
      return `<pre><code class="hljs">${highlighted}</code></pre>`
    }
  }
})
```

#### 3. æµå¼æ¶ˆæ¯å¤„ç†

```typescript
// æ›´æ–°ç°æœ‰æ¶ˆæ¯è€Œä¸æ˜¯åˆ›å»ºæ–°æ¶ˆæ¯
if (currentStreamingMessageId) {
  const existingMessage = messages.value.find(m => m.id === currentStreamingMessageId)
  if (existingMessage && !message.isStreaming) {
    existingMessage.content = message.content
    existingMessage.isStreaming = false
    isProcessing.value = false
    return
  }
}
```

### 11.8 æµ‹è¯•åœºæ™¯

| åœºæ™¯ | æ“ä½œ | é¢„æœŸç»“æœ |
|------|------|----------|
| è¿æ¥AIåŠ©æ‰‹ | æ‰“å¼€SSHç»ˆç«¯ â†’ ç‚¹å‡»"AIåŠ©æ‰‹"æŒ‰é’® | WebSocketè¿æ¥æˆåŠŸï¼ŒçŠ¶æ€æ æ˜¾ç¤º"å·²è¿æ¥" |
| å‘é€æ¶ˆæ¯ | è¾“å…¥"æŸ¥çœ‹å½“å‰ç›®å½•æ–‡ä»¶" | AIå›å¤åŒ…å«å®Œæ•´åˆ†æ |
| å¹¶è¡Œæ“ä½œ | AIæ‰§è¡Œå‘½ä»¤æ—¶æ‰‹åŠ¨è¾“å…¥SSHå‘½ä»¤ | ä¸¤ä¸ªçª—å£ç‹¬ç«‹æ“ä½œ |
| å…³é—­åŠ©æ‰‹ | ç‚¹å‡»å¯¹è¯æ¡†å…³é—­æŒ‰é’® | WebSocketæ–­å¼€ï¼Œä¸å½±å“SSHç»ˆç«¯ |

---

## åäºŒã€å·²çŸ¥é—®é¢˜ï¼ˆæœªè§£å†³ï¼‰

### é—®é¢˜è®°å½•

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | çŠ¶æ€ | å¤ç°æƒ…å†µ |
|---------|---------|------|----------|
| ISSUE-001 | AIå›å¤å†…å®¹æ˜¾ç¤ºä¸ä¸€è‡´ | âš ï¸ å¶å‘ | **æœªå¤ç°** |

#### ISSUE-001 è¯¦ç»†æè¿°

**é—®é¢˜ç°è±¡**ï¼š
- å‰ç«¯æ˜¾ç¤ºï¼šç®€çŸ­çš„"å‘½ä»¤æ‰§è¡Œåé¦ˆ"æ¶ˆæ¯
- åç«¯æ—¥å¿—ï¼šå®Œæ•´çš„åˆ†æå†…å®¹ï¼ˆåŒ…å«å…³é”®æ­¥éª¤ã€ç»“æœã€ç»“è®ºï¼‰

**å¤ç°æƒ…å†µ**ï¼š
- åœ¨åç»­æµ‹è¯•ä¸­æœªèƒ½å¤ç°
- å‰ç«¯èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºå®Œæ•´çš„AIå›å¤å†…å®¹

**å¯èƒ½åŸå› **ï¼š
1. å¯èƒ½æ˜¯å¶å‘çš„æ•°æ®ä¼ è¾“é—®é¢˜
2. å¯èƒ½æ˜¯ä¹‹å‰ç‰ˆæœ¬çš„å‰ç«¯å¤„ç†é€»è¾‘bugï¼ˆå·²ä¿®å¤ï¼‰
3. å¯èƒ½æ˜¯ç½‘ç»œæˆ–ä¸´æ—¶æ€§å› ç´ 

**å¤„ç†å»ºè®®**ï¼š
- ç»§ç»­è§‚å¯Ÿæ˜¯å¦èƒ½å¤ç°
- å¦‚æœèƒ½ç¨³å®šå¤ç°ï¼Œéœ€è¦æ”¶é›†æ›´å¤šæ—¥å¿—ä¿¡æ¯ï¼ˆå‰ç«¯console.log + åç«¯æ—¥å¿—ï¼‰
- å½“å‰ç‰ˆæœ¬åŠŸèƒ½æ­£å¸¸ï¼Œæš‚ä¸å¤„ç†

---

*æ–‡æ¡£æ›´æ–°æ—¶é—´ï¼š2026å¹´2æœˆ7æ—¥*
*æœ€åæ›´æ–°ï¼šæ¶æ„é‡æ„å®Œæˆï¼ˆV3.0ï¼‰- ä¾§è¾¹æ AIåŠ©æ‰‹è¿ç§»è‡³Monitor-AIç‹¬ç«‹æœåŠ¡*

---

## åä¸‰ã€ä¾§è¾¹æ AIåŠ©æ‰‹å¼€å‘å®Œæˆï¼ˆV2.3ï¼‰

### 13.1 å¼€å‘èƒŒæ™¯

åœ¨å®Œæˆä¸»æœºè¯¦æƒ…é¡µAIåŠ©æ‰‹ï¼ˆSSHç»‘å®šåœºæ™¯ï¼‰åï¼Œéœ€è¦å®ç°ä¾§è¾¹æ ç‹¬ç«‹AIåŠ©æ‰‹åŠŸèƒ½ï¼Œä¸ºç”¨æˆ·æä¾›é€šç”¨AIå¯¹è¯èƒ½åŠ›ï¼Œä¸ä¾èµ–SSHè¿æ¥ã€‚

### 13.2 åŠŸèƒ½å®šä½

| ç‰¹æ€§ | ä¸»æœºè¯¦æƒ…é¡µAIåŠ©æ‰‹ | ä¾§è¾¹æ AIåŠ©æ‰‹ |
|------|-----------------|-------------|
| **ä½ç½®** | ä¸»æœºè¯¦æƒ…é¡µ â†’ SSHç»ˆç«¯æ— | å…¨å±€ä¾§è¾¹æ èœå• |
| **è·¯ç”±** | æ— ï¼ˆåµŒå…¥å¯¹è¯æ¡†ï¼‰ | `/ai` |
| **é€šä¿¡æ–¹å¼** | WebSocketé•¿è¿æ¥ | HTTP REST API |
| **ä¼šè¯ç±»å‹** | å•ä¼šè¯ï¼ˆä¸SSHç»‘å®šï¼‰ | å¤šä¼šè¯ç®¡ç† |
| **ä¸»æœºå…³è”** | å¿…éœ€ | å¯é€‰ |
| **SSHå‘½ä»¤æ‰§è¡Œ** | æ”¯æŒ | ä¸æ”¯æŒ |
| **Controller** | AiSshAssistantController | ChatController |
| **Service** | AiSshAssistantService | ChatService |
| **Rediså‰ç¼€** | `ai:ssh:*` | `assistant:session:*` |
| **å¼€å‘çŠ¶æ€** | âœ… å·²å®Œæˆ | âœ… å·²å®Œæˆ |

### 13.3 æŠ€æœ¯æ–¹æ¡ˆ

#### 13.3.1 UIè®¾è®¡

å‚è€ƒä¸»æµAIå¯¹è¯åº”ç”¨ï¼ˆChatGPTã€Claudeï¼‰çš„è®¾è®¡æ¨¡å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¾§è¾¹æ é¢æ¿ (280px)     â”‚    ä¸»èŠå¤©åŒºåŸŸ (è‡ªé€‚åº”)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [æ–°å¯¹è¯] æŒ‰é’®     â”‚  â”‚  â”‚  æ¶ˆæ¯åˆ—è¡¨æ»šåŠ¨åŒº               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚ ä¼šè¯åˆ—è¡¨          â”‚  â”‚  â”‚  â”‚ ç”¨æˆ·: æŸ¥çœ‹ç£ç›˜ä½¿ç”¨     â”‚  â”‚  â”‚
â”‚  â”‚ â”œâ”€ å¯¹è¯1         â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚
â”‚  â”‚ â”œâ”€ å¯¹è¯2 (active)â”‚  â”‚  â”‚  â”‚ AI: ç£ç›˜ä½¿ç”¨æƒ…å†µå¦‚ä¸‹... â”‚  â”‚  â”‚
â”‚  â”‚ â””â”€ ...           â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚ [ä¼šè¯1] 2åˆ†é’Ÿå‰  â”‚  â”‚  â”‚  â”‚ ç”¨æˆ·: å†…å­˜ä½¿ç”¨ç‡ï¼Ÿ      â”‚  â”‚  â”‚
â”‚  â”‚ [Ã—åˆ é™¤]          â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                              â”‚  â”‚
â”‚                        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚                        â”‚  â”‚  è¾“å…¥æ¡† + å‘é€æŒ‰é’®             â”‚  â”‚
â”‚                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                        â”‚  æ— ä¼šè¯æ—¶æ˜¾ç¤ºæ¬¢è¿é¡µ               â”‚
â”‚                        â”‚  + ç›´æ¥è¾“å…¥æ¶ˆæ¯å¼€å§‹æ–°å¯¹è¯          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 13.3.2 ç»„ä»¶æ¶æ„

```
src/
â”œâ”€â”€ views/ai/
â”‚   â””â”€â”€ SidebarAssistant.vue          âœ… ä¾§è¾¹æ AIåŠ©æ‰‹ä¸»é¡µé¢
â”œâ”€â”€ types/ai.ts                        âœ… ç±»å‹å®šä¹‰ï¼ˆæ‰©å±•ï¼‰
â”œâ”€â”€ api/ai.ts                          âœ… APIå®¢æˆ·ç«¯ï¼ˆæ‰©å±•ï¼‰
â”œâ”€â”€ components/ai/
â”‚   â”œâ”€â”€ ChatInterface.vue              âœ… å¤ç”¨ï¼šèŠå¤©ä¸»ç•Œé¢
â”‚   â”œâ”€â”€ ChatMessage.vue                âœ… å¤ç”¨ï¼šæ¶ˆæ¯ç»„ä»¶
â”‚   â”œâ”€â”€ ChatInput.vue                  âœ… å¤ç”¨ï¼šè¾“å…¥ç»„ä»¶
â”‚   â””â”€â”€ MarkdownRenderer.vue           âœ… å¤ç”¨ï¼šMarkdownæ¸²æŸ“
â””â”€â”€ router/index.ts                    âœ… è·¯ç”±é…ç½®
```

### 13.4 APIæ¥å£ï¼ˆå¤ç”¨ChatControllerï¼‰

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/chat/sessions` | åˆ›å»ºæ–°ä¼šè¯ |
| GET | `/api/chat/sessions` | è·å–æ‰€æœ‰ä¼šè¯ |
| GET | `/api/chat/sessions/{sessionId}` | è·å–ä¼šè¯è¯¦æƒ… |
| DELETE | `/api/chat/sessions/{sessionId}` | åˆ é™¤ä¼šè¯ |
| GET | `/api/chat/sessions/{sessionId}/messages` | è·å–æ¶ˆæ¯å†å² |
| POST | `/api/chat/messages` | å‘é€æ¶ˆæ¯ |
| DELETE | `/api/chat/sessions/{sessionId}/messages` | æ¸…ç©ºæ¶ˆæ¯ |
| POST | `/api/chat/sessions/{sessionId}/link` | å…³è”ä¸»æœº |

### 13.5 å¼€å‘é˜¶æ®µ

#### é˜¶æ®µ1: æ‰©å±•ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `src/types/ai.ts`

**æ–°å¢ç±»å‹**:
```typescript
// ä¼šè¯ä¿¡æ¯
export interface SessionInfo {
  sessionId: string
  title: string
  createdAt: number
  updatedAt: number
  messageCount: number
  linkedAgentId?: string
}

// åˆ›å»ºä¼šè¯è¯·æ±‚/å“åº”
export interface CreateSessionRequest {
  firstMessage: string
  agentId?: string
}

export interface CreateSessionResponse {
  sessionId: string
  title: string
}

// å‘é€æ¶ˆæ¯è¯·æ±‚/å“åº”
export interface SendMessageRequest {
  sessionId: string
  message: string
  modelName?: string
}

export interface ChatResponse {
  sessionId: string
  reply: string
  message: ChatMessageResponse
}
```

#### é˜¶æ®µ2: æ‰©å±•APIå®¢æˆ·ç«¯

**æ–‡ä»¶**: `src/api/ai.ts`

**æ–°å¢ç±»**: `ChatSessionAPI`

```typescript
export class ChatSessionAPI {
  static async createSession(data: CreateSessionRequest): Promise<CreateSessionResponse>
  static async getSessions(): Promise<SessionInfo[]>
  static async getSession(sessionId: string): Promise<SessionInfo>
  static async deleteSession(sessionId: string): Promise<void>
  static async getMessages(sessionId: string): Promise<ChatMessageResponse[]>
  static async sendMessage(data: SendMessageRequest): Promise<ChatResponse>
  static async clearMessages(sessionId: string): Promise<void>
  static async linkAgent(sessionId: string, agentId: string): Promise<void>
}
```

#### é˜¶æ®µ3: åˆ›å»ºä¸»é¡µé¢ç»„ä»¶

**æ–‡ä»¶**: `src/views/ai/SidebarAssistant.vue`

**åŠŸèƒ½æ¨¡å—**:
1. **å·¦ä¾§ä¼šè¯é¢æ¿** (280px)
   - æ ‡é¢˜æ  + "æ–°å¯¹è¯"æŒ‰é’®
   - ä¼šè¯åˆ—è¡¨ï¼ˆæ”¯æŒåˆ‡æ¢ã€åˆ é™¤ï¼‰
   - ç›¸å¯¹æ—¶é—´æ˜¾ç¤ºï¼ˆåˆšåˆšã€Xåˆ†é’Ÿå‰ã€Xå¤©å‰ï¼‰

2. **å³ä¾§èŠå¤©åŒºåŸŸ** (è‡ªé€‚åº”)
   - æ¬¢è¿è§†å›¾ï¼ˆæ— ä¼šè¯æ—¶ï¼‰
   - èŠå¤©è§†å›¾ï¼ˆæœ‰ä¼šè¯æ—¶ï¼‰
   - æ¶ˆæ¯è¾“å…¥æ¡†

3. **çŠ¶æ€ç®¡ç†**
   - `sessions`: ä¼šè¯åˆ—è¡¨
   - `currentSessionId`: å½“å‰ä¼šè¯ID
   - `messages`: æ¶ˆæ¯åˆ—è¡¨
   - `isLoading`: åŠ è½½çŠ¶æ€

#### é˜¶æ®µ4: æ·»åŠ è·¯ç”±é…ç½®

**æ–‡ä»¶**: `src/router/index.ts`

```typescript
{
  path: 'ai',
  name: 'SidebarAssistant',
  component: SidebarAssistant,
  meta: { title: 'AIå¯¹è¯', icon: 'ğŸ¤–' },
}
```

### 13.6 æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 13.6.1 ä¼šè¯ç®¡ç†

```typescript
// åŠ è½½ä¼šè¯åˆ—è¡¨
const loadSessions = async () => {
  const data = await getChatSessions()
  sessions.value = data
}

// æ–°å»ºå¯¹è¯ï¼ˆæ¸…ç©ºçŠ¶æ€ï¼Œå‡†å¤‡åˆ›å»ºï¼‰
const handleNewChat = () => {
  currentSessionId.value = ''
  messages.value = []
  currentSession.value = null
  ElMessage.info('å·²åˆ›å»ºæ–°å¯¹è¯ï¼Œè¯·è¾“å…¥æ¶ˆæ¯å¼€å§‹')
}

// åˆ‡æ¢ä¼šè¯
const handleSelectSession = async (sessionId: string) => {
  currentSessionId.value = sessionId
  await loadMessages(sessionId)
}

// åˆ é™¤ä¼šè¯
const handleDeleteSession = async (sessionId: string) => {
  await deleteChatSession(sessionId)
  await loadSessions()
  if (sessionId === currentSessionId.value) {
    currentSessionId.value = ''
    messages.value = []
  }
}
```

#### 13.6.2 æ¶ˆæ¯å‘é€

```typescript
const handleSendMessage = async (content: string) => {
  // å¦‚æœæ²¡æœ‰ä¼šè¯IDï¼Œå…ˆåˆ›å»ºä¼šè¯
  if (!currentSessionId.value) {
    const result = await createChatSession({ firstMessage: content })
    currentSessionId.value = result.sessionId
    await loadSessions()
  }

  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  messages.value.push({
    id: generateMessageId(),
    role: 'user',
    content,
    timestamp: Date.now()
  })

  // å‘é€æ¶ˆæ¯å¹¶è·å–AIå›å¤
  const response = await sendChatMessage({
    sessionId: currentSessionId.value,
    message: content
  })

  // æ·»åŠ AIå›å¤
  messages.value.push({
    id: generateMessageId(),
    role: 'assistant',
    content: response.reply,
    timestamp: response.message.timestamp
  })

  // åˆ·æ–°ä¼šè¯åˆ—è¡¨ï¼ˆæ›´æ–°æ—¶é—´ï¼‰
  await loadSessions()
}
```

#### 13.6.3 ç›¸å¯¹æ—¶é—´æ ¼å¼åŒ–

```typescript
const formatTime = (timestamp: number): string => {
  const diff = Date.now() - timestamp
  if (diff < 3600000) {
    const minutes = Math.floor(diff / 60000)
    return minutes === 0 ? 'åˆšåˆš' : `${minutes}åˆ†é’Ÿå‰`
  }
  if (diff < 86400000) {
    return `${Math.floor(diff / 3600000)}å°æ—¶å‰`
  }
  if (diff < 604800000) {
    return `${Math.floor(diff / 86400000)}å¤©å‰`
  }
  return `${date.getMonth() + 1}/${date.getDate()}`
}
```

### 13.7 é—®é¢˜ä¿®å¤è®°å½•

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | åŸå›  | ä¿®å¤æ–¹æ¡ˆ |
|---------|---------|------|----------|
| FE-006 | ChatMessageç»„ä»¶ä¸ç±»å‹åç§°å†²çª | å¯¼å…¥`ChatMessage`ç»„ä»¶å’Œ`ChatMessage`ç±»å‹åŒå | ç±»å‹åˆ«åï¼š`ChatMessage as ChatMessageType` |
| FE-007 | æ¬¢è¿/æ–°å¯¹è¯"æŒ‰é’®æ— ååº” | æŒ‰é’®åœ¨æ¬¢è¿è§†å›¾ä¸­æ˜¯å¤šä½™çš„ï¼ˆå·²åœ¨æ–°å¯¹è¯çŠ¶æ€ï¼‰ | ç§»é™¤æŒ‰é’®ï¼Œç›´æ¥æ˜¾ç¤ºè¾“å…¥æ¡† |

### 13.8 åˆ›å»ºæ–‡ä»¶æ¸…å•

```
Monitor-Web/src/

â”œâ”€â”€ views/ai/
â”‚   â””â”€â”€ SidebarAssistant.vue           âœ… ä¾§è¾¹æ AIåŠ©æ‰‹ä¸»é¡µé¢ï¼ˆ350è¡Œï¼‰
â”œâ”€â”€ types/ai.ts                        âœ… æ‰©å±•ç±»å‹å®šä¹‰
â”œâ”€â”€ api/ai.ts                          âœ… æ‰©å±•APIå®¢æˆ·ç«¯
â”œâ”€â”€ components/ai/
â”‚   â”œâ”€â”€ ChatMessage.vue                âœ… æ‰©å±•ï¼šæ·»åŠ showRoleã€showAvatarå±æ€§
â”‚   â”œâ”€â”€ ChatInterface.vue              âœ… å¤ç”¨
â”‚   â”œâ”€â”€ ChatInput.vue                  âœ… å¤ç”¨
â”‚   â””â”€â”€ MarkdownRenderer.vue           âœ… å¤ç”¨
â””â”€â”€ router/index.ts                    âœ… æ·»åŠ /aiè·¯ç”±
```

### 13.9 æŠ€æœ¯è¦ç‚¹

#### 1. ç»„ä»¶å¤ç”¨ç­–ç•¥

| ç»„ä»¶ | SSHç»‘å®šAIåŠ©æ‰‹ | ä¾§è¾¹æ AIåŠ©æ‰‹ |
|------|-------------|-------------|
| `ChatMessage.vue` | âœ… å¤ç”¨ | âœ… å¤ç”¨ |
| `ChatInput.vue` | âœ… å¤ç”¨ | âœ… å¤ç”¨ |
| `MarkdownRenderer.vue` | âœ… å¤ç”¨ | âœ… å¤ç”¨ |
| `ChatInterface.vue` | âœ… å¤ç”¨ | âŒ æœªä½¿ç”¨ |
| `AiAssistantDialog.vue` | âœ… ç‹¬æœ‰ | âŒ æœªä½¿ç”¨ |
| `SidebarAssistant.vue` | âŒ æœªä½¿ç”¨ | âœ… ç‹¬æœ‰ |

#### 2. ä¼šè¯åˆ›å»ºæ—¶æœº

**ç­–ç•¥**: å»¶è¿Ÿåˆ›å»ºä¼šè¯

```typescript
// ç”¨æˆ·è¾“å…¥ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶æ‰åˆ›å»ºä¼šè¯
if (!currentSessionId.value) {
  const result = await createChatSession({ firstMessage: content })
  currentSessionId.value = result.sessionId
}
```

**ä¼˜ç‚¹**:
- é¿å…ç©ºä¼šè¯
- ä¼šè¯æ ‡é¢˜ç”±é¦–æ¡æ¶ˆæ¯è‡ªåŠ¨ç”Ÿæˆ
- å‡å°‘æ— æ•ˆä¼šè¯æ•°æ®

#### 3. æ¬¢è¿è§†å›¾è®¾è®¡

**åˆå§‹è®¾è®¡é—®é¢˜**: æ¬¢è¿/æ–°å¯¹è¯"æŒ‰é’®æ— ååº”

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```vue
<!-- æ¬¢è¿è§†å›¾ç›´æ¥æ˜¾ç¤ºè¾“å…¥æ¡† -->
<div class="welcome-view">
  <div class="welcome-content">
    <h2>AIæ™ºèƒ½åŠ©æ‰‹</h2>
    <p>ç‚¹å‡»ä¸Šæ–¹"æ–°å¯¹è¯"æŒ‰é’®æˆ–é€‰æ‹©å·²æœ‰å¯¹è¯å¼€å§‹èŠå¤©</p>
    <div class="welcome-tips">
      <p>ğŸ’¡ æç¤ºï¼šç›´æ¥åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥æ¶ˆæ¯å³å¯å¼€å§‹æ–°å¯¹è¯</p>
    </div>
  </div>
  <!-- å§‹ç»ˆæ˜¾ç¤ºè¾“å…¥æ¡† -->
  <ChatInput @send="handleSendMessage" />
</div>
```

### 13.10 æµ‹è¯•åœºæ™¯

| åœºæ™¯ | æ“ä½œ | é¢„æœŸç»“æœ |
|------|------|----------|
| è¿›å…¥é¡µé¢ | ç‚¹å‡»ä¾§è¾¹æ "AIå¯¹è¯"èœå• | æ˜¾ç¤ºæ¬¢è¿è§†å›¾ + è¾“å…¥æ¡† |
| å¼€å§‹æ–°å¯¹è¯ | ç›´æ¥è¾“å…¥æ¶ˆæ¯å‘é€ | è‡ªåŠ¨åˆ›å»ºä¼šè¯ï¼Œæ˜¾ç¤ºå›å¤ |
| åˆ‡æ¢ä¼šè¯ | ç‚¹å‡»å·¦ä¾§ä¼šè¯åˆ—è¡¨é¡¹ | åŠ è½½è¯¥ä¼šè¯çš„å†å²æ¶ˆæ¯ |
| åˆ é™¤ä¼šè¯ | ç‚¹å‡»ä¼šè¯çš„åˆ é™¤æŒ‰é’® | ç¡®è®¤ååˆ é™¤ï¼Œè‹¥ä¸ºå½“å‰ä¼šè¯åˆ™æ¸…ç©ºèŠå¤©åŒº |
| å¤šä¼šè¯ç®¡ç† | åˆ›å»ºå¤šä¸ªä¼šè¯ | å·¦ä¾§åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯ï¼Œæ”¯æŒåˆ‡æ¢ |
| æ—¶é—´æ˜¾ç¤º | æŸ¥çœ‹ä¼šè¯åˆ—è¡¨ | æ˜¾ç¤ºç›¸å¯¹æ—¶é—´ï¼ˆåˆšåˆšã€Xåˆ†é’Ÿå‰ï¼‰ |

### 13.11 å¼€å‘æäº¤è®°å½•

| æäº¤ | è¯´æ˜ | æ—¥æœŸ |
|------|------|------|
| - | ä¾§è¾¹æ AIåŠ©æ‰‹å¼€å‘å®Œæˆ | 2026-02-05 |

---

## åå››ã€åŠŸèƒ½çŠ¶æ€æ€»è§ˆ

| åŠŸèƒ½æ¨¡å— | åç«¯çŠ¶æ€ | å‰ç«¯çŠ¶æ€ | å¤‡æ³¨ |
|---------|---------|---------|------|
| å…¨å±€ä¾§è¾¹æ AIåŠ©æ‰‹ | âœ… Monitor-AI: ChatController | âœ… SidebarAssistant.vue | HTTP REST API |
| ä¸»æœºè¯¦æƒ…é¡µAIåŠ©æ‰‹ | âœ… Monitor-Server: AiSshAssistantController | âœ… AiAssistantDialog.vue | WebSocket + SSHç»‘å®š |

---

## åäº”ã€æ¶æ„é‡æ„å®Œæˆï¼ˆV3.0ï¼‰

### 15.1 é‡æ„æ€»ç»“

æœ¬æ¬¡é‡æ„å°†ä¾§è¾¹æ AIåŠ©æ‰‹åŠŸèƒ½ä»Monitor-Serverä¸­æŠ½ç¦»ï¼Œå½¢æˆç‹¬ç«‹çš„Monitor-AIå¾®æœåŠ¡æ¨¡å—ï¼Œå®ç°äº†æ›´å¥½çš„ç³»ç»Ÿå¯æ‰©å±•æ€§å’ŒæœåŠ¡ç‹¬ç«‹æ€§ã€‚

### 15.2 é‡æ„æ¸…å•

**Monitor-AIæ¨¡å—ï¼ˆæ–°å»ºï¼‰**
```
Monitor-AI/
â”œâ”€â”€ pom.xml                           âœ… Mavené…ç½®
â”œâ”€â”€ src/main/resources/
â”‚   â””â”€â”€ application.yaml              âœ… æœåŠ¡é…ç½®
â””â”€â”€ src/main/java/com/hundred/monitor/ai/
    â”œâ”€â”€ MonitorAiApplication.java     âœ… å¯åŠ¨ç±»
    â”œâ”€â”€ config/
    â”‚   â”œâ”€â”€ AIModelConfig.java        âœ… AIæ¨¡å‹é…ç½®
    â”‚   â”œâ”€â”€ JwtConfig.java            âœ… JWTé…ç½®
    â”‚   â”œâ”€â”€ RedisConfig.java          âœ… Redisé…ç½®
    â”‚   â””â”€â”€ FeignConfig.java          âœ… Feigné…ç½®
    â”œâ”€â”€ controller/
    â”‚   â””â”€â”€ ChatController.java       âœ… 8ä¸ªREST API
    â”œâ”€â”€ service/
    â”‚   â”œâ”€â”€ ChatService.java          âœ… èŠå¤©æœåŠ¡
    â”‚   â””â”€â”€ AgentClient.java          âœ… Feignå®¢æˆ·ç«¯
    â””â”€â”€ utils/
        â””â”€â”€ ChatSessionRedisUtils.java âœ… Rediså·¥å…·
```

**CommonLibraryæ‰©å±•**
```
CommonLibrary/src/main/java/com/hundred/monitor/commonlibrary/ai/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ ChatMessage.java              âœ… èŠå¤©æ¶ˆæ¯å®ä½“
â”‚   â”œâ”€â”€ ChatSessionInfo.java          âœ… ä¼šè¯ä¿¡æ¯å®ä½“
â”‚   â””â”€â”€ SystemPrompt.java             âœ… ç³»ç»Ÿæç¤ºè¯
â”œâ”€â”€ request/
â”‚   â”œâ”€â”€ CreateSessionRequest.java     âœ… åˆ›å»ºä¼šè¯è¯·æ±‚
â”‚   â””â”€â”€ SendMessageRequest.java       âœ… å‘é€æ¶ˆæ¯è¯·æ±‚
â””â”€â”€ response/
    â”œâ”€â”€ CreateSessionResponse.java    âœ… åˆ›å»ºä¼šè¯å“åº”
    â”œâ”€â”€ ChatMessageResponse.java      âœ… æ¶ˆæ¯å“åº”
    â”œâ”€â”€ ChatResponse.java             âœ… èŠå¤©å“åº”
    â””â”€â”€ SessionInfoResponse.java      âœ… ä¼šè¯ä¿¡æ¯å“åº”
```

**Monitor-Serverä¿®æ”¹**
```
Monitor-Server/src/main/java/com/hundred/monitor/server/
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ AgentApiController.java       âœ… Agent APIï¼ˆä¾›AIè°ƒç”¨ï¼‰
â”œâ”€â”€ service/
â”‚   â””â”€â”€ ai/
â”‚       â””â”€â”€ AiSshAssistantService.java ğŸ”§ ä¿®æ”¹importï¼ˆCommonLibraryï¼‰
â””â”€â”€ model/dto/
    â”œâ”€â”€ AgentInfoDTO.java             âœ… Agentä¿¡æ¯DTO
    â””â”€â”€ AgentDetailDTO.java           âœ… Agentè¯¦æƒ…DTO
```

**Monitor-Webä¿®æ”¹**
```
Monitor-Web/src/
â”œâ”€â”€ .env.development                  ğŸ”§ æ·»åŠ VITE_AI_API_BASE_URL
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ ai-request.ts                 âœ… AIæœåŠ¡HTTPå®¢æˆ·ç«¯
â””â”€â”€ api/
    â””â”€â”€ ai.ts                         ğŸ”§ ChatSessionAPIä½¿ç”¨ai-request
```

### 15.3 æœåŠ¡é—´é€šä¿¡

**Monitor-AI â†’ Monitor-Serverï¼ˆFeignï¼‰**
```java
@FeignClient(name = "agent-client", url = "${monitor.server.url}")
public interface AgentClient {
    @GetMapping("/api/v1/agent/list")
    BaseResponse<List<AgentInfoDTO>> getAgentList(
        @RequestHeader("Authorization") String token);

    @GetMapping("/api/v1/agent/{agentId}")
    BaseResponse<AgentDetailDTO> getAgent(
        @PathVariable("agentId") String agentId,
        @RequestHeader("Authorization") String token);
}
```

**å‰ç«¯ â†’ Monitor-AIï¼ˆai-request.tsï¼‰**
```typescript
import axios from 'axios'
const aiRequest = axios.create({
  baseURL: import.meta.env.VITE_AI_API_BASE_URL, // http://localhost:8081/api
  timeout: 30000
})
```

### 15.4 éªŒè¯ç»“æœ

| éªŒè¯é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| CommonLibraryç¼–è¯‘ | âœ… é€šè¿‡ | æ‰©å±•ai/modelã€ai/requestã€ai/response |
| Monitor-AIç¼–è¯‘ | âœ… é€šè¿‡ | æ–°æ¨¡å—ç¼–è¯‘æˆåŠŸ |
| Monitor-Serverç¼–è¯‘ | âœ… é€šè¿‡ | åˆ é™¤è¿ç§»ä»£ç ï¼Œæ·»åŠ AgentApiController |
| Monitor-Webæ„å»º | âœ… é€šè¿‡ | æ·»åŠ ai-request.tsï¼Œæ›´æ–°APIè°ƒç”¨ |

### 15.5 æŠ€æœ¯è¦ç‚¹

1. **å…±äº«JWT Secret**ï¼šServerå’ŒAIæœåŠ¡ä½¿ç”¨ç›¸åŒçš„JWTå¯†é’¥ï¼Œå®ç°Tokenäº’é€š
2. **Feignè°ƒç”¨**ï¼šAIæœåŠ¡é€šè¿‡Feignè°ƒç”¨Serverçš„Agent APIè·å–ä¸»æœºä¿¡æ¯
3. **ç‹¬ç«‹Redisè¿æ¥**ï¼šä¸¤ä¸ªæœåŠ¡å„è‡ªè¿æ¥Redisï¼Œé€šè¿‡keyå‰ç¼€åŒºåˆ†æ•°æ®
4. **å‰ç«¯è·¯ç”±**ï¼šé€šè¿‡ä¸åŒçš„baseURLï¼ˆVITE_API_BASE_URL vs VITE_AI_API_BASE_URLï¼‰è°ƒç”¨ä¸åŒæœåŠ¡

### 15.6 å¼€å‘æäº¤è®°å½•

| æäº¤ | è¯´æ˜ | æ—¥æœŸ |
|------|------|------|
| 1d62b0d | å®ç°ä¾§è¾¹æ AIåŠ©æ‰‹åŠŸèƒ½ï¼šå¤šä¼šè¯ç®¡ç†ä¸HTTP REST APIé€šä¿¡ | 2026-02-07 |

---
