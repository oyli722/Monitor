# AIåŠ©æ‰‹ç»ˆç«¯é›†æˆå¼€å‘è®°å½•

## ä¸€ã€æœ€åˆéœ€æ±‚

ç”¨æˆ·éœ€è¦åœ¨Monitorç›‘æ§ç³»ç»Ÿä¸­å¼€å‘ä¸€ä¸ªé›†æˆåœ¨ä¸»æœºè¯¦æƒ…é¡µçš„AIåŠ©æ‰‹åŠŸèƒ½ï¼Œæ”¯æŒä¼šè¯ç®¡ç†ã€æ¶ˆæ¯å†å²ã€ä¸Šä¸‹æ–‡ä¿æŒå’Œæ™ºèƒ½æ€»ç»“å‹ç¼©ã€‚

---

## äºŒã€åˆå§‹æ¶æ„è®¾è®¡

### 2.1 åŠŸèƒ½éœ€æ±‚
1. **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒå¤šä¼šè¯ã€ä¼šè¯åˆ—è¡¨å±•ç¤ºã€ä¼šè¯åˆ‡æ¢ã€ä¼šè¯åˆ é™¤
2. **æ¶ˆæ¯ç®¡ç†**ï¼šæ¶ˆæ¯å‘é€ã€æ¶ˆæ¯å†å²åŠ è½½ã€æ¶ˆæ¯æ¸…ç©º
3. **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šä¿æŒå¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒé•¿å¯¹è¯çš„æ€»ç»“å‹ç¼©
4. **ä¸»æœºå…³è”**ï¼šä¼šè¯å¯å…³è”ä¸»æœºï¼ŒAIå¯è·å–ä¸»æœºä¸Šä¸‹æ–‡ä¿¡æ¯

### 2.2 æŠ€æœ¯é€‰å‹
- **åç«¯**ï¼šSpring Boot 3.5.10 + LangChain4j
- **å‰ç«¯**ï¼šVue 3 + TypeScript
- **å­˜å‚¨**ï¼šRedisï¼ˆä¼šè¯ã€æ¶ˆæ¯ã€æ€»ç»“ï¼‰
- **AIæ¨¡å‹**ï¼šGLM-4.7ï¼ˆBigModel APIï¼‰æˆ– Ollamaæœ¬åœ°æ¨¡å‹

### 2.3 åˆå§‹å¼€å‘æ­¥éª¤

```
æ­¥éª¤1: åŸºç¡€å®ä½“ç±»
  â”œâ”€â”€ Message.java           - èŠå¤©æ¶ˆæ¯å®ä½“
  â””â”€â”€ SessionInfo.java       - ä¼šè¯ä¿¡æ¯å®ä½“ï¼ˆRedisæ˜ å°„ï¼‰

æ­¥éª¤2: Rediså·¥å…·ç±»
  â””â”€â”€ ModelRedisUtils.java   - æ¶ˆæ¯å’Œä¼šè¯çš„Redisæ“ä½œ

æ­¥éª¤3: Serviceå±‚
  â””â”€â”€ ChatService.java       - èŠå¤©æœåŠ¡é€»è¾‘

æ­¥éª¤4: Controllerå±‚
  â”œâ”€â”€ DTOç±»                  - è¯·æ±‚/å“åº”å¯¹è±¡
  â””â”€â”€ ChatController.java    - HTTP REST API

æ­¥éª¤5: å‰ç«¯é›†æˆ
  â””â”€â”€ AIAssistant.vue        - èŠå¤©ç•Œé¢ç»„ä»¶
```

---

## ä¸‰ã€å¼€å‘è¿›åº¦

### 3.1 å·²å®ŒæˆåŠŸèƒ½ï¼ˆåœºæ™¯Aï¼šå…¨å±€ä¾§è¾¹æ AIåŠ©æ‰‹ï¼‰

| æ­¥éª¤ | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| æ­¥éª¤1 | åŸºç¡€å®ä½“ç±» | âœ… å®Œæˆ |
| æ­¥éª¤2 | Rediså·¥å…·ç±» | âœ… å®Œæˆ |
| æ­¥éª¤3 | Serviceå±‚ | âœ… å®Œæˆ |
| æ­¥éª¤4 | Controllerå±‚ | âœ… å®Œæˆ |

### 3.2 å·²åˆ›å»ºæ–‡ä»¶ï¼ˆåœºæ™¯Aï¼‰

```
monitor-project/Monitor-Server/src/main/java/com/hundred/monitor/server/ai/

â”œâ”€â”€ entity/
â”‚   â”œâ”€â”€ Message.java                    âœ… èŠå¤©æ¶ˆæ¯å®ä½“
â”‚   â””â”€â”€ SessionInfo.java                âœ… ä¼šè¯ä¿¡æ¯å®ä½“
â”‚
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ ModelRedisUtils.java            âœ… Rediså·¥å…·ç±»
â”‚
â”œâ”€â”€ service/
â”‚   â””â”€â”€ ChatService.java                âœ… èŠå¤©æœåŠ¡
â”‚
â””â”€â”€ controller/
    â””â”€â”€ ChatController.java             âœ… HTTP REST API
```

---

## å››ã€å¼€å‘æš‚åœä¸é‡æ–°åˆ†æ

### 4.1 æš‚åœåŸå› 

ç”¨æˆ·å‘ç°æˆ‘å¯¹éœ€æ±‚çš„ç†è§£å­˜åœ¨åå·®ï¼Œéœ€è¦é‡æ–°æ˜ç¡®æ¶æ„è®¾è®¡ã€‚

### 4.2 ç”¨æˆ·æ¾„æ¸…çš„å…³é”®ä¿¡æ¯

1. **ä¸¤ç§AIåŠ©æ‰‹åœºæ™¯ï¼Œå®Œå…¨ç‹¬ç«‹ï¼Œæ— äº¤é›†**

2. **åœºæ™¯Aï¼šå…¨å±€ä¾§è¾¹æ AIåŠ©æ‰‹**
   - ä½ç½®ï¼šå…¨å±€ä¾§è¾¹æ 
   - é€šä¿¡æ–¹å¼ï¼šHTTP REST API
   - åŠŸèƒ½ï¼šé€šç”¨AIå¯¹è¯ï¼Œä¸å…³è”ä¸»æœº
   - å·²å¼€å‘ï¼šChatController + ChatService

3. **åœºæ™¯Bï¼šä¸»æœºè¯¦æƒ…é¡µAIåŠ©æ‰‹**ï¼ˆæœ¬æ¬¡å¼€å‘é‡ç‚¹ï¼‰
   - ä½ç½®ï¼šä¸»æœºè¯¦æƒ…é¡µ
   - é€šä¿¡æ–¹å¼ï¼šWebSocketé•¿è¿æ¥
   - åŠŸèƒ½ï¼šä¸SSHç»ˆç«¯ç»‘å®šçš„AIåŠ©æ‰‹ï¼Œå¯ç›´æ¥æ‰§è¡ŒSSHå‘½ä»¤
   - çŠ¶æ€ï¼šå¾…å¼€å‘

### 4.3 é‡æ–°ç†è§£çš„æ ¸å¿ƒé€»è¾‘

#### ä¸»æœºè¯¦æƒ…é¡µAIåŠ©æ‰‹äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤1ï¼šç”¨æˆ·æ‰“å¼€SSHç»ˆç«¯                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å‰ç«¯ç‚¹å‡»[è¿æ¥ç»ˆç«¯]æŒ‰é’®                                              â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ WebSocketè¿æ¥: ws://server/ws/ssh/terminal/{sshSessionId}          â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ åç«¯SshWebSocketHandlerå¤„ç†ï¼ˆå·²æœ‰ï¼‰                                 â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ å‰ç«¯è·å¾— sshSessionId                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤2ï¼šç”¨æˆ·æ‰“å¼€AIåŠ©æ‰‹                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å‰ç«¯ç‚¹å‡»[æ‰“å¼€AIåŠ©æ‰‹]æŒ‰é’®                                            â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ æ£€æŸ¥: sshSessionId æ˜¯å¦å­˜åœ¨?                                        â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â”œâ”€ ä¸å­˜åœ¨ â†’ æç¤º"è¯·å…ˆæ‰“å¼€ç»ˆç«¯"                                  â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â””â”€ å­˜åœ¨ â†’ å‘é€HTTPè¯·æ±‚                                          â”‚  â”‚
â”‚  â”‚           â”‚                                                        â”‚  â”‚
â”‚  â”‚           â–¼                                                        â”‚  â”‚
â”‚  â”‚     POST /api/ai/ssh-assistant/connect                             â”‚  â”‚
â”‚  â”‚     {                                                              â”‚  â”‚
â”‚  â”‚       "sshSessionId": "xxx",                                       â”‚  â”‚
â”‚  â”‚       "agentId": "agent-001"                                       â”‚  â”‚
â”‚  â”‚     }                                                              â”‚  â”‚
â”‚  â”‚           â”‚                                                        â”‚  â”‚
â”‚  â”‚           â–¼                                                        â”‚  â”‚
â”‚  â”‚     åç«¯åˆ›å»ºAIä¼šè¯ï¼Œè¿”å› aiSessionId                                â”‚  â”‚
â”‚  â”‚     {                                                              â”‚  â”‚
â”‚  â”‚       "aiSessionId": "yyy"                                         â”‚  â”‚
â”‚  â”‚     }                                                              â”‚  â”‚
â”‚  â”‚           â”‚                                                        â”‚  â”‚
â”‚  â”‚           â–¼                                                        â”‚  â”‚
â”‚  â”‚     åç«¯å­˜å‚¨ç»‘å®šå…³ç³»åˆ°Redis:                                        â”‚  â”‚
â”‚  â”‚     key: "ai:ssh:binding:{aiSessionId}"                            â”‚  â”‚
â”‚  â”‚     value: { sshSessionId, agentId }                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤3ï¼šå»ºç«‹AI WebSocketè¿æ¥                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å‰ç«¯ä½¿ç”¨ aiSessionId å»ºç«‹WebSocketè¿æ¥                              â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ WebSocketè¿æ¥: ws://server/ws/ai/ssh-assistant/{aiSessionId}       â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ åç«¯AiSshAssistantHandlerå¤„ç†                                       â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ ä»Redisè·å–ç»‘å®šå…³ç³»ï¼ˆsshSessionId, agentIdï¼‰                        â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ å°†WebSocketè¿æ¥ä¸ä¼šè¯å…³è”å­˜å‚¨                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤4ï¼šAIå¯¹è¯äº¤äº’                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”¨æˆ·å‘é€æ¶ˆæ¯                                                        â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ WebSocketæ¶ˆæ¯åˆ°è¾¾ AiSshAssistantHandler                            â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ AiSshAssistantService å¤„ç†                                          â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ æ„å»ºAIä¸Šä¸‹æ–‡:                                                       â”‚  â”‚
â”‚  â”‚   - ç³»ç»Ÿæç¤ºè¯                                                      â”‚  â”‚
â”‚  â”‚   - å½“å‰ä¸»æœºID (agentId)                                           â”‚  â”‚
â”‚  â”‚   - å†å²å¯¹è¯æ¶ˆæ¯                                                    â”‚  â”‚
â”‚  â”‚   - å†å²æ€»ç»“ï¼ˆå¦‚æœ‰ï¼‰                                                â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ è°ƒç”¨LangChain4j AIæ¨¡å‹                                              â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ AIå¯è°ƒç”¨SshExecuteToolæ‰§è¡ŒSSHå‘½ä»¤                                   â”‚  â”‚
â”‚  â”‚     â”‚                                                              â”‚  â”‚
â”‚  â”‚     â–¼                                                              â”‚  â”‚
â”‚  â”‚ è¿”å›AIå›å¤ â†’ WebSocketå‘é€ç»™å‰ç«¯                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 æ ¸å¿ƒæ¦‚å¿µ

#### SSH Session ä¸ AI Session çš„ç»‘å®šå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å‰ç«¯                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¸»æœºè¯¦æƒ…é¡µ                                                        â”‚   â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚    â”‚  SSHç»ˆç«¯çª—å£     â”‚  â”‚  AIåŠ©æ‰‹é¢æ¿                     â”‚      â”‚   â”‚
â”‚  â”‚    â”‚  (xterm.js)      â”‚  â”‚  - æ¶ˆæ¯è¾“å…¥æ¡†                   â”‚      â”‚   â”‚
â”‚  â”‚    â”‚                 â”‚  â”‚  - AIå›å¤å±•ç¤º                   â”‚      â”‚   â”‚
â”‚  â”‚    â”‚  $ ls -la       â”‚  â”‚                                 â”‚      â”‚   â”‚
â”‚  â”‚    â”‚                 â”‚  â”‚  AI: æ­£åœ¨åˆ†ææ—¥å¿—...            â”‚      â”‚   â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                    â”‚                          â”‚
â”‚         â”‚ sshSessionId                       â”‚ aiSessionId             â”‚
â”‚         â–¼                                    â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          åç«¯                                    â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  SSH WebSocket (å·²æœ‰)              AI WebSocket (å¾…å¼€å‘)          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚ SshWebSocketHandler   â”‚        â”‚ AiSshAssistantHandler â”‚      â”‚   â”‚
â”‚  â”‚  â”‚ /ws/ssh/terminal/     â”‚        â”‚ /ws/ai/ssh-assistant/ â”‚      â”‚   â”‚
â”‚  â”‚  â”‚ {sshSessionId}        â”‚        â”‚ {aiSessionId}         â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â”‚              â”‚                              â”‚                      â”‚   â”‚
â”‚  â”‚              â”‚                              â”‚                      â”‚   â”‚
â”‚  â”‚              â–¼                              â–¼                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚              Redis ç»‘å®šå…³ç³»                         â”‚          â”‚   â”‚
â”‚  â”‚  â”‚  ai:ssh:binding:{aiSessionId} â†’ {                  â”‚          â”‚   â”‚
â”‚  â”‚  â”‚    "sshSessionId": "xxx",                          â”‚          â”‚   â”‚
â”‚  â”‚  â”‚    "agentId": "agent-001"                          â”‚          â”‚   â”‚
â”‚  â”‚  â”‚  }                                                â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### AIä¸Šä¸‹æ–‡è®¾è®¡

AIå¯¹è¯æ—¶çš„ä¸Šä¸‹æ–‡åŒ…å«ï¼š

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| **ç³»ç»Ÿæç¤ºè¯** | ä½ æ˜¯æœåŠ¡å™¨è¿ç»´AIåŠ©æ‰‹ï¼ŒæœåŠ¡äºMonitorç›‘æ§ç³»ç»Ÿ... |
| **ä¸»æœºä¿¡æ¯** | å½“å‰ä¸»æœºIDã€IPã€ä¸»æœºåç­‰ |
| **å†å²æ¶ˆæ¯** | è¿‘æœŸNæ¡å¯¹è¯æ¶ˆæ¯ |
| **å†å²æ€»ç»“** | æ¶ˆæ¯è¿‡å¤šæ—¶ç”Ÿæˆçš„æ€»ç»“ |
| **å¯ç”¨å·¥å…·** | SshExecuteTool - æ‰§è¡ŒSSHå‘½ä»¤ |

---

## äº”ã€é‡æ–°è®¾è®¡å¼€å‘æ­¥éª¤

### 5.1 æ–‡ä»¶é‡å‘½åè®¡åˆ’

| æ“ä½œ | åŸæ–‡ä»¶å | æ–°æ–‡ä»¶å | è¯´æ˜ |
|------|----------|----------|------|
| é‡å‘½å | `SshAssistantHandler.java` | `AiSshAssistantHandler.java` | WebSocketå¤„ç†å™¨ |
| é‡å‘½å | `SshAssistantManager.java` | `AiSshAssistantManager.java` | ä¼šè¯ç®¡ç†å™¨ |
| é‡å‘½å | `SshAssistantSession.java` | `AiSshAssistantSession.java` | ä¼šè¯å®ä½“ |

### 5.2 æ–°å¢æ–‡ä»¶è®¡åˆ’

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `AiSshAssistantController.java` | HTTPæ¡æ‰‹æ¥å£ï¼ˆè¿æ¥ã€æ–­å¼€ï¼‰ |
| `AiSshAssistantService.java` | AIå¯¹è¯æœåŠ¡é€»è¾‘ |
| `SshSessionBinding.java` | ç»‘å®šå…³ç³»å®ä½“ |
| `AiSshRedisUtils.java` | Redisæ“ä½œå·¥å…·ç±»ï¼ˆä¸“ç”¨ï¼‰ |
| `SshSessionContext.java` | ThreadLocalä¸Šä¸‹æ–‡æŒæœ‰è€… |

### 5.3 å¼€å‘æ­¥éª¤

```
æ­¥éª¤1: æ–‡ä»¶é‡å‘½å
  â”œâ”€â”€ SshAssistantHandler.java â†’ AiSshAssistantHandler.java
  â”œâ”€â”€ SshAssistantManager.java â†’ AiSshAssistantManager.java
  â””â”€â”€ SshAssistantSession.java â†’ AiSshAssistantSession.java

æ­¥éª¤2: å¼€å‘åŸºç¡€å®ä½“
  â””â”€â”€ SshSessionBinding.java      - SSHä¸AIä¼šè¯ç»‘å®šå…³ç³»

æ­¥éª¤3: å¼€å‘Rediså·¥å…·ç±»
  â””â”€â”€ AiSshRedisUtils.java        - ç»‘å®šå…³ç³»ã€æ¶ˆæ¯å­˜å‚¨

æ­¥éª¤4: å¼€å‘Controllerå±‚
  â”œâ”€â”€ DTOç±»                       - è¯·æ±‚/å“åº”å¯¹è±¡
  â””â”€â”€ AiSshAssistantController.java - HTTPæ¡æ‰‹æ¥å£

æ­¥éª¤5: å¼€å‘Serviceå±‚
  â”œâ”€â”€ AiSshAssistantService.java  - AIå¯¹è¯é€»è¾‘
  â”œâ”€â”€ SshSessionContext.java      - ThreadLocalä¸Šä¸‹æ–‡
  â””â”€â”€ SshExecuteTool.java         - SSHå‘½ä»¤å·¥å…·ï¼ˆå®Œå–„ï¼‰

æ­¥éª¤6: å®Œå–„/Handlerå±‚
  â”œâ”€â”€ AiSshAssistantHandler.java  - WebSocketæ¶ˆæ¯å¤„ç†
  â””â”€â”€ WsChatMessage.java          - WebSocketæ¶ˆæ¯DTO

æ­¥éª¤7: å®Œå–„/Managerå±‚
  â””â”€â”€ AiSshAssistantManager.java  - ä¼šè¯ç®¡ç†

æ­¥éª¤8: é…ç½®WebSocketè·¯å¾„
  â””â”€â”€ AgentModelWebSocketConfig.java - æ›´æ–°è·¯ç”±é…ç½®
```

### 5.4 APIæ¥å£è®¾è®¡

#### HTTPæ¡æ‰‹æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/ai/ssh-assistant/connect` | åˆ›å»ºAIä¼šè¯ï¼Œå»ºç«‹ç»‘å®š |
| DELETE | `/api/ai/ssh-assistant/disconnect/{aiSessionId}` | æ–­å¼€AIä¼šè¯ |
| GET | `/api/ai/ssh-assistant/binding/{aiSessionId}` | è·å–ç»‘å®šä¿¡æ¯ |
| GET | `/api/ai/ssh-assistant/active/{aiSessionId}` | æ£€æŸ¥ä¼šè¯æ˜¯å¦æ´»è·ƒ |

#### WebSocketæ¥å£

| è·¯å¾„ | è¯´æ˜ |
|------|------|
| `/ws/ai/ssh-assistant/{aiSessionId}` | AIåŠ©æ‰‹WebSocketé•¿è¿æ¥ |

#### æ¶ˆæ¯æ ¼å¼

```json
// å®¢æˆ·ç«¯å‘é€
{
  "type": "chat",
  "content": "å¸®æˆ‘æŸ¥çœ‹CPUä½¿ç”¨ç‡"
}

// æœåŠ¡ç«¯å“åº”ï¼ˆæˆåŠŸï¼‰
{
  "type": "reply",
  "content": "å¥½çš„ï¼Œæ­£åœ¨ä¸ºæ‚¨æŸ¥è¯¢...",
  "timestamp": 1234567890000
}

// æœåŠ¡ç«¯å“åº”ï¼ˆé”™è¯¯ï¼‰
{
  "type": "error",
  "errorCode": "SESSION_NOT_FOUND",
  "content": "AIä¼šè¯ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¿æ¥",
  "timestamp": 1234567890000
}
```

### 5.5 Redisæ•°æ®ç»“æ„è®¾è®¡

```
# ç»‘å®šå…³ç³»ï¼ˆStringï¼Œå­˜å‚¨JSONï¼‰
ai:ssh:binding:{aiSessionId} â†’ {
  "aiSessionId": "yyy",
  "sshSessionId": "xxx",
  "agentId": "agent-001",
  "userId": "user-001",
  "createdAt": 1234567890000
}
TTL: 24å°æ—¶

# æ¶ˆæ¯åˆ—è¡¨ï¼ˆListï¼‰
ai:ssh:messages:{aiSessionId} â†’ [Message1, Message2, ...]
TTL: 24å°æ—¶

# ä¼šè¯ä¿¡æ¯ï¼ˆStringï¼Œå­˜å‚¨JSONï¼‰
ai:ssh:info:{aiSessionId} â†’ {
  "sessionId": "yyy",
  "agentId": "agent-001",
  "sshSessionId": "xxx",
  "createdAt": 1234567890000,
  "messageCount": 5,
  "summary": "å†å²å¯¹è¯æ€»ç»“..."
}
TTL: 24å°æ—¶

# WebSocketæ´»è·ƒä¼šè¯é›†åˆï¼ˆSetï¼‰
ai:ssh:ws:sessions â†’ Set<aiSessionId>
```

---

## å…­ã€æ¶æ„å¯¹æ¯”

### 6.1 ä¸¤ç§AIåŠ©æ‰‹åœºæ™¯å¯¹æ¯”

| ç‰¹æ€§ | åœºæ™¯Aï¼šå…¨å±€ä¾§è¾¹æ AIåŠ©æ‰‹ | åœºæ™¯Bï¼šä¸»æœºè¯¦æƒ…é¡µAIåŠ©æ‰‹ |
|------|------------------------|------------------------|
| **ä½ç½®** | å…¨å±€ä¾§è¾¹æ  | ä¸»æœºè¯¦æƒ…é¡µ |
| **é€šä¿¡æ–¹å¼** | HTTP REST API | WebSocketé•¿è¿æ¥ |
| **ä¼šè¯ç±»å‹** | é€šç”¨ä¼šè¯ | ä¸SSHç»ˆç«¯ç»‘å®š |
| **ä¸»æœºå…³è”** | å¯é€‰ | å¿…éœ€ï¼ˆé€šè¿‡SSH Sessionï¼‰ |
| **SSHå‘½ä»¤æ‰§è¡Œ** | ä¸æ”¯æŒ | æ”¯æŒ |
| **Controller** | ChatController | AiSshAssistantController |
| **Service** | ChatService | AiSshAssistantService |
| **Handler** | æ—  | AiSshAssistantHandler |
| **Rediså‰ç¼€** | `assistant:session:*` | `ai:ssh:*` |
| **å¼€å‘çŠ¶æ€** | âœ… å·²å®Œæˆ | âœ… å·²å®Œæˆ |

### 6.2 ä»£ç å¤ç”¨å…³ç³»

| æ–‡ä»¶ | åœºæ™¯A | åœºæ™¯B | è¯´æ˜ |
|------|-------|-------|------|
| `Message.java` | âœ… | âœ… | å…±äº« |
| `SessionInfo.java` | âœ… | - | ä»…åœºæ™¯Aä½¿ç”¨ |
| `ChatController.java` | âœ… | - | ä»…åœºæ™¯Aä½¿ç”¨ |
| `ChatService.java` | âœ… | - | ä»…åœºæ™¯Aä½¿ç”¨ |
| `ModelRedisUtils.java` | âœ… | - | ä»…åœºæ™¯Aä½¿ç”¨ |
| `AiSshAssistantController.java` | - | âœ… | ä»…åœºæ™¯Bä½¿ç”¨ |
| `AiSshAssistantService.java` | - | âœ… | ä»…åœºæ™¯Bä½¿ç”¨ |
| `AiSshAssistantHandler.java` | - | âœ… | ä»…åœºæ™¯Bä½¿ç”¨ |
| `AiSshRedisUtils.java` | - | âœ… | ä»…åœºæ™¯Bä½¿ç”¨ |

---

## ä¸ƒã€åç«¯å¼€å‘å®Œæˆæ€»ç»“

### 7.1 å¼€å‘æ­¥éª¤å®Œæˆæƒ…å†µ

| æ­¥éª¤ | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| æ­¥éª¤1 | æ–‡ä»¶é‡å‘½å | âœ… å®Œæˆ |
| æ­¥éª¤2 | åŸºç¡€å®ä½“ç±» | âœ… å®Œæˆ |
| æ­¥éª¤3 | Rediså·¥å…·ç±» | âœ… å®Œæˆ |
| æ­¥éª¤4 | Controllerå±‚ | âœ… å®Œæˆ |
| æ­¥éª¤5 | Serviceå±‚ + ThreadLocal | âœ… å®Œæˆ |
| æ­¥éª¤6 | Handlerå±‚ | âœ… å®Œæˆ |
| æ­¥éª¤7 | Managerå±‚ | âœ… å®Œæˆ |
| æ­¥éª¤8 | WebSocketè·¯å¾„é…ç½® | âœ… å®Œæˆ |

### 7.2 å·²åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆåœºæ™¯Bï¼‰

```
monitor-project/Monitor-Server/src/main/java/com/hundred/monitor/server/

â”œâ”€â”€ ai/
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â””â”€â”€ SshSessionContext.java              âœ… ThreadLocalä¸Šä¸‹æ–‡æŒæœ‰è€…
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ AiSshAssistantSession.java           âœ… ä¼šè¯å®ä½“ï¼ˆé‡å‘½åï¼‰
â”‚   â”‚   â””â”€â”€ SshSessionBinding.java              âœ… SSH-AIç»‘å®šå…³ç³»å®ä½“
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â””â”€â”€ AiSshAssistantService.java          âœ… AIå¯¹è¯æœåŠ¡
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â””â”€â”€ SshExecuteTool.java                 âœ… SSHå‘½ä»¤æ‰§è¡Œå·¥å…·
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ AiSshRedisUtils.java                âœ… Rediså·¥å…·ç±»ï¼ˆ24ä¸ªæ–¹æ³•ï¼‰
â”‚   â”œâ”€â”€ websocket/
â”‚   â”‚   â”œâ”€â”€ AgentModelWebSocketConfig.java      âœ… WebSocketé…ç½®
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â””â”€â”€ WsChatMessage.java              âœ… WebSocketæ¶ˆæ¯DTO
â”‚   â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â”‚   â””â”€â”€ AiSshAssistantHandler.java      âœ… WebSocketå¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ manager/
â”‚   â”‚       â””â”€â”€ AiSshAssistantManager.java      âœ… ä¼šè¯ç®¡ç†å™¨ï¼ˆ18ä¸ªæ–¹æ³•ï¼‰
â”‚   â””â”€â”€ controller/
â”‚       â””â”€â”€ AiSshAssistantController.java      âœ… HTTPæ¡æ‰‹æ¥å£
â”‚
â””â”€â”€ model/
    â”œâ”€â”€ request/
    â”‚   â””â”€â”€ ConnectRequest.java                 âœ… è¿æ¥è¯·æ±‚DTO
    â””â”€â”€ response/
        â””â”€â”€ ConnectResponse.java                âœ… è¿æ¥å“åº”DTO
```

### 7.3 æ ¸å¿ƒåŠŸèƒ½å®ç°

#### ThreadLocalä¸Šä¸‹æ–‡ä¼ é€’ï¼ˆæ–¹æ¡ˆBï¼‰

```
AiSshAssistantService.sendMessage()
    â”‚
    â”œâ”€ è®¾ç½® ThreadLocal
    â”‚   SshSessionContext.setSshSessionId()
    â”‚   SshSessionContext.setAgentId()
    â”‚
    â”œâ”€ è°ƒç”¨ AI æ¨¡å‹
    â”‚   model.chat(context)
    â”‚     â”‚
    â”‚     â””â”€> AI å†³å®šè°ƒç”¨å·¥å…·
    â”‚           â”‚
    â”‚           â””â”€> SshExecuteTool.executeCommand(cmd)
    â”‚                  â”‚
    â”‚                  â””â”€> ä»ThreadLocalè·å–sshSessionId
    â”‚                       SshSessionContext.get()
    â”‚
    â””â”€ æ¸…ç† ThreadLocal
        SshSessionContext.clear()
```

#### å·¥å…·è°ƒç”¨æœºåˆ¶

```java
@Tool("åœ¨SSHç»ˆç«¯æ‰§è¡Œå‘½ä»¤ï¼Œç”¨äºæ‰§è¡ŒLinuxå‘½ä»¤å¹¶æŸ¥çœ‹ç»“æœ")
public String executeCommand(String command) {
    // ä»ThreadLocalè·å–sshSessionId
    String sshSessionId = SshSessionContext.getSshSessionId();

    // è·å–SSHä¼šè¯
    SshSession sshSession = SshSessionManager.getInstance().getSession(sshSessionId);

    // å‘SSHå‘é€å‘½ä»¤
    sshSession.getOutputStream().write((command + "\n").getBytes());
    sshSession.getOutputStream().flush();

    return "å‘½ä»¤å·²å‘é€åˆ°ç»ˆç«¯ï¼Œè¯·æŸ¥çœ‹ç»ˆç«¯è¾“å‡ºç»“æœã€‚";
}
```

### 7.4 å¾…å®Œå–„é¡¹

| é¡¹ç›® | å½“å‰çŠ¶æ€ | è¯´æ˜ |
|------|----------|------|
| JWTç”¨æˆ·ID | å†™æ­» "default-user" | TODOæ ‡è®°ï¼Œå¾…é›†æˆJWT |
| è·¨åŸŸé…ç½® | `setAllowedOrigins("*")` | ç”Ÿäº§ç¯å¢ƒéœ€é™åˆ¶åŸŸå |
| SSHå‘½ä»¤è¿”å› | ä»…å‘é€ï¼ŒæœªåŒæ­¥ç­‰å¾…ç»“æœ | å¼‚æ­¥æ¨é€åˆ°å‰ç«¯ |

### 7.5 éªŒè¯æ£€æŸ¥é¡¹

| éªŒè¯é¡¹ | è¯´æ˜ |
|--------|------|
| 1. AIæ¨¡å‹é…ç½® | `application.yaml` ä¸­API keyå’Œbase-url |
| 2. RedisæœåŠ¡ | Redisæ˜¯å¦æ­£å¸¸è¿è¡Œ |
| 3. SystemMessage | LangChain4jç‰ˆæœ¬æ”¯æŒæƒ…å†µ |
| 4. å·¥å…·è°ƒç”¨ | `@Tool`æ³¨è§£è¯†åˆ«å’Œè°ƒç”¨ |

---

## å…«ã€å¼€å‘æ—¥å¿—

| æ—¥æœŸ | æ“ä½œ | çŠ¶æ€ |
|------|------|------|
| åˆå§‹ | å®Œæˆæ­¥éª¤1-4å¼€å‘ï¼ˆåœºæ™¯Aï¼‰ | âœ… å®Œæˆ |
| - | å¼€å‘æš‚åœï¼Œé‡æ–°åˆ†æéœ€æ±‚ | â¸ï¸ æš‚åœ |
| - | ç”¨æˆ·æ¾„æ¸…éœ€æ±‚ï¼Œé‡æ–°è®¾è®¡æ¶æ„ | ğŸ“‹ å·²ç¡®è®¤ |
| - | æ–‡æ¡£åŒ–äº¤æµè¿‡ç¨‹ | ğŸ“ å®Œæˆ |
| - | æ‰§è¡Œæ­¥éª¤1-8ï¼ˆåœºæ™¯Båç«¯å¼€å‘ï¼‰ | âœ… å®Œæˆ |

---

## ä¹ã€å‘½ä»¤æ‰§è¡Œç»“æœåˆ†æåŠŸèƒ½ï¼ˆV2.0ï¼‰

### 9.1 éœ€æ±‚èƒŒæ™¯

åˆå§‹å®ç°ä¸­ï¼ŒAIæ‰§è¡ŒSSHå‘½ä»¤åä»…è¿”å›"å‘½ä»¤å·²å‘é€åˆ°ç»ˆç«¯"ï¼Œæ— æ³•è·å–å‘½ä»¤çš„å®é™…æ‰§è¡Œç»“æœï¼Œä¹Ÿæ— æ³•å¯¹ç»“æœè¿›è¡Œåˆ†æã€‚è¿™å¯¼è‡´ï¼š

1. **AIæ— æ³•è·å–å‘½ä»¤è¾“å‡º**ï¼šAIçœ‹ä¸åˆ°å‘½ä»¤æ‰§è¡Œç»“æœï¼Œæ— æ³•è¿›è¡Œè¿›ä¸€æ­¥åˆ†æ
2. **å‰ç«¯çœ‹ä¸åˆ°è¾“å‡º**ï¼šç”¨æˆ·éœ€è¦åˆ‡æ¢åˆ°SSHç»ˆç«¯æŸ¥çœ‹ç»“æœ
3. **ç¼ºå°‘æ™ºèƒ½åˆ†æ**ï¼šAIæ— æ³•æ ¹æ®å‘½ä»¤è¾“å‡ºæä¾›è¿ç»´å»ºè®®

### 9.2 åŠŸèƒ½ç›®æ ‡

å®ç°å‘½ä»¤æ‰§è¡Œç»“æœçš„å®Œæ•´é“¾è·¯ï¼š

```
AIæ‰§è¡Œå‘½ä»¤ â†’ å‘é€åˆ°SSH â†’ æ•è·è¾“å‡º â†’ å®æ—¶æ¨é€å‰ç«¯
                                              â†“
                                         AIåˆ†æè¾“å‡º â†’ æ¨é€åˆ†æç»“æœ
```

### 9.3 è®¾è®¡æ–¹æ¡ˆï¼šå‘½ä»¤IDå…³è”æœºåˆ¶

#### æ ¸å¿ƒæ€è·¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å‘½ä»¤æ‰§è¡Œæµç¨‹                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. AIå†³å®šæ‰§è¡Œå‘½ä»¤ â†’ ç”Ÿæˆ commandId (æ—¶é—´æˆ³)                              â”‚
â”‚     â†“                                                                       â”‚
â”‚  2. æ³¨å†Œå‘½ä»¤ä¸Šä¸‹æ–‡: CommandContext{commandId, aiSessionId, sshSessionId}    â”‚
â”‚     â†“                                                                       â”‚
â”‚  3. å‘é€å‘½ä»¤åˆ°SSH (å¸¦èµ·æ­¢æ ‡è®°)                                             â”‚
â”‚     â”œâ”€â”€ ## COMMAND_START: {timestamp} ##                                  â”‚
â”‚     â”œâ”€â”€ {command}                                                        â”‚
â”‚     â””â”€â”€ echo '## COMMAND_END: {timestamp} ##'                           â”‚
â”‚     â†“                                                                       â”‚
â”‚  4. SSHè¾“å‡ºè¿”å›æ—¶ â†’ é€šè¿‡å‘½ä»¤IDå…³è”                                       â”‚
â”‚     â”œâ”€â”€ å®æ—¶æ¨é€ç»™å‰ç«¯ (command_output)                                  â”‚
â”‚     â”œâ”€â”€ ç¼“å­˜åˆ° CommandContext                                            â”‚
â”‚     â””â”€â”€ æ£€æµ‹ COMMAND_END æ ‡è®°                                            â”‚
â”‚     â†“                                                                       â”‚
â”‚  5. å‘½ä»¤å®Œæˆ â†’ è§¦å‘AIåˆ†æ                                                  â”‚
â”‚     â”œâ”€â”€ æ¨é€å®Œæˆæ¶ˆæ¯ (command_complete)                                   â”‚
â”‚     â”œâ”€â”€ å¼‚æ­¥è°ƒç”¨AIåˆ†æè¾“å‡º                                                â”‚
â”‚     â””â”€â”€ æ¨é€åˆ†æç»“æœ (reply)                                               â”‚
â”‚     â†“                                                                       â”‚
â”‚  6. æ¸…ç†å‘½ä»¤ä¸Šä¸‹æ–‡ (å»¶è¿Ÿ5ç§’)                                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¶æ„ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ–°å¢ç»„ä»¶                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  CommandContext (å‘½ä»¤ä¸Šä¸‹æ–‡å®ä½“)                                      â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ commandId: String        (å‘½ä»¤å”¯ä¸€æ ‡è¯† - æ—¶é—´æˆ³)                   â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ aiSessionId: String      (AIä¼šè¯ID)                               â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ sshSessionId: String     (SSHä¼šè¯ID)                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ command: String          (æ‰§è¡Œçš„å‘½ä»¤)                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ output: StringBuilder    (å‘½ä»¤è¾“å‡ºç¼“å­˜)                           â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ startTime: Long          (å¼€å§‹æ—¶é—´)                                â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ status: CommandStatus    (æ‰§è¡ŒçŠ¶æ€)                               â”‚    â”‚
â”‚  â”‚  â””â”€â”€ timeoutMillis: Long      (è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤5ç§’)                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â†“ ç®¡ç†å‘½ä»¤ä¸Šä¸‹æ–‡                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  CommandContextManager (å‘½ä»¤ä¸Šä¸‹æ–‡ç®¡ç†å™¨)                            â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ registerCommand()   æ³¨å†Œå‘½ä»¤                                    â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ appendOutput()       è¿½åŠ è¾“å‡ºåˆ°ç¼“å­˜                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ completeCommand()    æ ‡è®°å‘½ä»¤å®Œæˆ                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ handleTimeout()      å¤„ç†å‘½ä»¤è¶…æ—¶                                â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ cleanup()            æ¸…ç†å‘½ä»¤ä¸Šä¸‹æ–‡                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ pushOutputToFrontend() å®æ—¶æ¨é€è¾“å‡ºç»™å‰ç«¯                       â”‚    â”‚
â”‚  â”‚  â””â”€â”€ triggerAiAnalysis()   å¼‚æ­¥è§¦å‘AIåˆ†æ                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  CommandTimeoutScheduler (è¶…æ—¶å®šæ—¶ä»»åŠ¡)                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ @Scheduled(fixedDelay=1000)  æ¯1ç§’æ£€æŸ¥è¶…æ—¶                      â”‚    â”‚
â”‚  â”‚  â””â”€â”€ éå†æ‰€æœ‰EXECUTINGçŠ¶æ€çš„å‘½ä»¤ï¼Œæ£€æŸ¥æ˜¯å¦è¶…æ—¶                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  AsyncConfig (å¼‚æ­¥é…ç½®)                                               â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ @EnableAsync                                                       â”‚    â”‚
â”‚  â”‚  â””â”€â”€ commandAnalysisExecutor (çº¿ç¨‹æ± : 2æ ¸å¿ƒ, 5æœ€å¤§, 100é˜Ÿåˆ—)         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.4 å®Œæ•´äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·: "å¸®æˆ‘æŸ¥çœ‹CPUä½¿ç”¨ç‡"                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AiSshAssistantService.sendMessage()                                           â”‚
â”‚  â”œâ”€â”€ è·å–ç»‘å®šå…³ç³» (aiSessionId â†” sshSessionId â†” agentId)                        â”‚
â”‚  â”œâ”€â”€ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° Redis                                                          â”‚
â”‚  â”œâ”€â”€ æ„å»ºAIä¸Šä¸‹æ–‡ (ç³»ç»Ÿæç¤ºè¯ + ä¸»æœºä¿¡æ¯ + å†å²æ¶ˆæ¯)                            â”‚
â”‚  â””â”€â”€ è®¾ç½® ThreadLocal ä¸Šä¸‹æ–‡:                                                    â”‚
â”‚      â”œâ”€â”€ SshSessionContext.setSshSessionId(sshSessionId)                        â”‚
â”‚      â”œâ”€â”€ SshSessionContext.setAgentId(agentId)                                â”‚
â”‚      â””â”€â”€ SshSessionContext.setAiSessionId(aiSessionId)  â† æ–°å¢                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIå¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼Œå†³å®šè°ƒç”¨å·¥å…·                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  SshExecuteTool.executeCommand("top -n 1")                               â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ ä» ThreadLocal è·å–ä¸Šä¸‹æ–‡                                          â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ sshSessionId = SshSessionContext.getSshSessionId()           â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€ aiSessionId = SshSessionContext.getAiSessionId()               â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ CommandContextManager.registerCommand()                           â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ ç”Ÿæˆ commandId = UUID.randomUUID().toString()              â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ ç”Ÿæˆæ—¶é—´æˆ³ timestamp = System.currentTimeMillis()          â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€ å­˜å‚¨åˆ° commandMap å’Œ activeCommands                             â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ å‘é€å‘½ä»¤åˆ°SSH OutputStream                                           â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ "\n## COMMAND_START: " + timestamp + " ##\n"                   â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ command + "\n"                                                â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€ "echo '## COMMAND_END: " + timestamp + " ##'\n"              â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â””â”€ è¿”å›: "æ­£åœ¨æ‰§è¡Œå‘½ä»¤: top -n 1 (å‘½ä»¤ID: abc-123...)"                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SSHè¾“å‡ºè¿”å› â†’ SshWebSocketHandler.sendToWebSocket()                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ£€æµ‹æ˜¯å¦æœ‰å…³è”çš„AIå‘½ä»¤ (é€šè¿‡ sshSessionId)                                 â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ CommandContextManager.appendOutput(sshSessionId, output)        â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ è¿½åŠ è¾“å‡ºåˆ° CommandContext.output                            â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€ æ¨é€: WsChatMessage("command_output", output) â†’ å‰ç«¯        â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â””â”€ æ£€æµ‹ COMMAND_END æ ‡è®°                                                 â”‚    â”‚
â”‚  â”‚        â”‚                                                                  â”‚    â”‚
â”‚  â”‚        â””â”€ CommandContextManager.completeCommand(sshSessionId)         â”‚    â”‚
â”‚  â”‚            â”œâ”€â”€ æ ‡è®°çŠ¶æ€ä¸º COMPLETED                                       â”‚    â”‚
â”‚  â”‚            â”œâ”€â”€ ä» activeCommands ç§»é™¤                                   â”‚    â”‚
â”‚  â”‚            â”œâ”€â”€ æ¨é€: WsChatMessage("command_complete")                   â”‚    â”‚
â”‚  â”‚            â””â”€â”€ @Async triggerAiAnalysis(context)                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼‚æ­¥AIåˆ†æ (commandAnalysisExecutor çº¿ç¨‹æ± )                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  AiSshAssistantService.analyzeCommandOutput(command, output)            â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ æ„å»ºåˆ†æ prompt:                                                     â”‚    â”‚
â”‚  â”‚    â”‚   "è¯·åˆ†æä»¥ä¸‹å‘½ä»¤çš„æ‰§è¡Œç»“æœ..."                                     â”‚    â”‚
â”‚  â”‚    â”‚   "## å‘½ä»¤: top -n 1"                                               â”‚    â”‚
â”‚  â”‚    â”‚   "## è¾“å‡º: ..."                                                   â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â”œâ”€ ç›´æ¥è°ƒç”¨ AI æ¨¡å‹ (ä¸ä½¿ç”¨ Assistantï¼Œé¿å…å¾ªç¯å·¥å…·è°ƒç”¨)              â”‚    â”‚
â”‚  â”‚    â”‚   â”œâ”€â”€ SystemMessage: ç³»ç»Ÿæç¤ºè¯                                     â”‚    â”‚
â”‚  â”‚    â”‚   â””â”€â”€ UserMessage: åˆ†æ prompt                                     â”‚    â”‚
â”‚  â”‚    â”‚                                                                      â”‚    â”‚
â”‚  â”‚    â””â”€ è¿”å›åˆ†æç»“æœ                                                        â”‚    â”‚
â”‚  â”‚       "æ ¹æ®å‘½ä»¤è¾“å‡ºåˆ†æï¼šCPUä½¿ç”¨ç‡ä¸º35%ï¼Œå†…å­˜ä½¿ç”¨ç‡ä¸º60%ï¼Œ"                â”‚    â”‚
â”‚  â”‚       "å½“å‰æœ‰3ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œè´Ÿè½½æ­£å¸¸..."                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚    â”‚                                                                      â”‚    â”‚
â”‚    â””â”€ AiSshAssistantManager.sendReply(aiSessionId, analysis)               â”‚
â”‚        â””â”€ æ¨é€: WsChatMessage("reply", åˆ†æç»“æœ) â†’ å‰ç«¯                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å»¶è¿Ÿæ¸…ç† (5ç§’å)                                                                 â”‚
â”‚  â””â”€ CommandContextManager.cleanup(commandId)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.5 WebSocketæ¶ˆæ¯åè®®æ‰©å±•

| æ¶ˆæ¯ç±»å‹ | æ–¹å‘ | è¯´æ˜ | ç¤ºä¾‹å†…å®¹ |
|---------|------|------|----------|
| `command_output` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | å‘½ä»¤å®æ—¶è¾“å‡º | SSHè¾“å‡ºçš„åŸå§‹å†…å®¹ |
| `command_complete` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | å‘½ä»¤æ‰§è¡Œå®Œæˆ | "å‘½ä»¤æ‰§è¡Œå®Œæˆ" |
| `command_timeout` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | å‘½ä»¤æ‰§è¡Œè¶…æ—¶ | "å‘½ä»¤æ‰§è¡Œè¶…æ—¶" |
| `reply` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | AIåˆ†æç»“æœ | "æ ¹æ®å‘½ä»¤è¾“å‡ºåˆ†æï¼šCPUä½¿ç”¨ç‡ä¸º35%..." |

### 9.6 è¶…æ—¶å¤„ç†æœºåˆ¶

```
CommandTimeoutScheduler (æ¯1ç§’æ‰§è¡Œ)
â”œâ”€â”€ éå†æ‰€æœ‰ EXECUTING çŠ¶æ€çš„å‘½ä»¤
â”œâ”€â”€ æ£€æŸ¥: System.currentTimeMillis() - startTime > timeoutMillis
â”œâ”€â”€ è¶…æ—¶åˆ™:
â”‚   â”œâ”€â”€ æ ‡è®°çŠ¶æ€ä¸º TIMEOUT
â”‚   â”œâ”€â”€ ä» activeCommands ç§»é™¤
â”‚   â”œâ”€â”€ æ¨é€: WsChatMessage("command_timeout")
â”‚   â””â”€â”€ ä»ç„¶è§¦å‘ AI åˆ†æ (åŸºäºå·²æ”¶é›†çš„è¾“å‡º)
â””â”€â”€ æœªè¶…æ—¶åˆ™ç»§ç»­ç­‰å¾…
```

### 9.7 æ–°å¢æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `ai/command/CommandStatus.java` | å‘½ä»¤çŠ¶æ€æšä¸¾ï¼ˆEXECUTING, COMPLETED, TIMEOUT, ERRORï¼‰ |
| `ai/command/CommandContext.java` | å‘½ä»¤ä¸Šä¸‹æ–‡å®ä½“ç±» |
| `ai/command/CommandContextManager.java` | å‘½ä»¤ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰ |
| `ai/command/CommandTimeoutScheduler.java` | å‘½ä»¤è¶…æ—¶å®šæ—¶ä»»åŠ¡ |
| `ai/config/AsyncConfig.java` | å¼‚æ­¥é…ç½®ç±»ï¼ˆå‘½ä»¤åˆ†æçº¿ç¨‹æ± ï¼‰ |

### 9.8 ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨å†…å®¹ |
|------|----------|
| `ai/context/SshSessionContext.java` | æ–°å¢ `aiSessionId` ThreadLocal å­—æ®µ |
| `ai/service/AiSshAssistantService.java` | æ–°å¢ `analyzeCommandOutput()` æ–¹æ³• |
| `ai/tools/SshExecuteTool.java` | é›†æˆå‘½ä»¤ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œå‘é€æ—¶é—´æˆ³æ ‡è®° |
| `websocket/SshWebSocketHandler.java` | å…³è”å‘½ä»¤è¾“å‡ºåˆ°ä¸Šä¸‹æ–‡ |
| `ai/websocket/manager/AiSshAssistantManager.java` | æ–°å¢ `sendReply()` æ–¹æ³• |

### 9.9 æŠ€æœ¯è¦ç‚¹

#### 1. ThreadLocal ä¸Šä¸‹æ–‡ä¼ é€’

```java
// AiSshAssistantService.sendMessage() ä¸­è®¾ç½®
SshSessionContext.setAiSessionId(binding.getAiSessionId());

// SshExecuteTool.executeCommand() ä¸­è·å–
String aiSessionId = SshSessionContext.getAiSessionId();
String sshSessionId = SshSessionContext.getSshSessionId();
```

#### 2. å‘½ä»¤æ ‡è®°æ ¼å¼

```bash
# ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºæ ‡è®°ï¼Œé¿å…å†²çª
## COMMAND_START: 1738657200000 ##
<command>
## COMMAND_END: 1738657200000 ##
```

#### 3. ä¸²è¡Œæ‰§è¡Œä¿è¯

```java
// ä¸€ä¸ªSSHä¼šè¯åŒæ—¶åªæ‰§è¡Œä¸€ä¸ªå‘½ä»¤
private final ConcurrentHashMap<String, String> activeCommands = new ConcurrentHashMap<>();
// key: sshSessionId, value: commandId
```

#### 4. å¼‚æ­¥åˆ†æé…ç½®

```java
@Configuration
@EnableAsync
public class AsyncConfig {
    @Bean(name = "commandAnalysisExecutor")
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(2);
        executor.setMaxPoolSize(5);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("cmd-analysis-");
        executor.initialize();
        return executor;
    }
}
```

### 9.10 éªŒè¯æ£€æŸ¥é¡¹

| æ£€æŸ¥é¡¹ | è¯´æ˜ |
|--------|------|
| 1. ç¼–è¯‘éªŒè¯ | `mvn clean compile` æˆåŠŸ |
| 2. å‘½ä»¤æ³¨å†Œ | commandId æ­£ç¡®ç”Ÿæˆå’Œå­˜å‚¨ |
| 3. è¾“å‡ºå…³è” | SSHè¾“å‡ºæ­£ç¡®å…³è”åˆ°å‘½ä»¤ä¸Šä¸‹æ–‡ |
| 4. å®æ—¶æ¨é€ | command_output æ¶ˆæ¯å®æ—¶æ¨é€ |
| 5. å®Œæˆæ£€æµ‹ | COMMAND_END æ ‡è®°æ­£ç¡®æ£€æµ‹ |
| 6. å¼‚æ­¥åˆ†æ | AIåˆ†ææ­£ç¡®è§¦å‘å’Œæ‰§è¡Œ |
| 7. è¶…æ—¶å¤„ç† | è¶…æ—¶å‘½ä»¤æ­£ç¡®å¤„ç† |
| 8. ä¸Šä¸‹æ–‡æ¸…ç† | å‘½ä»¤ä¸Šä¸‹æ–‡æ­£ç¡®æ¸…ç† |

### 9.11 å¼€å‘æäº¤è®°å½•

| æäº¤ | è¯´æ˜ | æ—¥æœŸ |
|------|------|------|
| bbeaf6c | é‡æ„AIæ¨¡å—ï¼šåœºæ™¯åˆ†ç¦»ä¸å·¥å…·è°ƒç”¨ä¼˜åŒ– | 2025-02-04 |
| bc065c6 | å®ç°AIå‘½ä»¤æ‰§è¡Œç»“æœåˆ†æåŠŸèƒ½ | 2025-02-04 |

---

*æ–‡æ¡£æ›´æ–°æ—¶é—´ï¼š2025å¹´2æœˆ4æ—¥*
*æœ€åæ›´æ–°ï¼šå‘½ä»¤æ‰§è¡Œç»“æœåˆ†æåŠŸèƒ½ï¼ˆV2.0ï¼‰*
