# 参考文档

## 概述

本文档提供 Monitor 系统的 API 接口、数据模型、配置项等技术参考。

**文档版本**：v1.0.0
**更新日期**：2026-02-02

---

## 1. API 参考 - Server 端

### 1.1 认证授权 API

**基础路径**：`/api/auth`

#### POST /api/auth/login

用户登录

**请求体**：
```json
{
  "username": "admin",
  "password": "password123"
}
```

**响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "userId": 1,
      "username": "admin",
      "email": "admin@example.com",
      "nickname": "管理员",
      "userRole": "ADMIN"
    }
  }
}
```

#### POST /api/auth/register

用户注册（需要邮箱验证码）

**请求体**：
```json
{
  "username": "newuser",
  "email": "user@example.com",
  "password": "password123",
  "verificationCode": "123456"
}
```

#### POST /api/auth/logout

用户登出

**请求头**：`Authorization: Bearer {token}`

#### POST /api/auth/refresh

刷新Token

**请求体**：
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### GET /api/auth/validate

验证Token有效性

**请求头**：`Authorization: Bearer {token}`

#### POST /api/auth/reset-password

重置密码

**请求体**：
```json
{
  "email": "user@example.com",
  "newPassword": "newPassword123",
  "resetToken": "token_from_email"
}
```

#### POST /api/auth/ask-code

请求邮箱验证码

**请求体**：
```json
{
  "email": "user@example.com"
}
```

---

### 1.2 Agent 管理 API

**基础路径**：`/api/v1`

#### POST /api/v1/customer/register

Agent注册

**请求体**：
```json
{
  "hostname": "server-01",
  "ip": "192.168.1.100",
  "basicInfo": {
    "cpuModel": "Intel Xeon Gold 6248",
    "cpuCores": 24,
    "memoryGb": 64,
    "gpuInfo": [{"name": "NVIDIA T4", "memoryGb": 16}],
    "networkInterfaces": ["eth0", "eth1"]
  }
}
```

**响应**：
```json
{
  "success": true,
  "agentId": "AGT_20240115_ABCD1234",
  "agentName": "生产服务器-01",
  "authToken": "jwt_token_here"
}
```

#### POST /api/v1/agent/basic

基本数据上报

**请求头**：`Authorization: Bearer {agent_token}`

**请求体**：
```json
{
  "agentId": "AGT_20240115_ABCD1234",
  "timestamp": "2024-01-15T10:30:00Z",
  "basicInfo": {
    "hostname": "server-01",
    "cpuModel": "Intel Xeon Gold 6248",
    "cpuCores": 24,
    "memoryGb": 64,
    "gpuInfo": [{"name": "NVIDIA T4", "memoryGb": 16}],
    "networkInterfaces": ["eth0", "eth1"]
  }
}
```

#### POST /api/v1/agent/metrics

运行时指标上报

**请求头**：`Authorization: Bearer {agent_token}`

**请求体**：
```json
{
  "agentId": "AGT_20240115_ABCD1234",
  "timestamp": "2024-01-15T10:30:15Z",
  "metrics": {
    "cpuPercent": 45.2,
    "memoryPercent": 67.8,
    "diskUsages": [
      {"mount": "/", "usedPercent": 65.0},
      {"mount": "/data", "usedPercent": 80.0}
    ],
    "networkUpMbps": 12.5,
    "networkDownMbps": 8.3,
    "sshRunning": true,
    "sshPortListening": true,
    "sshPort": 22
  }
}
```

#### POST /api/v1/agent/config

配置更新接收（Agent端接口）

---

### 1.3 监控数据 API

**基础路径**：`/api/monitor`

#### GET /api/monitor/getMonitorList

获取所有Agent列表

**请求头**：`Authorization: Bearer {token}`

**响应**：
```json
{
  "code": 200,
  "data": [
    {
      "agentId": "AGT_20240115_ABCD1234",
      "agentName": "生产服务器-01",
      "hostname": "server-01",
      "ip": "192.168.1.100",
      "cpuModel": "Intel Xeon Gold 6248",
      "cpuCores": 24,
      "memoryGb": 64,
      "online": true,
      "lastSeen": "2024-01-15T10:30:15Z"
    }
  ]
}
```

#### GET /api/monitor/{agentId}/metrics/latest

获取Agent最新指标

**请求头**：`Authorization: Bearer {token}`

**路径参数**：
- `agentId`: Agent ID

**响应**：
```json
{
  "code": 200,
  "data": {
    "agentId": "AGT_20240115_ABCD1234",
    "cpuPercent": 45.2,
    "memoryPercent": 67.8,
    "diskUsages": [
      {"mount": "/", "usedPercent": 65.0}
    ],
    "networkUpMbps": 12.5,
    "networkDownMbps": 8.3,
    "timestamp": "2024-01-15T10:30:15Z"
  }
}
```

#### GET /api/monitor/{agentId}/metrics/history

获取Agent历史指标

**请求头**：`Authorization: Bearer {token}`

**路径参数**：
- `agentId`: Agent ID

**查询参数**：
- `type`: 指标类型 (cpu/memory/disk/network)
- `range`: 时间范围 (15m/1h/6h/24h/7d)
- `aggregate`: 聚合方式 (avg/max/min)

**响应**：
```json
{
  "code": 200,
  "data": {
    "agentId": "AGT_20240115_ABCD1234",
    "type": "cpu",
    "range": "1h",
    "datapoints": [
      {"timestamp": "2024-01-15T10:00:00Z", "value": 45.2},
      {"timestamp": "2024-01-15T10:15:00Z", "value": 47.8}
    ]
  }
}
```

---

### 1.4 SSH 管理 API

**基础路径**：`/api/v1/ssh`

#### POST /api/v1/ssh/connect

建立SSH连接

**请求头**：`Authorization: Bearer {token}`

**请求体**：
```json
{
  "agentId": "AGT_20240115_ABCD1234",
  "username": "root",
  "password": "password123",
  "port": 22
}
```

**响应**：
```json
{
  "success": true,
  "sessionId": "ssh-session-uuid-1234"
}
```

#### POST /api/v1/ssh/disconnect

断开SSH连接

**请求头**：`Authorization: Bearer {token}`

**请求体**：
```json
{
  "sessionId": "ssh-session-uuid-1234"
}
```

#### POST /api/v1/ssh/command

发送SSH命令

**请求头**：`Authorization: Bearer {token}`

**请求体**：
```json
{
  "sessionId": "ssh-session-uuid-1234",
  "command": "ls -la"
}
```

#### GET /api/v1/ssh/credential/{agentId}

获取已保存的SSH凭证

**请求头**：`Authorization: Bearer {token}`

**路径参数**：
- `agentId`: Agent ID

**响应**：
```json
{
  "username": "root",
  "password": "******"  // 不返回明文密码
}
```

---

### 1.5 健康 API

#### GET /api/health

服务健康检查

**响应**：
```json
{
  "status": "UP",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

---

## 2. WebSocket 接口

### SSH 终端连接

**端点**：`ws://server/api/v1/ssh/terminal/{sessionId}`

**连接步骤**：
1. 调用 `POST /api/v1/ssh/connect` 获取 `sessionId`
2. 使用 `sessionId` 建立 WebSocket 连接
3. 双向通信：发送用户输入，接收终端输出

**消息格式**：
```json
// 客户端发送
{
  "type": "input",
  "data": "ls -la\n"
}

// 服务端返回
{
  "type": "output",
  "data": "total 64\ndrwxr-xr-x  2 root root 4096 ..."
}
```

---

## 3. 数据模型

### 3.1 请求 DTO

#### RegisterRequest
```java
public class RegisterRequest {
    private String hostname;
    private String ip;
    private BasicInfo basicInfo;
}
```

#### BasicInfo
```java
public class BasicInfo {
    private String cpuModel;
    private Integer cpuCores;
    private Long memoryGb;
    private List<GpuInfo> gpuInfo;
    private List<String> networkInterfaces;
}
```

#### MetricsReportRequest
```java
public class MetricsReportRequest {
    private String agentId;
    private Long timestamp;
    private Metrics metrics;
}
```

#### Metrics
```java
public class Metrics {
    private Double cpuPercent;
    private Double memoryPercent;
    private List<DiskUsage> diskUsages;
    private Double networkUpMbps;
    private Double networkDownMbps;
    private Boolean sshRunning;
    private Boolean sshPortListening;
    private Integer sshPort;
}
```

### 3.2 响应 DTO

#### CommonResponse<T>
```java
public class CommonResponse<T> {
    private Integer code;
    private String message;
    private T data;
}
```

#### RegisterResponse
```java
public class RegisterResponse {
    private Boolean success;
    private String agentId;
    private String agentName;
    private String authToken;
}
```

### 3.3 实体模型

#### Agent
```java
@Entity
public class Agent {
    private String agentId;
    private String agentName;
    private String hostname;
    private String ip;
    private String cpuModel;
    private Integer cpuCores;
    private Long memoryGb;
    private String gpuInfo;  // JSON
    private String networkInterfaces;  // JSON
    private LocalDateTime registeredAt;
    private LocalDateTime updatedAt;
}
```

#### AgentMetrics
```java
@Entity
public class AgentMetrics {
    private Long id;
    private String agentId;
    private Double cpuPercent;
    private Double memoryPercent;
    private String diskUsages;  // JSON
    private Double networkUpMbps;
    private Double networkDownMbps;
    private Boolean sshRunning;
    private Boolean sshPortListening;
    private Integer sshPort;
    private Long timestamp;
}
```

#### User
```java
@Entity
public class User {
    private Long userId;
    private String username;
    private String email;
    private String password;
    private String nickname;
    private String phoneNumber;
    private String sex;
    private String userRole;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

#### SshCredential
```java
@Entity
public class SshCredential {
    private Long id;
    private String agentId;
    private String username;
    private String password;  // TODO: 加密存储
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

---

## 4. 配置项参考

### 4.1 Server 配置

**配置文件**：`Monitor-Server/src/main/resources/application.yaml`

```yaml
server:
  port: 8080

spring:
  application:
    name: monitor-server

  datasource:
    url: jdbc:mysql://localhost:3306/monitor
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver

  redis:
    host: localhost
    port: 6379
    database: 0

  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest

# JWT配置
jwt:
  secret: monitor-server-jwt-secret-key-change-in-production
  expiration: 86400000  # 24小时(ms)
  refresh-expiration: 604800000  # 7天(ms)

# 邮件配置
spring.mail:
  host: smtp.163.com
  port: 465
  username: your_email@163.com
  password: your_mail_password
  properties:
    mail.smtp.ssl.enable: true

# MyBatis-Plus配置
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: auto
```

### 4.2 Agent 配置

**配置文件**：`Monitor-Agent/src/main/resources/agent-config.yaml`

```yaml
# 服务端地址列表
server:
  endpoints:
    - "http://localhost:8080"
    - "http://backup-server:8080"

# Agent信息（注册后自动填充）
agent:
  id: ""
  name: ""
  registered_at: ""

# 认证信息（注册后自动填充）
auth:
  token: ""
  token_expires: ""

# 上报配置
reporting:
  basic_interval_sec: 600    # 基本数据上报间隔(秒)
  metrics_interval_sec: 15   # 指标数据上报间隔(秒)

# 健康检查配置
health_check:
  enabled: true
  interval_sec: 30
  timeout_sec: 5
```

---

## 5. 错误码参考

### 5.1 HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 201 | 创建成功 |
| 400 | 请求参数错误 |
| 401 | 未认证 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 5.2 业务错误码

| 错误码 | 说明 |
|--------|------|
| 1001 | 用户名或密码错误 |
| 1002 | 用户已存在 |
| 1003 | 验证码错误或过期 |
| 1004 | Token无效或过期 |
| 2001 | Agent未注册 |
| 2002 | Agent注册失败 |
| 2003 | 数据上报失败 |
| 3001 | SSH连接失败 |
| 3002 | SSH会话不存在 |
| 3003 | SSH凭证无效 |

---

## 6. 技术栈

### 6.1 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Java | 17 | 编程语言 |
| Spring Boot | 3.5.10 | 应用框架 |
| Spring Security | - | 安全框架 |
| MyBatis-Plus | 3.5.15 | ORM框架 |
| OSHI | 6.4.3/6.6.5 | 系统信息采集 |
| JSch | 0.1.55 | SSH连接 |
| JWT | 0.11.5 | Token认证 |
| WebSocket | - | 实时通信 |
| RabbitMQ | - | 消息队列 |
| Redis | - | 缓存 |
| MySQL | 8.0+ | 关系数据库 |
| Jackson | - | JSON序列化 |
| Lombok | - | 代码简化 |
| SnakeYAML | - | YAML解析 |
| Resilience4j | - | 容错重试 |
| OpenFeign | - | HTTP客户端 |

### 6.2 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue | 3.5.26 | 前端框架 |
| TypeScript | ~5.9.3 | 编程语言 |
| Vite | 7.3.1 | 构建工具 |
| Element Plus | 2.13.1 | UI组件库 |
| ECharts | 5.5.1 | 图表库 |
| xterm.js | 5.5.0 | 终端模拟器 |
| Pinia | 3.0.4 | 状态管理 |
| Vue Router | 4.6.4 | 路由管理 |
| Axios | 1.13.4 | HTTP客户端 |

### 6.3 依赖服务版本

| 服务 | 推荐版本 | 说明 |
|------|----------|------|
| MySQL | 8.0+ | 关系数据库 |
| Redis | 6.0+ | 缓存服务 |
| RabbitMQ | 3.8+ | 消息队列 |
| Node.js | 20.19.0+ 或 22.12.0+ | 前端开发环境 |

---

## 7. 数据库 Schema

### user 表
```sql
CREATE TABLE user (
    user_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_role VARCHAR(20),
    username VARCHAR(50) UNIQUE,
    email VARCHAR(100) UNIQUE,
    password VARCHAR(255),
    nickname VARCHAR(50),
    phone_number VARCHAR(20),
    sex VARCHAR(10),
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### agent 表
```sql
CREATE TABLE agent (
    agent_id VARCHAR(50) PRIMARY KEY,
    agent_name VARCHAR(100),
    hostname VARCHAR(100),
    ip VARCHAR(50),
    cpu_model VARCHAR(100),
    cpu_cores INT,
    memory_gb BIGINT,
    gpu_info JSON,
    network_interfaces JSON,
    registered_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### agent_metrics 表
```sql
CREATE TABLE agent_metrics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    agent_id VARCHAR(50),
    cpu_percent DOUBLE,
    memory_percent DOUBLE,
    disk_usages JSON,
    network_up_mbps DOUBLE,
    network_down_mbps DOUBLE,
    ssh_running BOOLEAN,
    ssh_port_listening BOOLEAN,
    ssh_port INT,
    timestamp BIGINT,
    FOREIGN KEY (agent_id) REFERENCES agent(agent_id)
);
```

### ssh_credential 表
```sql
CREATE TABLE ssh_credential (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    agent_id VARCHAR(50) UNIQUE,
    username VARCHAR(50),
    password VARCHAR(255),  -- TODO: 加密存储
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (agent_id) REFERENCES agent(agent_id)
);
```

---

## 8. Redis 缓存结构

| Key | 类型 | 说明 | 过期时间 |
|-----|------|------|----------|
| `auth:token:{userId}` | String | 用户Token | 24小时 |
| `auth:refresh:{userId}` | String | 刷新Token | 7天 |
| `auth:code:{email}` | String | 邮箱验证码 | 5分钟 |
| `agent:online:{agentId}` | String | Agent在线状态 | 30秒 |
