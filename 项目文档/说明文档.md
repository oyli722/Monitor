# 说明文档

## 项目概述

**版本**：v1.0.0
**更新日期**：2026-02-02
**项目名称**：服务器运维监控系统 (Monitor)

### 项目简介

本系统是一个采用客户端-服务端架构的服务器运维监控平台，提供以下核心功能：

- **主机监控**：实时采集和展示服务器硬件信息与运行指标（CPU、内存、磁盘、网络）
- **Web SSH终端**：通过浏览器直接连接目标主机，无需本地SSH客户端
- **数据可视化**：以图表形式展示历史监控数据

### 系统架构

```
┌─────────────────────────────────────────────────────┐
│              Monitor-Web (Vue 3 前端)                │
│           仪表盘 | 主机监控 | SSH终端                 │
└──────────────────────┬──────────────────────────────┘
                       │ HTTP/WebSocket
                       ▼
┌─────────────────────────────────────────────────────┐
│            Monitor-Server (Spring Boot)              │
│  Agent管理 | 指标存储 | SSH代理 | 认证授权             │
│    MySQL  |  Redis  |  RabbitMQ  |  WebSocket       │
└──────────────────────┬──────────────────────────────┘
                       │ HTTP 注册/上报
                       ▼
┌─────────────────────────────────────────────────────┐
│         Monitor-Agent (部署在被监控主机)              │
│     自动注册 | 数据采集 | 定时上报 | 配置更新          │
└─────────────────────────────────────────────────────┘
```

### 已实现功能清单

| 模块 | 功能 | 状态 |
|------|------|------|
| Agent | 自动注册 | ✅ 已实现 |
| Agent | 双频数据上报 | ✅ 已实现 |
| Agent | 系统信息采集(OSHI) | ✅ 已实现 |
| Server | Agent管理 | ✅ 已实现 |
| Server | 指标存储(MySQL) | ✅ 已实现 |
| Server | SSH WebSocket代理 | ✅ 已实现 |
| Server | JWT认证授权 | ✅ 已实现 |
| Server | 邮件验证(RabbitMQ) | ✅ 已实现 |
| Web | 登录/注册 | ✅ 已实现 |
| Web | 主机监控仪表盘 | ✅ 已实现 |
| Web | SSH终端(xterm.js) | ✅ 已实现 |
| Web | AI助手界面 | ⚠️ 未实现 |
| Web | 用户管理界面 | ⚠️ 未实现 |

### 未实现功能

| 功能 | 说明 |
|------|------|
| AI助手后端 | 前端UI不完整，后端Controller缺失 |
| 用户管理API | 前端有页面，后端无接口 |
| InfluxDB时序存储 | 依赖已引入但未使用 |
| SSH凭证加密 | 当前明文存储 |

---

## 快速开始

### 环境要求

**硬件要求**：
- CPU: 2核及以上
- 内存: 4GB及以上
- 磁盘: 20GB及以上

**软件依赖**：
- Java 17+
- Node.js 20.19.0+ 或 22.12.0+
- MySQL 8.0+
- Redis 6.0+
- RabbitMQ 3.8+

### 一键部署（开发环境）

```bash
# 1. 启动依赖服务
# MySQL、Redis、RabbitMQ 需提前安装并启动

# 2. 启动Server
cd monitor-project/Monitor-Server
mvn spring-boot:run

# 3. 启动Agent（在另一台机器上）
cd monitor-project/Monitor-Agent
mvn spring-boot:run

# 4. 启动Web前端
cd monitor-project/Monitor-Web
npm install  # 首次运行
npm run dev
```

### 验证安装

| 组件 | 访问地址 | 说明 |
|------|----------|------|
| Server API | http://localhost:8080/api/health | 健康检查 |
| Agent | http://localhost:8081/agent/config | 配置接口 |
| Web前端 | http://localhost:5173 | Vite开发服务器 |

---

## 详细安装指南

### Server 安装

```bash
cd monitor-project/Monitor-Server

# 配置数据库
# 编辑 src/main/resources/application.yaml
# 修改MySQL、Redis、RabbitMQ连接信息

# 初始化数据库
# 执行 src/main/resources/sql/init.sql

# 构建并运行
mvn clean package
java -jar target/Monitor-Server-1.0.0.jar
```

### Agent 安装

```bash
cd monitor-project/Monitor-Agent

# 配置服务端地址
# 编辑 src/main/resources/agent-config.yaml
# 修改 server.endpoints

# 构建并运行
mvn clean package
java -jar target/Monitor-Agent-1.0.0.jar
```

**Agent首次启动流程**：
1. 检查本地是否有 `agent_id`（已注册）
2. 未注册则向服务端发送注册请求
3. 服务端返回 `agent_id`、`agent_name`、`auth_token`
4. 保存到本地配置文件，开始数据上报

### Web 前端部署

```bash
cd monitor-project/Monitor-Web

# 开发模式
npm run dev

# 生产构建
npm run build
# 输出目录: dist/
```

---

## 配置说明

### Server 配置

**配置文件位置**：`Monitor-Server/src/main/resources/application.yaml`

```yaml
# 数据库配置
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/monitor
    username: root
    password: your_password

  # Redis配置
  redis:
    host: localhost
    port: 6379

  # RabbitMQ配置
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest

# JWT配置
jwt:
  secret: monitor-server-jwt-secret-key...
  expiration: 86400000  # 24小时

# 邮件配置
mail:
  host: smtp.163.com
  username: your_email@163.com
  password: your_mail_password
```

### Agent 配置

**配置文件位置**：`Monitor-Agent/src/main/resources/agent-config.yaml`

```yaml
# 服务端地址列表（自动选择最快的服务器）
server:
  endpoints:
    - "http://localhost:8080"
    - "http://backup-server:8080"

# Agent信息（注册后自动填充）
agent:
  id: ""          # 注册后自动生成
  name: ""        # 注册后自动生成
  registered_at: ""

# 认证信息（注册后自动填充）
auth:
  token: ""
  token_expires: ""

# 上报配置
reporting:
  basic_interval_sec: 600    # 基本数据上报间隔（10分钟）
  metrics_interval_sec: 15   # 指标数据上报间隔（15秒）
```

---

## 使用指南

### 用户注册与登录

1. **注册账号**
   - 访问系统首页，点击"注册"
   - 填写用户名、邮箱、密码
   - 输入邮箱验证码
   - 提交注册

2. **登录系统**
   - 输入用户名/邮箱和密码
   - 点击"登录"
   - 成功后进入仪表盘

3. **忘记密码**
   - 点击"忘记密码"
   - 输入注册邮箱
   - 查收重置邮件
   - 点击链接重置密码

### 主机监控

1. **查看主机列表**
   - 进入"主机监控"页面
   - 查看所有已注册主机
   - 显示主机在线状态、资源使用率

2. **查看主机详情**
   - 点击主机卡片
   - 查看基本信息（CPU、内存、磁盘）
   - 查看实时监控图表
   - 查看历史数据趋势

3. **监控指标说明**
   - **CPU使用率**：处理器占用百分比
   - **内存使用率**：内存占用百分比
   - **磁盘使用率**：各分区占用百分比
   - **网络流量**：上行/下行速度

### SSH终端使用

1. **建立SSH连接**
   - 在主机列表点击"连接"按钮
   - 首次连接需输入SSH凭证（用户名、密码）
   - 点击连接，打开Web终端

2. **终端操作**
   - 在浏览器终端中输入命令
   - 支持多会话同时打开
   - 支持终端复制粘贴

3. **保存凭证**
   - 首次连接后可保存凭证
   - 下次连接自动使用保存的凭证
   - 可在设置中修改已保存的凭证

---

## 端口说明

| 组件 | 端口 | 协议 |
|------|------|------|
| Server | 8080 | HTTP |
| Agent | 8081 | HTTP |
| MySQL | 3306 | TCP |
| Redis | 6379 | TCP |
| RabbitMQ | 5672 | TCP |
| RabbitMQ管理界面 | 15672 | HTTP |
| Web前端(开发) | 5173 | HTTP |

---

## 常见问题

### Agent注册失败

**问题**：Agent启动后无法注册到服务端

**排查步骤**：
1. 检查 `agent-config.yaml` 中的服务端地址是否正确
2. 确认服务端已启动（访问 http://server:8080/api/health）
3. 检查网络连通性
4. 查看Agent日志

### SSH连接失败

**问题**：点击连接后无法打开终端

**排查步骤**：
1. 确认目标主机SSH服务已启动
2. 检查SSH端口是否正确（默认22）
3. 验证用户名密码是否正确
4. 查看服务端日志

### 数据上报失败

**问题**：主机显示离线

**排查步骤**：
1. 检查Agent进程是否运行
2. 查看Agent日志中的上报记录
3. 确认服务端存储正常
4. 检查数据库连接

---

## 日志位置

| 组件 | 日志位置 |
|------|----------|
| Server | 控制台输出 / logs/server.log |
| Agent | 控制台输出 / logs/agent.log |
| Web | 浏览器开发者工具Console |
