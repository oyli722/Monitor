# 开发文档

## 1. 开发指南概述

本文档面向开发者，介绍 Monitor 项目的系统架构、核心模块、开发流程，帮助开发者快速上手项目开发。

**文档版本**：v3.2.0
**更新日期**：2026-02-08
**更新内容**：新增ZooKeeper服务发现架构

---

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         Browser Frontend                         │
│                     (Vue 3 + TypeScript)                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  request.ts (Server:8080)     ai-request.ts (AI:8081)    │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │                    │
                         ▼                    ▼
┌─────────────────────────────────────────────────────────────────┐
│              Monitor-Server:8080      Monitor-AI:8081          │
│  ┌──────────────┐  ┌──────────────┐   ┌──────────────────────┐ │
│  │   Agent API  │  │  Auth API    │   │  ChatController      │ │
│  │              │  │              │   │  (Sidebar AI)        │ │
│  └──────────────┘  └──────────────┘   └──────────────────────┘ │
│  ┌──────────────┐  ┌──────────────┐   ┌──────────────────────┐ │
│  │ SSH WebSocket│  │AgentApiController│ ChatService          │ │
│  │              │  │(for AI Service)│                       │ │
│  └──────────────┘  └──────────────┘   └──────────────────────┘ │
│  ┌──────────────┐  ┌──────────────┐   ┌──────────────────────┐ │
│  │Monitor API   │  │Spring Security│  AgentClient (Feign)    │ │
│  │              │  │   + JWT      │   │      │               │ │
│  └──────────────┘  └──────────────┘   └──────┼───────────────┘ │
│  ┌──────────────────────────────────────────────┐               │ │
│  │         MySQL + Redis + RabbitMQ             │◄──────────────┘ │
│  └──────────────────────────────────────────────┘                 │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTP Registration & Reporting
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Monitor-Agent:8081 (on each host)            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ Registration │  │ Data Report  │   │   Config Update     │  │
│  │   Service    │  │   Service    │   │      Service        │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         CollectService (OSHI - System Monitoring)         │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

**架构说明**：
- **Monitor-Server (8080)**：核心服务，包含Agent管理、SSH代理、认证授权等
- **Monitor-AI (8081)**：独立AI服务，提供侧边栏AI助手功能
- **Monitor-Agent (8081)**：部署在被监控主机的代理
- **CommonLibrary**：共享实体类和DTO，供Server和AI服务使用

### 2.2 目录结构

```
monitor-project/
├── CommonLibrary/           # 共享库
│   └── src/main/java/com/hundred/monitor/commonlibrary/
│       ├── request/         # 请求DTO
│       ├── response/        # 响应DTO
│       ├── model/           # 数据模型
│       │   └── ai/          # AI相关实体
│       │       ├── model/   # ChatMessage, ChatSessionInfo, SystemPrompt
│       │       ├── request/ # CreateSessionRequest, SendMessageRequest
│       │       └── response/# ChatResponse, SessionInfoResponse
│       └── common/          # BaseResponse等
│
├── Monitor-AI/             # AI服务模块 (端口8081)
│   └── src/main/java/com/hundred/monitor/ai/
│       ├── MonitorAiApplication.java
│       ├── config/
│       │   ├── AIModelConfig.java      # GLM-4.7、Ollama模型配置
│       │   ├── JwtConfig.java          # JWT认证配置
│       │   ├── RedisConfig.java        # Redis配置
│       │   └── FeignConfig.java        # Feign客户端配置
│       ├── controller/
│       │   └── ChatController.java     # 侧边栏AI聊天API (8个端点)
│       ├── service/
│       │   ├── ChatService.java        # 聊天服务逻辑
│       │   └── AgentClient.java        # Feign客户端（调用Server）
│       └── utils/
│           └── ChatSessionRedisUtils.java # Redis操作工具
│
├── Monitor-Agent/           # Agent模块
│   └── src/main/java/com/hundred/monitor/agent/
│       ├── BootstrapService.java      # 启动注册服务
│       ├── MonitorAgentApplication.java
│       ├── config/
│       │   ├── ConfigLoader.java     # YAML配置加载
│       │   ├── RestTemplateConfig.java
│       │   ├── DiscoveryProperties.java # 服务发现配置
│       │   └── ZookeeperConfig.java    # ZooKeeper客户端配置
│       ├── controller/
│       │   └── AgentController.java
│       ├── service/
│       │   ├── RegisterService.java  # 注册服务（集成服务发现）
│       │   ├── ReportService.java    # 数据上报（集成服务发现）
│       │   ├── ServiceDiscoveryService.java # ZooKeeper服务发现
│       │   ├── CollectService.java   # 系统信息采集
│       │   └── ConfigUpdateService.java
│       └── model/
│           ├── entity/
│           │   ├── AgentConfig.java
│           │   ├── BasicInfo.java
│           │   └── Metrics.java
│           ├── ServerEndpoint.java   # 服务端点实体
│           ├── request/
│           └── response/
│
├── Monitor-Server/          # Server模块 (端口8080)
│   └── src/main/java/com/hundred/monitor/server/
│       ├── MonitorServerApplication.java
│       ├── conf/
│       │   ├── SecurityConfig.java
│       │   ├── RabbitConfig.java
│       │   ├── ZookeeperProperties.java # ZooKeeper配置属性
│       │   └── ZookeeperConfig.java      # ZooKeeper客户端配置
│       ├── controller/
│       │   ├── AgentController.java      # Agent接口
│       │   ├── AgentApiController.java   # Agent API（供AI服务调用）
│       │   ├── MonitorController.java    # 监控数据接口
│       │   ├── SshController.java        # SSH接口
│       │   ├── AuthController.java       # 认证接口
│       │   ├── AiSshAssistantController.java # SSH绑定AI
│       │   └── HealthController.java     # 健康检查
│       ├── service/
│       │   ├── AgentService.java
│       │   ├── AgentMetricsService.java
│       │   ├── SshService.java
│       │   ├── AuthService.java
│       │   ├── MonitorService.java
│       │   ├── AiSshAssistantService.java # SSH绑定AI服务
│       │   └── ServerRegistrationService.java # ZooKeeper服务注册
│       ├── ai/                          # SSH绑定AI模块
│       │   ├── command/                 # 命令执行与分析
│       │   │   ├── CommandContext.java
│       │   │   ├── CommandContextManager.java
│       │   │   └── CommandTimeoutScheduler.java
│       │   ├── context/                 # ThreadLocal上下文
│       │   │   └── SshSessionContext.java
│       │   ├── entity/                  # AI实体
│       │   │   ├── Assistant.java
│       │   │   └── SshAssistantMessage.java
│       │   ├── tools/                   # SSH工具
│       │   │   └── SshExecuteTool.java
│       │   └── utils/                   # Redis工具
│       │       └── TerminalChatRedisUtils.java
│       ├── websocket/
│       │   ├── SshWebSocketHandler.java   # SSH WebSocket处理
│       │   ├── SshSessionManager.java     # SSH会话管理
│       │   └── ai/                       # AI WebSocket
│       │       ├── handler/AiSshAssistantHandler.java
│       │       └── manager/AiSshAssistantManager.java
│       ├── security/
│       │   ├── JwtAuthenticationFilter.java
│       │   ├── JwtTokenProvider.java
│       │   └── handler/
│       ├── mapper/              # MyBatis Mapper
│       ├── model/
│       │   ├── ServerMetadata.java    # Server元数据（ZooKeeper注册）
│       │   ├── entity/
│       │   ├── request/
│       │   └── response/
│       ├── conf/
│       │   ├── SecurityConfig.java
│       │   └── RabbitConfig.java
│       ├── listener/
│       │   └── MailQueueListener.java
│       └── utils/
│           └── FlowUtils.java
│
└── Monitor-Web/             # 前端模块
    └── src/
        ├── main.ts
        ├── App.vue
        ├── api/             # API调用
        │   └── ai.ts        # AI接口（ChatSessionAPI, AIAssistantAPI）
        ├── components/      # 组件
        │   └── ai/          # AI组件
        │       ├── ChatInterface.vue
        │       ├── ChatMessage.vue
        │       ├── ChatInput.vue
        │       ├── MarkdownRenderer.vue
        │       ├── AiAssistantDialog.vue  # SSH绑定AI
        │       └── SidebarAssistant.vue   # 侧边栏AI
        ├── views/           # 页面视图
        ├── router/          # 路由配置
        ├── stores/          # Pinia状态管理
        ├── types/           # TypeScript类型
        │   └── ai.ts        # AI类型定义
        ├── utils/           # 工具函数
        │   ├── request.ts   # Server请求
        │   └── ai-request.ts # AI服务请求
        └── composables/     # Vue组合式函数
            └── useAiChat.ts # AI聊天状态管理
```

---

## 3. 核心模块说明

### 3.1 Agent 模块

#### BootstrapService
- **位置**：`Monitor-Agent/src/main/java/com/hundred/monitor/agent/BootstrapService.java`
- **职责**：Agent启动时执行注册流程
- **核心逻辑**：
  1. 检查本地配置文件是否有 `agent_id`
  2. 未注册则调用 RegisterService 注册
  3. 注册成功后保存凭证到本地

#### RegisterService
- **位置**：`Monitor-Agent/src/main/java/com/hundred/monitor/agent/service/RegisterService.java`
- **职责**：处理Agent注册逻辑
- **核心逻辑**：
  1. 健康检查选择最快的服务器
  2. 发送注册请求
  3. 保存返回的 `agent_id`、`agent_name`、`auth_token`

#### ReportService
- **位置**：`Monitor-Agent/src/main/java/com/hundred/monitor/agent/service/ReportService.java`
- **职责**：定时数据上报
- **核心逻辑**：
  - 基本数据上报：每10分钟 (`@Scheduled(fixedRate = 600000)`)
  - 运行时数据上报：每15秒 (`@Scheduled(fixedRate = 15000)`)

#### CollectService
- **位置**：`Monitor-Agent/src/main/java/com/hundred/monitor/agent/service/CollectService.java`
- **职责**：使用OSHI采集系统信息
- **核心方法**：
  - `collectBasicInfo()`: 采集CPU、内存、磁盘等静态信息
  - `collectMetrics()`: 采集CPU使用率、内存使用率、网络流量等动态信息

---

### 3.2 Monitor-AI 模块

**模块职责**：独立的AI助手服务，提供侧边栏AI聊天功能。

#### Controller 层

| Controller | 基础路径 | 职责 |
|------------|----------|------|
| `ChatController` | `/api/chat` | 侧边栏AI聊天API |

#### Service 层

| Service | 职责 |
|---------|------|
| `ChatService` | 聊天服务逻辑、会话管理、消息处理 |

#### Feign 客户端

| Client | 用途 |
|--------|------|
| `AgentClient` | 调用Monitor-Server的Agent API |

#### 核心配置

| 配置类 | 说明 |
|--------|------|
| `AIModelConfig` | GLM-4.7和Ollama双模型配置 |
| `JwtConfig` | JWT认证配置 |
| `RedisConfig` | Redis配置 |
| `FeignConfig` | Feign客户端配置 |
| `CorsConfig` | CORS跨域配置 |

**CORS配置说明**：
- 允许的源：`http://localhost:5173`, `http://127.0.0.1:5173`, `http://localhost:8080`
- 允许的方法：GET, POST, PUT, DELETE, OPTIONS, PATCH
- 允许携带凭证（`AllowCredentials: true`）
- 预检请求有效期：3600秒

---

### 3.3 Server 模块

#### Controller 层

| Controller | 基础路径 | 职责 |
|------------|----------|------|
| `AgentController` | `/api/v1` | Agent注册、数据上报接收 |
| `AgentApiController` | `/api/v1/agent` | Agent信息API（供AI服务调用） |
| `AuthController` | `/api/auth` | 用户认证、注册、Token管理 |
| `MonitorController` | `/api/monitor` | 监控数据查询 |
| `SshController` | `/api/v1/ssh` | SSH连接管理 |
| `AiSshAssistantController` | `/api/ai/ssh-assistant` | SSH绑定AI助手 |
| `HealthController` | `/api` | 健康检查 |

#### Service 层

| Service | 职责 |
|---------|------|
| `AgentService` | Agent管理、注册处理 |
| `AgentMetricsService` | 指标数据存储、历史查询 |
| `MonitorService` | 监控数据聚合、图表数据 |
| `SshService` | SSH连接建立、凭证管理 |
| `AuthService` | 用户认证、Token生成 |
| `AiSshAssistantService` | SSH绑定AI助手服务 |

#### WebSocket 处理

##### SshWebSocketHandler
- **位置**：`Monitor-Server/src/main/java/com/hundred/monitor/server/websocket/SshWebSocketHandler.java`
- **职责**：处理SSH WebSocket连接
- **核心逻辑**：
  1. 建立 WebSocket 连接
  2. 从 SshSessionManager 获取对应的 SSH 会话
  3. 双向转发数据：WebSocket ↔ SSH

##### SshSessionManager
- **位置**：`Monitor-Server/src/main/java/com/hundred/monitor/server/websocket/SshSessionManager.java`
- **职责**：管理活跃的SSH会话
- **核心方法**：
  - `createSession()`: 使用JSch创建SSH连接
  - `getSession()`: 获取指定sessionId的会话
  - `removeSession()`: 移除会话

---

### 3.3 认证授权

#### JwtTokenProvider
- **位置**：`Monitor-Server/src/main/java/com/hundred/monitor/server/security/JwtTokenProvider.java`
- **职责**：JWT Token生成和验证
- **核心方法**：
  - `generateToken()`: 生成访问Token
  - `generateRefreshToken()`: 生成刷新Token
  - `validateToken()`: 验证Token有效性

#### JwtAuthenticationFilter
- **位置**：`Monitor-Server/src/main/java/com/hundred/monitor/server/security/JwtAuthenticationFilter.java`
- **职责**：拦截请求，验证JWT Token
- **核心逻辑**：
  1. 从请求头提取Token
  2. 验证Token有效性
  3. 设置Spring Security认证信息

---

## 4. 核心流程说明

### 4.1 Server注册到ZooKeeper流程

```
┌─────────┐                    ┌─────────────┐
│  Server  │                    │  ZooKeeper   │
└────┬────┘                    └──────┬──────┘
     │                              │
     │  1. 启动，ApplicationRunner执行 │
     │                              │
     │  2. 确保路径 /monitor/servers │
     ├────────────────────────────► │
     │                              │
     │  3. 生成serverId             │
     │     Monitor-Server-8080      │
     │                              │
     │  4. 创建临时节点             │
     ├────────────────────────────► │
     │  /monitor/servers/server-id  │
     │                              │
     │  5. 写入元数据到info子节点    │
     ├────────────────────────────► │
     │  {id, host, port, status}    │
     │                              │
     │  6. 注册成功，开始服务        │
     │                              │
     │  Session保持 → 节点存在       │
     │  Session超时 → 节点自动删除   │
```

### 4.2 Agent服务发现流程

```
┌─────────┐                    ┌─────────────┐
│  Agent   │                    │  ZooKeeper   │
└────┬────┘                    └──────┬──────┘
     │                              │
     │  1. 启动，@PostConstruct执行  │
     │                              │
     │  2. 获取子节点列表            │
     ├────────────────────────────► │
     │  /monitor/servers            │
     │  ◄────────────────────────── │
     │  [server-8080, server-8081]  │
     │                              │
     │  3. 解析每个server的info节点  │
     ├────────────────────────────► │
     │  ◄────────────────────────── │
     │  ServerEndpoint对象列表       │
     │                              │
     │  4. 缓存到内存                │
     │  AtomicReference<List>       │
     │                              │
     │  5. 每60秒自动刷新            │
     │  @Scheduled                  │
     │                              │
     │  如果ZooKeeper失败           │
     │  → 降级到静态配置            │
```

### 4.3 Agent 注册流程

```
┌─────────┐                    ┌─────────┐
│  Agent  │                    │ Server  │
└────┬────┘                    └────┬────┘
     │                              │
     │  1. 启动，检查本地配置        │
     ├──────────────────────────►  │
     │                              │
     │  未注册                       │
     │  2. 健康检查 /api/health      │
     ├──────────────────────────►  │
     │  3. 选择最快服务器            │
     │  ◄───────────────────────────┤
     │                              │
     │  4. POST /api/v1/customer/register
     │  {hostname, ip, basicInfo}   │
     ├──────────────────────────►  │
     │                              │  5. 生成agent_id
     │                              │  6. 保存到数据库
     │  7. {agentId, agentName, token}
     │  ◄───────────────────────────┤
     │                              │
     │  8. 保存到本地配置            │
     │  9. 开始定时上报              │
     │                              │
```

### 4.2 数据上报流程

```
┌─────────┐                    ┌─────────┐
│  Agent  │                    │ Server  │
└────┬────┘                    └────┬────┘
     │                              │
     │  每10分钟                     │
     │  POST /api/v1/agent/basic    │
     ├──────────────────────────►  │
     │  {basicInfo}                 │  保存到agent表
     │                              │
     │  每15秒                      │
     │  POST /api/v1/agent/metrics  │
     ├──────────────────────────►  │
     │  {metrics}                   │  保存到agent_metrics表
     │                              │
```

### 4.3 SSH 终端流程

```
┌──────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│ Web  │  │ Server  │  │ Server  │  │  Host   │
│      │  │ Controller│ │WebSocket│  │  SSH    │
└──┬───┘  └────┬────┘  └────┬────┘  └────┬────┘
   │           │            │            │
   │ 1. POST /api/v1/ssh/connect
   │   {agentId, username, password}
   ├──────────►            │            │
   │                       │            │
   │                       │ 2. JSch建立SSH连接
   │                       ├──────────────────►
   │                       │            │
   │ 3. {sessionId}        │ 4. 创建SshSession
   │ ◄───────────         │            │
   │                       │            │
   │ 5. WS /api/v1/ssh/terminal/{sessionId}
   ├──────────►            │            │
   │                       │            │
   │ 6. 输入 "ls -la"      │            │
   ├──────────►            │            │
   │                       │ 7. 转发到SSH
   │                       ├──────────────────►
   │                       │            │
   │                       │ 8. SSH返回结果
   │                       │ ◄─────────────────
   │                       │            │
   │ 9. 显示结果           │            │
   │ ◄───────────          │            │
```

### 4.4 用户认证流程

```
┌──────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│ Web  │  │Auth Ctrl│  │AuthService│ │  MySQL  │
└──┬───┘  └────┬────┘  └────┬────┘  └────┬────┘
   │           │            │            │
   │ 1. POST /api/auth/login
   │   {username, password}
   ├──────────►            │            │
   │                       │            │
   │                       │ 2. 查询用户
   │                       ├──────────────────►
   │                       │            │
   │                       │ 3. 验证密码
   │                       │ ◄─────────────────
   │                       │            │
   │                       │ 4. 生成JWT Token
   │ 5. {token, user}      │            │
   │ ◄───────────          │            │
   │                       │            │
   │ 6. 存储Token到localStorage
   │                       │            │
   │ 7. 后续请求带Token
   │ Authorization: Bearer {token}
```

---

## 5. 关键设计决策

### 5.1 为什么使用双频上报？

**问题**：如何平衡数据实时性和系统负载？

**方案**：
- **基本数据**（每10分钟）：硬件信息变化频率低，减少不必要的上报
- **运行时数据**（每15秒）：监控指标需要实时性，及时发现问题

### 5.2 为什么使用MySQL存储时序数据？

**问题**：为什么不使用InfluxDB等专业时序数据库？

**现状**：
- 依赖已引入 `influxdb-client-java:6.6.0`
- 但代码中完全未使用InfluxDB
- 所有数据存储在MySQL的 `agent_metrics` 表

**原因**：
- 项目初期使用MySQL更简单
- InfluxDB完整集成待实现

**TODO**：评估是否迁移到InfluxDB

### 5.3 为什么WebSocket代理SSH？

**问题**：为什么不直接让前端连接SSH？

**方案**：
- 浏览器无法直接建立SSH连接
- 通过WebSocket代理，实现浏览器到SSH的桥接
- 服务端作为中继，统一管理SSH连接

### 5.4 为什么Agent需要多服务器配置？

**问题**：为什么 `server.endpoints` 是列表？

**方案**：
- 支持多个服务端地址
- Agent启动时自动选择响应最快的服务器
- 实现负载均衡和高可用

---

## 6. 待办事项

### 6.1 已知问题

| 问题 | 位置 | 影响 |
|------|------|------|
| SSH密码明文存储 | `SshServiceImpl.java:175` | 安全隐患 |
| InfluxDB未使用 | - | 性能未优化 |
| 用户管理API缺失 | - | 前端页面无效 |

### 6.2 计划功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| SSH凭证加密 | 高 | 使用AES加密存储 |
| InfluxDB集成 | 中 | 时序数据存储优化 |
| 用户管理API | 低 | 用户CRUD、角色管理 |
| WebSocket心跳 | 低 | 连接保活机制 |
| 终端二进制消息 | 低 | 终端resize支持 |
| ZooKeeper Watcher | 中 | 替代定时拉取，实现实时更新 |
| 服务健康检查 | 低 | 主动探测Server健康状态 |
| 加权负载均衡 | 低 | 根据Server负载动态分配 |

### 6.3 ZooKeeper服务发现（✅ 已完成）

#### 6.3.1 实现背景

当前系统使用静态配置管理服务端地址，存在以下问题：
- Agent需要手动配置Server地址列表
- 无法动态发现新加入的Server
- 无故障转移机制
- Server下线时Agent无法自动切换

#### 6.3.2 解决方案

通过引入ZooKeeper实现服务注册与发现：
- **Server端**：启动时主动注册到ZooKeeper，使用临时节点实现健康检测
- **Agent端**：定时拉取服务列表（可配置，默认1分钟）
- **降级方案**：ZooKeeper失败时使用`agent-config.yaml`静态配置

#### 6.3.3 核心组件

| 组件 | 职责 |
|------|------|
| ServerRegistrationService | Server启动时自动注册到ZooKeeper |
| ServiceDiscoveryService | Agent定时拉取服务列表 |
| ServerEndpoint | 服务端点实体 |
| ZookeeperProperties/Config | ZooKeeper配置 |

#### 6.3.4 ZooKeeper节点结构

```
/monitor
└── servers
    ├── server-Monitor-Server-8080 (持久化节点)
    │   ├── info (元数据JSON - 持久化)
    │   └── status (健康状态 - 临时节点)
    └── server-Monitor-Server-8081 (持久化节点)
        ├── info (元数据JSON - 持久化)
        └── status (健康状态 - 临时节点)
```

**设计说明**：
- Server父节点和info元数据使用持久化节点（PERSISTENT）
- status状态节点使用临时节点（EPHEMERAL），Session超时自动删除
- Agent通过检查status节点是否存在来判断Server是否在线

#### 6.3.5 文件清单

**新增文件（8个）**：
- Monitor-Server: `ZookeeperProperties.java`, `ZookeeperConfig.java`, `ServerMetadata.java`, `ServerRegistrationService.java`
- Monitor-Agent: `DiscoveryProperties.java`, `ZookeeperConfig.java`, `ServerEndpoint.java`, `ServiceDiscoveryService.java`

**修改文件（7个）**：
- Monitor-Server: `application.yaml`, `MonitorServerApplication.java`
- Monitor-Agent: `application.yaml`, `MonitorAgentApplication.java`, `RegisterService.java`, `ReportService.java`
- 公共: `pom.xml`（添加Curator依赖）

详细实现记录请参考：`项目文档/ZooKeeper服务发现开发记录.md`

### 6.4 AI模块优化计划（✅ 已完成）

#### 6.4.1 优化背景

Monitor-AI模块已完成从非响应式到响应式的重构，但代码存在以下问题：
- 异常处理不统一
- 日志混乱（DEBUG日志残留）
- Controller直接暴露内部组件
- 错误响应硬编码
- JWT解析逻辑未完成

#### 6.4.2 优化清单

| 问题类型 | 具体表现 | 优化方案 | 状态 |
|---------|---------|---------|------|
| 异常处理不统一 | 混用`onErrorReturn`/`onErrorResume` | 统一异常处理器 + 自定义异常 | ✅ 完成 |
| 日志混乱 | 大量DEBUG日志残留 | 清理残留日志，规范化日志级别 | ✅ 完成 |
| 组件暴露 | Controller直接调用`getRedisUtils()` | 移除getter，通过Service封装 | ✅ 完成 |
| 硬编码 | 错误消息、魔法数字 | 常量类 + 国际化支持 | ✅ 完成 |
| JWT未完成 | `getUserIdFromAuth`中TODO | 完善JWT解析逻辑 | ✅ 完成 |
| **认证授权** | **无Security保护** | **Reactive Spring Security** | **✅ 完成** |

#### 6.4.3 优化结果

**已完成内容**：
```
Monitor-AI优化完成
├── 统一异常管理
│   ├── GlobalExceptionHandler全局异常处理器
│   ├── 自定义异常类（BaseException、BusinessException等）
│   └── 错误消息常量（ErrorConstants）
├── 代码清理
│   ├── 移除DEBUG日志
│   ├── 提取常量（ChatConstants）
│   └── 移除getter暴露
├── Reactive Security认证
│   ├── MonitorAISecurityConfig配置
│   ├── JWT解码器（ReactiveJwtDecoder）
│   ├── 认证转换器（ReactiveJwtAuthenticationConverter）
│   └── CORS处理
└── 前端修复
    └── SSE请求携带JWT Token
```

#### 6.4.4 Reactive Spring Security 实现

**新增 Security 包结构**：
```
Monitor-AI/src/main/java/com/hundred/monitor/ai/security/
├── MonitorAISecurityConfig.java              主Security配置
├── ReactiveJwtAuthenticationConverter.java   JWT转Authentication转换器
├── ReactiveAuthenticationEntryPoint.java     401认证失败处理
└── ReactiveAccessDeniedHandler.java          403权限拒绝处理
```

**核心特性**：
- 使用对称密钥（HMAC-SHA256）验证 JWT 签名
- 与 Monitor-Server 共享 `jwt.secret` 配置
- 所有端点都需要认证（除 OPTIONS 预检请求）
- 独立的 CorsWebFilter 处理跨域

**依赖配置**：
```xml
<!-- OAuth2 Resource Server for JWT -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
</dependency>
```

#### 6.4.5 相关提交

```
[dev-2602 2105a60] 实现Monitor-AI的Reactive Spring Security JWT认证
[dev-2602 1e89103] 修复前端AI请求未发送JWT token的问题
[dev-2602 9145db4] 修复AI模型配置：使用流式ChatModel确保SSE正常工作
[dev-2602 723c2f1] 修复侧边栏AI助手流式输出问题：响应式流、SSE格式、前端显示
[dev-2602 dc0f6b2] 响应式，代码有部分缺陷，后续更改
```

详细记录请参考：`项目文档/AI模块优化方案.md`

### 6.5 响应式重构完成记录

#### 6.5.1 重构概述

Monitor-AI模块已完成从传统Spring MVC到Spring WebFlux的响应式重构，实现了非阻塞I/O和流式响应。

#### 6.5.2 技术栈变更

| 维度 | 重构前 | 重构后 |
|------|--------|--------|
| Web框架 | Spring Web MVC | Spring WebFlux |
| Redis访问 | Spring Data Redis | Spring Data Redis Reactive |
| 返回类型 | `T`, `List<T>` | `Mono<T>`, `Flux<T>` |
| 异步模型 | 阻塞I/O | 非阻塞I/O |
| 流式响应 | 同步返回 | SSE流式输出 |

#### 6.5.3 响应式特征

**Controller层**：
```java
// 单值响应
public Mono<BaseResponse<T>> method() { ... }

// 流式响应
public Flux<String> sendMessage(...) { ... }
```

**Service层**：
```java
// 响应式链式调用
public Flux<String> sendMessage(...) {
    return redisUtils.sessionExists(sessionId)
        .flatMapMany(exists -> ...)
        .flatMap(contextMessages -> callAI(...));
}
```

**Utils层**：
```java
// Reactive Redis操作
public Mono<List<ChatMessage>> getUserSessions(String userId) {
    return getUserSessionIds(userId)
        .flatMapMany(Flux::fromIterable)
        .flatMapSequential(this::getSessionInfo)
        .collectList();
}
```

#### 6.5.4 重构文件清单

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `pom.xml` | 依赖修改 | 添加`spring-boot-starter-webflux` |
| `ChatController.java` | 重构 | 返回类型改为`Mono`/`Flux` |
| `ChatService.java` | 重构 | 全面响应式链式调用 |
| `ChatSessionRedisReactiveUtils.java` | 新建 | 响应式Redis工具类 |
| `AIModelConfig.java` | 重构 | 使用`StreamingChatLanguageModel` |


