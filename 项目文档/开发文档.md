# 开发文档

## 1. 开发指南概述

本文档面向开发者，介绍 Monitor 项目的系统架构、核心模块、开发流程，帮助开发者快速上手项目开发。

**文档版本**：v1.0.0
**更新日期**：2026-02-02

---

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         Browser Frontend                         │
│                     (Vue 3 + TypeScript)                        │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTP/WebSocket
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Monitor-Server:8080                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   Agent API  │  │  Auth API    │  │     SSH WebSocket    │  │
│  │              │  │              │  │      Handler         │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │Monitor API   │  │Spring Security│  │   MySQL + Redis      │  │
│  │              │  │   + JWT      │  │   + RabbitMQ         │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTP Registration & Reporting
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Monitor-Agent:8081 (on each host)            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ Registration │  │ Data Report  │   │   Config Update     │  │
│  │   Service    │  │   Service    │   │      Service        │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         CollectService (OSHI - System Monitoring)         │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构

```
monitor-project/
├── CommonLibrary/           # 共享库
│   └── src/main/java/com/hundred/monitor/commonlibrary/
│       ├── request/         # 请求DTO
│       ├── response/        # 响应DTO
│       └── model/           # 数据模型
│
├── Monitor-Agent/           # Agent模块
│   └── src/main/java/com/hundred/monitor/agent/
│       ├── BootstrapService.java      # 启动注册服务
│       ├── MonitorAgentApplication.java
│       ├── config/
│       │   ├── ConfigLoader.java     # YAML配置加载
│       │   └── RestTemplateConfig.java
│       ├── controller/
│       │   └── AgentController.java
│       ├── service/
│       │   ├── RegisterService.java  # 注册服务
│       │   ├── ReportService.java    # 数据上报
│       │   ├── CollectService.java   # 系统信息采集
│       │   └── ConfigUpdateService.java
│       └── model/
│           ├── entity/
│           │   ├── AgentConfig.java
│           │   ├── BasicInfo.java
│           │   └── Metrics.java
│           ├── request/
│           └── response/
│
├── Monitor-Server/          # Server模块
│   └── src/main/java/com/hundred/monitor/server/
│       ├── MonitorServerApplication.java
│       ├── controller/
│       │   ├── AgentController.java      # Agent接口
│       │   ├── MonitorController.java    # 监控数据接口
│       │   ├── SshController.java        # SSH接口
│       │   ├── AuthController.java       # 认证接口
│       │   └── HealthController.java     # 健康检查
│       ├── service/
│       │   ├── AgentService.java
│       │   ├── AgentMetricsService.java
│       │   ├── SshService.java
│       │   ├── AuthService.java
│       │   └── MonitorService.java
│       ├── websocket/
│       │   ├── SshWebSocketHandler.java   # WebSocket处理
│       │   ├── SshSessionManager.java     # 会话管理
│       │   └── SshSession.java
│       ├── security/
│       │   ├── JwtAuthenticationFilter.java
│       │   ├── JwtTokenProvider.java
│       │   └── handler/
│       ├── mapper/              # MyBatis Mapper
│       ├── model/
│       │   ├── entity/
│       │   ├── request/
│       │   └── response/
│       ├── conf/
│       │   ├── SecurityConfig.java
│       │   └── RabbitConfig.java
│       ├── listener/
│       │   └── MailQueueListener.java
│       └── utils/
│           └── FlowUtils.java
│
└── Monitor-Web/             # 前端模块
    └── src/
        ├── main.ts
        ├── App.vue
        ├── api/             # API调用
        ├── components/      # 组件
        ├── views/           # 页面视图
        ├── router/          # 路由配置
        ├── stores/          # Pinia状态管理
        ├── types/           # TypeScript类型
        ├── utils/           # 工具函数
        └── composables/     # Vue组合式函数
```

---

## 3. 核心模块说明

### 3.1 Agent 模块

#### BootstrapService
- **位置**：`Monitor-Agent/src/main/java/com/hundred/monitor/agent/BootstrapService.java`
- **职责**：Agent启动时执行注册流程
- **核心逻辑**：
  1. 检查本地配置文件是否有 `agent_id`
  2. 未注册则调用 RegisterService 注册
  3. 注册成功后保存凭证到本地

#### RegisterService
- **位置**：`Monitor-Agent/src/main/java/com/hundred/monitor/agent/service/RegisterService.java`
- **职责**：处理Agent注册逻辑
- **核心逻辑**：
  1. 健康检查选择最快的服务器
  2. 发送注册请求
  3. 保存返回的 `agent_id`、`agent_name`、`auth_token`

#### ReportService
- **位置**：`Monitor-Agent/src/main/java/com/hundred/monitor/agent/service/ReportService.java`
- **职责**：定时数据上报
- **核心逻辑**：
  - 基本数据上报：每10分钟 (`@Scheduled(fixedRate = 600000)`)
  - 运行时数据上报：每15秒 (`@Scheduled(fixedRate = 15000)`)

#### CollectService
- **位置**：`Monitor-Agent/src/main/java/com/hundred/monitor/agent/service/CollectService.java`
- **职责**：使用OSHI采集系统信息
- **核心方法**：
  - `collectBasicInfo()`: 采集CPU、内存、磁盘等静态信息
  - `collectMetrics()`: 采集CPU使用率、内存使用率、网络流量等动态信息

---

### 3.2 Server 模块

#### Controller 层

| Controller | 基础路径 | 职责 |
|------------|----------|------|
| `AgentController` | `/api/v1` | Agent注册、数据上报接收 |
| `AuthController` | `/api/auth` | 用户认证、注册、Token管理 |
| `MonitorController` | `/api/monitor` | 监控数据查询 |
| `SshController` | `/api/v1/ssh` | SSH连接管理 |
| `HealthController` | `/api` | 健康检查 |

#### Service 层

| Service | 职责 |
|---------|------|
| `AgentService` | Agent管理、注册处理 |
| `AgentMetricsService` | 指标数据存储、历史查询 |
| `MonitorService` | 监控数据聚合、图表数据 |
| `SshService` | SSH连接建立、凭证管理 |
| `AuthService` | 用户认证、Token生成 |

#### WebSocket 处理

##### SshWebSocketHandler
- **位置**：`Monitor-Server/src/main/java/com/hundred/monitor/server/websocket/SshWebSocketHandler.java`
- **职责**：处理SSH WebSocket连接
- **核心逻辑**：
  1. 建立 WebSocket 连接
  2. 从 SshSessionManager 获取对应的 SSH 会话
  3. 双向转发数据：WebSocket ↔ SSH

##### SshSessionManager
- **位置**：`Monitor-Server/src/main/java/com/hundred/monitor/server/websocket/SshSessionManager.java`
- **职责**：管理活跃的SSH会话
- **核心方法**：
  - `createSession()`: 使用JSch创建SSH连接
  - `getSession()`: 获取指定sessionId的会话
  - `removeSession()`: 移除会话

---

### 3.3 认证授权

#### JwtTokenProvider
- **位置**：`Monitor-Server/src/main/java/com/hundred/monitor/server/security/JwtTokenProvider.java`
- **职责**：JWT Token生成和验证
- **核心方法**：
  - `generateToken()`: 生成访问Token
  - `generateRefreshToken()`: 生成刷新Token
  - `validateToken()`: 验证Token有效性

#### JwtAuthenticationFilter
- **位置**：`Monitor-Server/src/main/java/com/hundred/monitor/server/security/JwtAuthenticationFilter.java`
- **职责**：拦截请求，验证JWT Token
- **核心逻辑**：
  1. 从请求头提取Token
  2. 验证Token有效性
  3. 设置Spring Security认证信息

---

## 4. 核心流程说明

### 4.1 Agent 注册流程

```
┌─────────┐                    ┌─────────┐
│  Agent  │                    │ Server  │
└────┬────┘                    └────┬────┘
     │                              │
     │  1. 启动，检查本地配置        │
     ├──────────────────────────►  │
     │                              │
     │  未注册                       │
     │  2. 健康检查 /api/health      │
     ├──────────────────────────►  │
     │  3. 选择最快服务器            │
     │  ◄───────────────────────────┤
     │                              │
     │  4. POST /api/v1/customer/register
     │  {hostname, ip, basicInfo}   │
     ├──────────────────────────►  │
     │                              │  5. 生成agent_id
     │                              │  6. 保存到数据库
     │  7. {agentId, agentName, token}
     │  ◄───────────────────────────┤
     │                              │
     │  8. 保存到本地配置            │
     │  9. 开始定时上报              │
     │                              │
```

### 4.2 数据上报流程

```
┌─────────┐                    ┌─────────┐
│  Agent  │                    │ Server  │
└────┬────┘                    └────┬────┘
     │                              │
     │  每10分钟                     │
     │  POST /api/v1/agent/basic    │
     ├──────────────────────────►  │
     │  {basicInfo}                 │  保存到agent表
     │                              │
     │  每15秒                      │
     │  POST /api/v1/agent/metrics  │
     ├──────────────────────────►  │
     │  {metrics}                   │  保存到agent_metrics表
     │                              │
```

### 4.3 SSH 终端流程

```
┌──────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│ Web  │  │ Server  │  │ Server  │  │  Host   │
│      │  │ Controller│ │WebSocket│  │  SSH    │
└──┬───┘  └────┬────┘  └────┬────┘  └────┬────┘
   │           │            │            │
   │ 1. POST /api/v1/ssh/connect
   │   {agentId, username, password}
   ├──────────►            │            │
   │                       │            │
   │                       │ 2. JSch建立SSH连接
   │                       ├──────────────────►
   │                       │            │
   │ 3. {sessionId}        │ 4. 创建SshSession
   │ ◄───────────         │            │
   │                       │            │
   │ 5. WS /api/v1/ssh/terminal/{sessionId}
   ├──────────►            │            │
   │                       │            │
   │ 6. 输入 "ls -la"      │            │
   ├──────────►            │            │
   │                       │ 7. 转发到SSH
   │                       ├──────────────────►
   │                       │            │
   │                       │ 8. SSH返回结果
   │                       │ ◄─────────────────
   │                       │            │
   │ 9. 显示结果           │            │
   │ ◄───────────          │            │
```

### 4.4 用户认证流程

```
┌──────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│ Web  │  │Auth Ctrl│  │AuthService│ │  MySQL  │
└──┬───┘  └────┬────┘  └────┬────┘  └────┬────┘
   │           │            │            │
   │ 1. POST /api/auth/login
   │   {username, password}
   ├──────────►            │            │
   │                       │            │
   │                       │ 2. 查询用户
   │                       ├──────────────────►
   │                       │            │
   │                       │ 3. 验证密码
   │                       │ ◄─────────────────
   │                       │            │
   │                       │ 4. 生成JWT Token
   │ 5. {token, user}      │            │
   │ ◄───────────          │            │
   │                       │            │
   │ 6. 存储Token到localStorage
   │                       │            │
   │ 7. 后续请求带Token
   │ Authorization: Bearer {token}
```

---

## 5. 关键设计决策

### 5.1 为什么使用双频上报？

**问题**：如何平衡数据实时性和系统负载？

**方案**：
- **基本数据**（每10分钟）：硬件信息变化频率低，减少不必要的上报
- **运行时数据**（每15秒）：监控指标需要实时性，及时发现问题

### 5.2 为什么使用MySQL存储时序数据？

**问题**：为什么不使用InfluxDB等专业时序数据库？

**现状**：
- 依赖已引入 `influxdb-client-java:6.6.0`
- 但代码中完全未使用InfluxDB
- 所有数据存储在MySQL的 `agent_metrics` 表

**原因**：
- 项目初期使用MySQL更简单
- InfluxDB完整集成待实现

**TODO**：评估是否迁移到InfluxDB

### 5.3 为什么WebSocket代理SSH？

**问题**：为什么不直接让前端连接SSH？

**方案**：
- 浏览器无法直接建立SSH连接
- 通过WebSocket代理，实现浏览器到SSH的桥接
- 服务端作为中继，统一管理SSH连接

### 5.4 为什么Agent需要多服务器配置？

**问题**：为什么 `server.endpoints` 是列表？

**方案**：
- 支持多个服务端地址
- Agent启动时自动选择响应最快的服务器
- 实现负载均衡和高可用

---

## 6. 待办事项

### 6.1 已知问题

| 问题 | 位置 | 影响 |
|------|------|------|
| SSH密码明文存储 | `SshServiceImpl.java:175` | 安全隐患 |
| InfluxDB未使用 | - | 性能未优化 |
| AI助手后端缺失 | `/src/main/java/../aitools/` | 前端无法使用 |
| 用户管理API缺失 | - | 前端页面无效 |

### 6.2 计划功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| SSH凭证加密 | 高 | 使用AES加密存储 |
| InfluxDB集成 | 中 | 时序数据存储优化 |
| AI助手后端 | 中 | 实现聊天、指令执行接口 |
| 用户管理API | 低 | 用户CRUD、角色管理 |
| WebSocket心跳 | 低 | 连接保活机制 |
| 终端二进制消息 | 低 | 终端resize支持 |
